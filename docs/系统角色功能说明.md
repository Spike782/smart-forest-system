# 智能森林系统角色功能说明

## 概述

智能森林系统实现了完整的角色-based访问控制(RBAC)系统，用户注册时必须选择身份角色，每个角色拥有不同的权限和业务功能。

## 系统角色定义

### 2.2.1 系统管理员 (SYSTEM_ADMIN)
**核心职责：**
- 维护所有角色的账号信息与权限分配
- 管理设备档案与预警规则
- 审核统计报表模板

**权限范围：**
- 所有系统功能的管理权限
- 用户账户和角色管理
- 系统配置和维护

### 2.2.2 数据管理员 (DATA_ADMIN)
**核心职责：**
- 录入、校验林草资源基础信息
- 处理监测数据的异常情况
- 生成并发布统计报表

**权限范围：**
- 查看和管理资源信息
- 查看和管理传感器数据
- 查看和管理统计报表
- 查看预警信息（只读）
- 查看设备信息（只读）

### 2.2.3 区域护林员 (FOREST_GUARD)
**核心职责：**
- 查看负责区域的实时监测数据与历史记录
- 接收并处理相关灾害预警
- 记录设备巡检与维护情况
- 更新区域内林草资源变动信息

**权限范围：**
- 查看区域、传感器、预警信息
- 管理资源变更记录
- 查看和管理设备维护记录
- 查看设备状态信息

### 2.2.4 公众用户 (PUBLIC_USER)
**核心职责：**
- 查看公开的林草资源统计数据
- 浏览非涉密的环境监测信息（如景区空气质量）
- 提交林草资源异常情况反馈（如发现火情、病虫害）

**权限范围：**
- 查看公开的资源统计信息
- 查看公开的环境监测数据
- 查看公开的统计报表
- 基本的系统浏览权限

### 2.2.5 监管人员 (INSPECTOR)
**核心职责：**
- 查看全系统业务数据与操作记录
- 监督预警处理流程的及时性与规范性
- 审核资源变动与设备维护记录的真实性

**权限范围：**
- 查看所有业务数据
- 查看预警处理流程
- 查看资源和设备维护记录
- 审核相关记录的权限

## 技术实现

### 数据库设计

#### 角色表 (roles)
```sql
CREATE TABLE roles (
    role_id         BIGINT AUTO_INCREMENT PRIMARY KEY,
    role_name       VARCHAR(50) NOT NULL UNIQUE,
    description     VARCHAR(255),
    created_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_role_name (role_name)
);
```

#### 用户角色关联表 (user_roles)
```sql
CREATE TABLE user_roles (
    user_id         BIGINT NOT NULL,
    role_id         BIGINT NOT NULL,
    created_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, role_id),
    CONSTRAINT fk_user_role_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_user_role_role FOREIGN KEY (role_id) REFERENCES roles(role_id) ON DELETE CASCADE
);
```

#### 权限表 (permissions)
```sql
CREATE TABLE permissions (
    permission_id   BIGINT AUTO_INCREMENT PRIMARY KEY,
    permission_name VARCHAR(50) NOT NULL UNIQUE,
    resource        VARCHAR(50) NOT NULL,
    action          VARCHAR(20) NOT NULL,
    description     VARCHAR(255),
    created_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_permission_name (permission_name),
    UNIQUE KEY uk_resource_action (resource, action)
);
```

#### 角色权限关联表 (role_permissions)
```sql
CREATE TABLE role_permissions (
    role_id         BIGINT NOT NULL,
    permission_id   BIGINT NOT NULL,
    created_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (role_id, permission_id),
    CONSTRAINT fk_role_permission_role FOREIGN KEY (role_id) REFERENCES roles(role_id) ON DELETE CASCADE,
    CONSTRAINT fk_role_permission_permission FOREIGN KEY (permission_id) REFERENCES permissions(permission_id) ON DELETE CASCADE
);
```

### API接口

#### 用户注册
```http
POST /register
Content-Type: application/json

{
    "username": "string",
    "password": "string",
    "email": "string",
    "real_name": "string",
    "role_id": number  // 必需，选择角色
}
```

#### 获取可用角色
```http
GET /roles
```

响应：
```json
{
    "roles": [
        {
            "id": 1,
            "role_name": "SYSTEM_ADMIN",
            "description": "系统管理员：维护所有角色的账号信息与权限分配...",
            "created_at": "2024-01-01T00:00:00Z",
            "updated_at": "2024-01-01T00:00:00Z"
        }
    ],
    "count": 5
}
```

### 权限检查中间件

系统使用中间件进行权限检查：

```go
func CheckPermissionMiddleware(db *sql.DB, resource string, action string) gin.HandlerFunc
```

使用示例：
```go
// 需要资源查看权限
api.GET("/resources", CheckPermissionMiddleware(db, "resources", "view"), handler.GetResources)

// 需要资源管理权限
api.POST("/resources", CheckPermissionMiddleware(db, "resources", "manage"), handler.CreateResource)
```

### 前端实现

#### 注册表单
注册表单包含角色选择下拉框，动态加载可用角色：

```html
<select name="role_id" id="role-select" required>
    <option value="">请选择身份</option>
    <!-- 动态填充角色选项 -->
</select>
```

#### 角色加载函数
```javascript
async function loadRolesForRegistration() {
    try {
        const response = await fetch('/roles');
        const data = await response.json();

        const roleSelect = document.getElementById('role-select');
        data.roles.forEach(role => {
            const option = document.createElement('option');
            option.value = role.id;
            option.textContent = `${role.role_name} - ${role.description}`;
            roleSelect.appendChild(option);
        });
    } catch (error) {
        console.error('加载角色列表失败:', error);
    }
}
```

## 权限矩阵

| 功能模块 | 系统管理员 | 数据管理员 | 区域护林员 | 公众用户 | 监管人员 |
|---------|-----------|-----------|-----------|---------|---------|
| 用户管理 | 管理 |  |  |  |  |
| 角色管理 | 管理 |  |  |  |  |
| 区域信息 | 管理 | 查看 | 查看 | 查看 | 查看 |
| 传感器数据 | 管理 | 查看 | 查看 | 查看 | 查看 |
| 预警信息 | 管理 | 查看 | 查看/处理 |  | 查看/审核 |
| 资源信息 | 管理 | 管理 | 查看/变更 | 查看 | 查看/审核 |
| 设备信息 | 管理 | 查看 | 查看/维护 |  | 查看/审核 |
| 统计报表 | 审核 | 管理 |  | 查看 | 查看 |

## 测试验证

系统包含完整的角色功能测试：

`/backend/test/role_system_test.go`
