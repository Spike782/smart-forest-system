智慧林草系统 - 环境监测和统计分析模块文档

1. 模块概述

1.1 模块简介
环境监测和统计分析模块是智慧林草系统的核心组成部分，负责采集、存储和分析各种环境数据，为森林和草原资源的保护和管理提供科学依据。该模块支持实时数据监测、历史数据查询、统计分析、报表生成和异常预警等功能。

1.2 模块功能
 环境数据采集与存储
 实时数据监测
 历史数据查询
 多维度统计分析
 自动报表生成
 异常数据检测与预警
 数据可视化展示
 基于角色的权限控制

1.3 技术栈
 数据库：MySQL 8.0
 开发语言：Python 3.8+, SQL
 后端框架：Flask 2.0+
 数据可视化：支持与前端可视化工具集成
 权限管理：基于角色的访问控制
 API接口：RESTful API

2. 需求分析

2.1 核心实体

| 实体名称 | 描述 | 核心属性 |
|---------|------|---------|
| 环境监测站 | 用于采集环境数据的监测站点 | 站点ID、站点名称、地理位置、海拔高度、站点类型、安装日期、状态 |
| 环境数据采集 | 从监测站采集的原始环境数据 | 数据ID、站点ID、采集时间、温度、湿度、风速、风向、降雨量、日照时长、土壤温度、土壤湿度、土壤pH值、PM2.5、PM10 |
| 统计分析数据 | 对原始环境数据进行统计分析后的结果 | 统计ID、站点ID、统计时间段、统计类型、统计日期、平均温度、最高温度、最低温度、平均湿度、总降雨量、平均风速、数据来源 |
| 报表模板 | 用于生成报表的模板 | 模板ID、模板名称、报表类型、模板内容、创建时间、更新时间 |
| 生成的报表 | 根据模板生成的实际报表 | 报表ID、模板ID、生成时间、报表名称、报表内容、生成人 |
| 异常数据记录 | 记录监测到的异常环境数据 | 异常ID、数据ID、异常类型、异常描述、发现时间、处理状态、处理时间、处理人 |
| 系统用户 | 系统的用户，用于权限控制 | 用户ID、用户名、密码、角色、邮箱、电话、状态、创建时间、更新时间 |
| 操作日志 | 记录系统用户的操作 | 日志ID、用户ID、操作类型、操作内容、操作时间、IP地址 |

2.2 业务流程

2.2.1 数据采集流程
1. 监测站定期采集环境数据
2. 数据传输到系统数据库
3. 系统对数据进行验证和存储
4. 系统自动生成异常数据记录（如有）
5. 系统自动更新统计分析数据

2.2.2 统计分析流程
1. 系统定期对原始数据进行统计分析
2. 生成统计分析结果并存储
3. 支持手动触发统计分析
4. 统计结果用于生成报表

2.2.3 报表生成流程
1. 用户选择报表模板
2. 系统根据模板查询相关数据
3. 生成报表并存储
4. 用户查看或下载报表

2.3 功能需求

| 功能模块 | 功能描述 |
|---------|---------|
| 数据采集与存储 | 支持自动采集和手动录入环境数据，数据验证和清洗，数据备份和恢复 |
| 统计分析 | 支持按日、周、月、季、年进行统计，支持多维度统计分析，支持自定义统计指标 |
| 报表生成 | 支持多种报表模板，支持自定义报表，支持报表导出（PDF、Excel等格式），支持报表定时生成和发送 |
| 异常监测与预警 | 自动监测异常数据，支持多种预警方式（短信、邮件等），异常数据处理流程管理 |
| 数据查询与可视化 | 支持多条件数据查询，支持实时数据查看，支持历史数据查询，支持数据可视化展示（图表、地图等） |

3. 数据库设计

3.1 数据库表结构

3.1.1 环境监测站表（monitoring_station）
```sql
CREATE TABLE IF NOT EXISTS monitoring_station (
    station_id INT PRIMARY KEY AUTO_INCREMENT COMMENT '站点ID',
    station_name VARCHAR(100) NOT NULL COMMENT '站点名称',
    latitude DECIMAL(10, 6) NOT NULL COMMENT '纬度',
    longitude DECIMAL(10, 6) NOT NULL COMMENT '经度',
    altitude DECIMAL(8, 2) COMMENT '海拔高度',
    station_type VARCHAR(50) NOT NULL COMMENT '站点类型',
    installation_date DATE NOT NULL COMMENT '安装日期',
    status VARCHAR(20) DEFAULT '正常' COMMENT '状态（正常、故障、维护）',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_station_name (station_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='环境监测站表';
```

#### 3.1.2 环境数据采集表（environmental_data）
```sql
CREATE TABLE IF NOT EXISTS environmental_data (
    data_id INT PRIMARY KEY AUTO_INCREMENT COMMENT '数据ID',
    station_id INT NOT NULL COMMENT '站点ID',
    collection_time DATETIME NOT NULL COMMENT '采集时间',
    temperature DECIMAL(5, 2) COMMENT '温度（℃）',
    humidity DECIMAL(5, 2) COMMENT '湿度（%）',
    wind_speed DECIMAL(5, 2) COMMENT '风速（m/s）',
    wind_direction VARCHAR(10) COMMENT '风向',
    rainfall DECIMAL(8, 2) DEFAULT 0 COMMENT '降雨量（mm）',
    sunshine_duration DECIMAL(5, 2) DEFAULT 0 COMMENT '日照时长（小时）',
    soil_temperature DECIMAL(5, 2) COMMENT '土壤温度（℃）',
    soil_humidity DECIMAL(5, 2) COMMENT '土壤湿度（%）',
    soil_ph DECIMAL(4, 2) COMMENT '土壤pH值',
    pm25 DECIMAL(6, 2) COMMENT 'PM2.5（μg/m³）',
    pm10 DECIMAL(6, 2) COMMENT 'PM10（μg/m³）',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    FOREIGN KEY (station_id) REFERENCES monitoring_station(station_id) ON DELETE CASCADE ON UPDATE CASCADE,
    INDEX idx_station_time (station_id, collection_time),
    INDEX idx_collection_time (collection_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='环境数据采集表';
```

#### 3.1.3 统计分析数据表（statistical_data）
```sql
CREATE TABLE IF NOT EXISTS statistical_data (
    stat_id INT PRIMARY KEY AUTO_INCREMENT COMMENT '统计ID',
    station_id INT NOT NULL COMMENT '站点ID',
    stat_period VARCHAR(20) NOT NULL COMMENT '统计时间段（日、周、月、季、年）',
    stat_type VARCHAR(50) NOT NULL COMMENT '统计类型',
    stat_date DATE NOT NULL COMMENT '统计日期',
    avg_temperature DECIMAL(5, 2) COMMENT '平均温度（℃）',
    max_temperature DECIMAL(5, 2) COMMENT '最高温度（℃）',
    min_temperature DECIMAL(5, 2) COMMENT '最低温度（℃）',
    avg_humidity DECIMAL(5, 2) COMMENT '平均湿度（%）',
    total_rainfall DECIMAL(8, 2) DEFAULT 0 COMMENT '总降雨量（mm）',
    avg_wind_speed DECIMAL(5, 2) COMMENT '平均风速（m/s）',
    data_source VARCHAR(50) NOT NULL COMMENT '数据来源',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (station_id) REFERENCES monitoring_station(station_id) ON DELETE CASCADE ON UPDATE CASCADE,
    INDEX idx_station_period (station_id, stat_period),
    INDEX idx_stat_date (stat_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='统计分析数据表';
```

#### 3.1.4 报表模板表（report_template）
```sql
CREATE TABLE IF NOT EXISTS report_template (
    template_id INT PRIMARY KEY AUTO_INCREMENT COMMENT '模板ID',
    template_name VARCHAR(100) NOT NULL COMMENT '模板名称',
    report_type VARCHAR(50) NOT NULL COMMENT '报表类型',
    template_content TEXT NOT NULL COMMENT '模板内容',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_template_name (template_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='报表模板表';
```

#### 3.1.5 生成的报表表（generated_report）
```sql
CREATE TABLE IF NOT EXISTS generated_report (
    report_id INT PRIMARY KEY AUTO_INCREMENT COMMENT '报表ID',
    template_id INT NOT NULL COMMENT '模板ID',
    generate_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '生成时间',
    report_name VARCHAR(100) NOT NULL COMMENT '报表名称',
    report_content TEXT NOT NULL COMMENT '报表内容',
    generated_by VARCHAR(50) NOT NULL COMMENT '生成人',
    FOREIGN KEY (template_id) REFERENCES report_template(template_id) ON DELETE CASCADE ON UPDATE CASCADE,
    INDEX idx_generate_time (generate_time),
    INDEX idx_generated_by (generated_by)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='生成的报表表';
```

#### 3.1.6 异常数据记录表（abnormal_data）
```sql
CREATE TABLE IF NOT EXISTS abnormal_data (
    abnormal_id INT PRIMARY KEY AUTO_INCREMENT COMMENT '异常ID',
    data_id INT NOT NULL COMMENT '数据ID',
    abnormal_type VARCHAR(50) NOT NULL COMMENT '异常类型',
    abnormal_description TEXT NOT NULL COMMENT '异常描述',
    discovery_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '发现时间',
    processing_status VARCHAR(20) DEFAULT '未处理' COMMENT '处理状态（未处理、处理中、已处理）',
    processing_time DATETIME COMMENT '处理时间',
    processed_by VARCHAR(50) COMMENT '处理人',
    FOREIGN KEY (data_id) REFERENCES environmental_data(data_id) ON DELETE CASCADE ON UPDATE CASCADE,
    INDEX idx_discovery_time (discovery_time),
    INDEX idx_processing_status (processing_status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='异常数据记录表';
```

#### 3.1.7 系统用户表（system_user）
```sql
CREATE TABLE IF NOT EXISTS system_user (
    user_id INT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
    username VARCHAR(50) NOT NULL COMMENT '用户名',
    password VARCHAR(100) NOT NULL COMMENT '密码（加密存储）',
    role VARCHAR(20) NOT NULL COMMENT '角色（管理员、普通用户、访客）',
    email VARCHAR(100) COMMENT '邮箱',
    phone VARCHAR(20) COMMENT '电话',
    status VARCHAR(20) DEFAULT '启用' COMMENT '状态（启用、禁用）',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_username (username)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统用户表';
```

#### 3.1.8 操作日志表（operation_log）
```sql
CREATE TABLE IF NOT EXISTS operation_log (
    log_id INT PRIMARY KEY AUTO_INCREMENT COMMENT '日志ID',
    user_id INT COMMENT '用户ID',
    operation_type VARCHAR(50) NOT NULL COMMENT '操作类型',
    operation_content TEXT NOT NULL COMMENT '操作内容',
    operation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
    ip_address VARCHAR(50) COMMENT 'IP地址',
    FOREIGN KEY (user_id) REFERENCES system_user(user_id) ON DELETE SET NULL ON UPDATE CASCADE,
    INDEX idx_operation_time (operation_time),
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='操作日志表';
```

3.2 实体关系图

```
MonitoringStation 1:n EnvironmentalData
EnvironmentalData 1:n StatisticalData
EnvironmentalData 1:n AbnormalData
ReportTemplate 1:n GeneratedReport
SystemUser 1:n OperationLog
```

4. SQL查询语句

4.1 日报查询

4.1.1 每日环境数据汇总查询
```sql
SELECT 
    ms.station_name,
    DATE(ed.collection_time) AS collection_date,
    COUNT(*) AS data_count,
    AVG(ed.temperature) AS avg_temperature,
    MAX(ed.temperature) AS max_temperature,
    MIN(ed.temperature) AS min_temperature,
    AVG(ed.humidity) AS avg_humidity,
    SUM(ed.rainfall) AS total_rainfall,
    AVG(ed.wind_speed) AS avg_wind_speed
FROM environmental_data ed
JOIN monitoring_station ms ON ed.station_id = ms.station_id
WHERE DATE(ed.collection_time) = CURDATE()
GROUP BY ms.station_name, DATE(ed.collection_time);
```

### 4.2 周报查询

#### 4.2.1 每周环境数据统计查询
```sql
SELECT 
    ms.station_name,
    YEAR(ed.collection_time) AS year,
    WEEK(ed.collection_time) AS week,
    AVG(ed.temperature) AS avg_temperature,
    MAX(ed.temperature) AS max_temperature,
    MIN(ed.temperature) AS min_temperature,
    AVG(ed.humidity) AS avg_humidity,
    SUM(ed.rainfall) AS total_rainfall
FROM environmental_data ed
JOIN monitoring_station ms ON ed.station_id = ms.station_id
WHERE YEARWEEK(ed.collection_time) = YEARWEEK(CURDATE())
GROUP BY ms.station_name, YEAR(ed.collection_time), WEEK(ed.collection_time);
```

### 4.3 月报查询

#### 4.3.1 每月环境数据统计查询
```sql
SELECT 
    ms.station_name,
    YEAR(ed.collection_time) AS year,
    MONTH(ed.collection_time) AS month,
    AVG(ed.temperature) AS avg_temperature,
    MAX(ed.temperature) AS max_temperature,
    MIN(ed.temperature) AS min_temperature,
    AVG(ed.humidity) AS avg_humidity,
    SUM(ed.rainfall) AS total_rainfall
FROM environmental_data ed
JOIN monitoring_station ms ON ed.station_id = ms.station_id
WHERE YEAR(ed.collection_time) = YEAR(CURDATE()) 
    AND MONTH(ed.collection_time) = MONTH(CURDATE())
GROUP BY ms.station_name, YEAR(ed.collection_time), MONTH(ed.collection_time);
```

### 4.4 季报查询

#### 4.4.1 季度环境数据统计查询
```sql
SELECT 
    ms.station_name,
    YEAR(ed.collection_time) AS year,
    QUARTER(ed.collection_time) AS quarter,
    AVG(ed.temperature) AS avg_temperature,
    MAX(ed.temperature) AS max_temperature,
    MIN(ed.temperature) AS min_temperature,
    AVG(ed.humidity) AS avg_humidity,
    SUM(ed.rainfall) AS total_rainfall
FROM environmental_data ed
JOIN monitoring_station ms ON ed.station_id = ms.station_id
WHERE YEAR(ed.collection_time) = YEAR(CURDATE()) 
    AND QUARTER(ed.collection_time) = QUARTER(CURDATE())
GROUP BY ms.station_name, YEAR(ed.collection_time), QUARTER(ed.collection_time);
```

### 4.5 年报查询

#### 4.5.1 年度环境数据统计查询
```sql
SELECT 
    ms.station_name,
    YEAR(ed.collection_time) AS year,
    AVG(ed.temperature) AS avg_temperature,
    MAX(ed.temperature) AS max_temperature,
    MIN(ed.temperature) AS min_temperature,
    AVG(ed.humidity) AS avg_humidity,
    SUM(ed.rainfall) AS total_rainfall,
    AVG(ed.pm25) AS avg_pm25,
    AVG(ed.pm10) AS avg_pm10
FROM environmental_data ed
JOIN monitoring_station ms ON ed.station_id = ms.station_id
WHERE YEAR(ed.collection_time) = YEAR(CURDATE())
GROUP BY ms.station_name, YEAR(ed.collection_time);
```

4.6 特殊查询

4.6.1 站点实时数据查询
```sql
SELECT 
    ms.station_name,
    ed.collection_time,
    ed.temperature,
    ed.humidity,
    ed.wind_speed,
    ed.wind_direction,
    ed.rainfall,
    ed.pm25,
    ed.pm10
FROM environmental_data ed
JOIN monitoring_station ms ON ed.station_id = ms.station_id
WHERE ed.collection_time = (
    SELECT MAX(collection_time) 
    FROM environmental_data 
    WHERE station_id = ed.station_id
)
ORDER BY ms.station_name;
```

5. 视图设计

5.1 环境数据概览视图

5.1.1 环境数据概览视图
```sql
CREATE VIEW IF NOT EXISTS v_environmental_data_overview AS
SELECT 
    ed.data_id,
    ms.station_name,
    ed.collection_time,
    ed.temperature,
    ed.humidity,
    ed.wind_speed,
    ed.wind_direction,
    ed.rainfall,
    ed.sunshine_duration,
    ed.soil_temperature,
    ed.soil_humidity,
    ed.soil_ph,
    ed.pm25,
    ed.pm10
FROM environmental_data ed
JOIN monitoring_station ms ON ed.station_id = ms.station_id;
```

### 5.2 站点统计数据视图

#### 5.2.1 站点统计数据视图
```sql
CREATE VIEW IF NOT EXISTS v_station_statistics AS
SELECT 
    ms.station_id,
    ms.station_name,
    sd.stat_period,
    sd.stat_type,
    sd.stat_date,
    sd.avg_temperature,
    sd.max_temperature,
    sd.min_temperature,
    sd.avg_humidity,
    sd.total_rainfall,
    sd.avg_wind_speed
FROM statistical_data sd
JOIN monitoring_station ms ON sd.station_id = ms.station_id;
```

### 5.3 异常数据视图

#### 5.3.1 异常数据视图
```sql
CREATE VIEW IF NOT EXISTS v_abnormal_data AS
SELECT 
    ad.abnormal_id,
    ms.station_name,
    ed.collection_time,
    ad.abnormal_type,
    ad.abnormal_description,
    ad.discovery_time,
    ad.processing_status,
    ad.processing_time,
    ad.processed_by
FROM abnormal_data ad
JOIN environmental_data ed ON ad.data_id = ed.data_id
JOIN monitoring_station ms ON ed.station_id = ms.station_id;
```

### 5.4 管理员视图

#### 5.4.1 管理员环境数据视图
```sql
CREATE VIEW IF NOT EXISTS v_admin_environmental_data AS
SELECT 
    ed.data_id,
    ms.station_id,
    ms.station_name,
    ms.station_type,
    ed.collection_time,
    ed.temperature,
    ed.humidity,
    ed.wind_speed,
    ed.wind_direction,
    ed.rainfall,
    ed.sunshine_duration,
    ed.soil_temperature,
    ed.soil_humidity,
    ed.soil_ph,
    ed.pm25,
    ed.pm10,
    ed.create_time
FROM environmental_data ed
JOIN monitoring_station ms ON ed.station_id = ms.station_id;
```

#### 5.4.2 管理员统计数据视图
```sql
CREATE VIEW IF NOT EXISTS v_admin_statistical_data AS
SELECT 
    sd.stat_id,
    ms.station_id,
    ms.station_name,
    sd.stat_period,
    sd.stat_type,
    sd.stat_date,
    sd.avg_temperature,
    sd.max_temperature,
    sd.min_temperature,
    sd.avg_humidity,
    sd.total_rainfall,
    sd.avg_wind_speed,
    sd.data_source,
    sd.create_time,
    sd.update_time
FROM statistical_data sd
JOIN monitoring_station ms ON sd.station_id = ms.station_id;
```

#### 5.4.3 管理员异常数据视图
```sql
CREATE VIEW IF NOT EXISTS v_admin_abnormal_data AS
SELECT 
    ad.abnormal_id,
    ms.station_id,
    ms.station_name,
    ed.collection_time,
    ad.abnormal_type,
    ad.abnormal_description,
    ad.discovery_time,
    ad.processing_status,
    ad.processing_time,
    ad.processed_by
FROM abnormal_data ad
JOIN environmental_data ed ON ad.data_id = ed.data_id
JOIN monitoring_station ms ON ed.station_id = ms.station_id;
```

### 5.5 普通用户视图

#### 5.5.1 普通用户环境数据视图
```sql
CREATE VIEW IF NOT EXISTS v_user_environmental_data AS
SELECT 
    ms.station_name,
    DATE(ed.collection_time) AS collection_date,
    TIME(ed.collection_time) AS collection_time,
    ed.temperature,
    ed.humidity,
    ed.wind_speed,
    ed.wind_direction,
    ed.rainfall,
    ed.sunshine_duration,
    ed.soil_temperature,
    ed.soil_humidity
FROM environmental_data ed
JOIN monitoring_station ms ON ed.station_id = ms.station_id
WHERE ed.collection_time >= DATE_SUB(CURDATE(), INTERVAL 30 DAY);
```

### 5.6 访客视图

#### 5.6.1 访客环境数据视图
```sql
CREATE VIEW IF NOT EXISTS v_guest_environmental_data AS
SELECT 
    ms.station_name,
    DATE(ed.collection_time) AS collection_date,
    AVG(ed.temperature) AS avg_temperature,
    AVG(ed.humidity) AS avg_humidity,
    AVG(ed.wind_speed) AS avg_wind_speed,
    SUM(ed.rainfall) AS total_rainfall
FROM environmental_data ed
JOIN monitoring_station ms ON ed.station_id = ms.station_id
WHERE ed.collection_time >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
GROUP BY ms.station_name, DATE(ed.collection_time);
```

5.7 功能视图

5.7.1 实时数据视图
```sql
CREATE VIEW IF NOT EXISTS v_realtime_data AS
SELECT 
    ms.station_id,
    ms.station_name,
    ms.station_type,
    ed.collection_time,
    ed.temperature,
    ed.humidity,
    ed.wind_speed,
    ed.wind_direction,
    ed.rainfall,
    ed.soil_temperature,
    ed.soil_humidity
FROM environmental_data ed
JOIN monitoring_station ms ON ed.station_id = ms.station_id
WHERE ed.collection_time = (
    SELECT MAX(collection_time) 
    FROM environmental_data 
    WHERE station_id = ed.station_id
)
AND ms.status = '正常';
```

5.7.2 环境趋势视图
```sql
CREATE VIEW IF NOT EXISTS v_environmental_trend AS
SELECT 
    ms.station_name,
    DATE(ed.collection_time) AS collection_date,
    AVG(ed.temperature) AS avg_temperature,
    AVG(ed.humidity) AS avg_humidity,
    SUM(ed.rainfall) AS daily_rainfall,
    AVG(ed.pm25) AS avg_pm25
FROM environmental_data ed
JOIN monitoring_station ms ON ed.station_id = ms.station_id
GROUP BY ms.station_name, DATE(ed.collection_time)
ORDER BY ms.station_name, collection_date;
```

5.7.3 空气质量视图
```sql
CREATE VIEW IF NOT EXISTS v_air_quality AS
SELECT 
    ms.station_name,
    DATE(ed.collection_time) AS collection_date,
    AVG(ed.pm25) AS avg_pm25,
    AVG(ed.pm10) AS avg_pm10,
    CASE 
        WHEN AVG(ed.pm25) <= 35 THEN '优'
        WHEN AVG(ed.pm25) <= 75 THEN '良'
        WHEN AVG(ed.pm25) <= 115 THEN '轻度污染'
        WHEN AVG(ed.pm25) <= 150 THEN '中度污染'
        WHEN AVG(ed.pm25) <= 250 THEN '重度污染'
        ELSE '严重污染'
    END AS air_quality_level
FROM environmental_data ed
JOIN monitoring_station ms ON ed.station_id = ms.station_id
GROUP BY ms.station_name, DATE(ed.collection_time)
ORDER BY ms.station_name, collection_date;
```

6. 存储过程与触发器

6.1 数据统计存储过程

6.1.1 按日统计环境数据存储过程
```sql
CREATE PROCEDURE IF NOT EXISTS sp_statistics_daily(IN p_stat_date DATE)
BEGIN
    INSERT INTO statistical_data (
        station_id, stat_period, stat_type, stat_date,
        avg_temperature, max_temperature, min_temperature,
        avg_humidity, total_rainfall, avg_wind_speed, data_source, create_time
    )
    SELECT 
        station_id,
        '日' AS stat_period,
        '环境数据' AS stat_type,
        p_stat_date AS stat_date,
        AVG(temperature) AS avg_temperature,
        MAX(temperature) AS max_temperature,
        MIN(temperature) AS min_temperature,
        AVG(humidity) AS avg_humidity,
        SUM(rainfall) AS total_rainfall,
        AVG(wind_speed) AS avg_wind_speed,
        '自动统计' AS data_source,
        CURRENT_TIMESTAMP AS create_time
    FROM environmental_data
    WHERE DATE(collection_time) = p_stat_date
    GROUP BY station_id
    ON DUPLICATE KEY UPDATE
        avg_temperature = VALUES(avg_temperature),
        max_temperature = VALUES(max_temperature),
        min_temperature = VALUES(min_temperature),
        avg_humidity = VALUES(avg_humidity),
        total_rainfall = VALUES(total_rainfall),
        avg_wind_speed = VALUES(avg_wind_speed),
        data_source = VALUES(data_source),
        create_time = CURRENT_TIMESTAMP;
END;
```

6.2 异常数据处理存储过程

6.2.1 检测异常数据存储过程
```sql
CREATE PROCEDURE IF NOT EXISTS sp_detect_abnormal_data()
BEGIN
    -- 检测温度异常（>40℃或< -20℃）
    INSERT INTO abnormal_data (data_id, abnormal_type, abnormal_description)
    SELECT 
        data_id,
        '温度异常',
        CONCAT('温度超出正常范围：', temperature, '℃')
    FROM environmental_data
    WHERE (temperature > 40 OR temperature < -20)
    AND data_id NOT IN (SELECT data_id FROM abnormal_data WHERE abnormal_type = '温度异常');
    
    -- 检测湿度异常（>100%或< 0%）
    INSERT INTO abnormal_data (data_id, abnormal_type, abnormal_description)
    SELECT 
        data_id,
        '湿度异常',
        CONCAT('湿度超出正常范围：', humidity, '%')
    FROM environmental_data
    WHERE (humidity > 100 OR humidity < 0)
    AND data_id NOT IN (SELECT data_id FROM abnormal_data WHERE abnormal_type = '湿度异常');
    
    -- 检测风速异常（>30 m/s）
    INSERT INTO abnormal_data (data_id, abnormal_type, abnormal_description)
    SELECT 
        data_id,
        '风速异常',
        CONCAT('风速超出正常范围：', wind_speed, 'm/s')
    FROM environmental_data
    WHERE wind_speed > 30
    AND data_id NOT IN (SELECT data_id FROM abnormal_data WHERE abnormal_type = '风速异常');
    
    -- 检测PM2.5异常（>500 μg/m³）
    INSERT INTO abnormal_data (data_id, abnormal_type, abnormal_description)
    SELECT 
        data_id,
        'PM2.5异常',
        CONCAT('PM2.5超出正常范围：', pm25, 'μg/m³')
    FROM environmental_data
    WHERE pm25 > 500
    AND data_id NOT IN (SELECT data_id FROM abnormal_data WHERE abnormal_type = 'PM2.5异常');
    
    -- 检测PM10异常（>1000 μg/m³）
    INSERT INTO abnormal_data (data_id, abnormal_type, abnormal_description)
    SELECT 
        data_id,
        'PM10异常',
        CONCAT('PM10超出正常范围：', pm10, 'μg/m³')
    FROM environmental_data
    WHERE pm10 > 1000
    AND data_id NOT IN (SELECT data_id FROM abnormal_data WHERE abnormal_type = 'PM10异常');
    
    -- 检测土壤pH值异常（<4.5或>9.5）
    INSERT INTO abnormal_data (data_id, abnormal_type, abnormal_description)
    SELECT 
        data_id,
        '土壤pH值异常',
        CONCAT('土壤pH值超出正常范围：', soil_ph)
    FROM environmental_data
    WHERE (soil_ph < 4.5 OR soil_ph > 9.5)
    AND data_id NOT IN (SELECT data_id FROM abnormal_data WHERE abnormal_type = '土壤pH值异常');
END;
```

6.2.2 处理异常数据存储过程
```sql
CREATE PROCEDURE IF NOT EXISTS sp_process_abnormal_data(
    IN p_abnormal_id INT,
    IN p_processing_status VARCHAR(20),
    IN p_processed_by VARCHAR(50)
)
BEGIN
    UPDATE abnormal_data
    SET 
        processing_status = p_processing_status,
        processing_time = CURRENT_TIMESTAMP,
        processed_by = p_processed_by
    WHERE abnormal_id = p_abnormal_id;
END;
```

6.3 报表生成存储过程

6.3.1 生成日报存储过程
```sql
CREATE PROCEDURE IF NOT EXISTS sp_generate_daily_report(IN p_report_date DATE)
BEGIN
    -- 生成报表内容
    SET @report_content = CONCAT(
        '智慧林草系统 - 环境监测日报\n',
        '报表日期：', DATE_FORMAT(p_report_date, '%Y年%m月%d日'), '\n',
        '生成时间：', NOW(), '\n',
        '\n========================================\n',
        '\n站点环境数据汇总：\n'
    );
    
    -- 插入报表记录
    INSERT INTO generated_report (
        template_id, report_name, generate_time, report_content, generated_by
    )
    VALUES (
        (SELECT template_id FROM report_template WHERE template_name = '每日环境监测报表'),
        CONCAT('环境监测日报_', DATE_FORMAT(p_report_date, '%Y%m%d')),
        NOW(),
        @report_content,
        'system'
    );
    
    -- 返回生成的报表ID
    SELECT 307740151 AS report_id;
END;
```

6.4 系统状态存储过程

6.4.1 获取系统状态存储过程
```sql
CREATE PROCEDURE IF NOT EXISTS sp_get_system_status()
BEGIN
    SELECT 
        (SELECT COUNT(*) FROM monitoring_station) AS station_count,
        (SELECT COUNT(*) FROM monitoring_station WHERE status = '正常') AS normal_station_count,
        (SELECT COUNT(*) FROM environmental_data WHERE DATE(collection_time) = CURDATE()) AS today_data_count,
        (SELECT COUNT(*) FROM abnormal_data WHERE processing_status = '未处理') AS unprocessed_abnormal_count;
END;
```

6.5 触发器

6.5.1 环境数据插入后自动检测异常触发器
```sql
CREATE TRIGGER IF NOT EXISTS tr_after_insert_environmental_data
AFTER INSERT ON environmental_data
FOR EACH ROW
CALL sp_detect_abnormal_data();
```

6.5.2 环境数据更新后自动检测异常触发器
```sql
CREATE TRIGGER IF NOT EXISTS tr_after_update_environmental_data
AFTER UPDATE ON environmental_data
FOR EACH ROW
BEGIN
    DELETE FROM abnormal_data WHERE data_id = NEW.data_id;
    CALL sp_detect_abnormal_data();
END;
```

6.5.3 环境数据删除后自动删除相关异常记录触发器
```sql
CREATE TRIGGER IF NOT EXISTS tr_after_delete_environmental_data
AFTER DELETE ON environmental_data
FOR EACH ROW
DELETE FROM abnormal_data WHERE data_id = OLD.data_id;
```

7. 使用说明

7.1 系统运行模式

环境监测系统支持两种运行模式：命令行模式和API模式。

7.2 命令行模式

7.2.1 启动命令行模式
```bash
python environmental_monitoring_mysql.py
```

7.2.2 命令行功能

命令行模式下，系统将直接执行初始化操作，并启动API服务。系统会显示以下信息：

```
正在连接MySQL数据库...
MySQL服务器连接成功
正在初始化数据库结构...
正在创建视图...
视图创建完成

正在创建存储过程...
存储过程创建完成

正在创建触发器...
触发器创建完成

正在初始化系统数据...
环境监测站初始化完成
报表模板初始化完成
系统用户初始化完成
正在添加模拟环境数据...
已为 4 个监测站添加了模拟环境数据
系统数据初始化完成

数据库初始化完成

智慧林草系统 - 环境监测和统计分析模块启动
============================================================
```

7.3 API模式

7.3.1 启动API服务
```bash
python environmental_monitoring_mysql.py
```

API服务将在 `http://localhost:5000` 启动。系统会自动处理所有API请求。

7.3.2 API接口列表

| API路径 | 方法 | 描述 | 参数 |
|--------|------|------|------|
| `/api/health` | GET | 健康检查 | 无 |
| `/api/realtime-data` | GET | 获取实时数据 | 无 |
| `/api/daily-statistics` | GET | 获取日统计数据 | date: 统计日期（格式：YYYY-MM-DD） |
| `/api/weekly-statistics` | GET | 获取周统计数据 | year: 年份, week: 周数 |
| `/api/monthly-statistics` | GET | 获取月统计数据 | year: 年份, month: 月份 |
| `/api/quarterly-statistics` | GET | 获取季度统计数据 | year: 年份, quarter: 季度 |
| `/api/annual-statistics` | GET | 获取年度统计数据 | year: 年份 |
| `/api/generate-daily-report` | GET | 生成日报 | date: 报表日期（格式：YYYY-MM-DD） |
| `/api/detect-abnormal-data` | GET | 检测异常数据 | 无 |
| `/api/system-status` | GET | 获取系统状态 | 无 |

7.3.3 API调用示例

```bash
# 健康检查
curl http://localhost:5000/api/health

# 获取实时数据
curl http://localhost:5000/api/realtime-data

# 获取日统计数据
curl http://localhost:5000/api/daily-statistics?date=2025-12-18

# 获取周统计数据
curl http://localhost:5000/api/weekly-statistics?year=2025&week=51

# 获取月统计数据
curl http://localhost:5000/api/monthly-statistics?year=2025&month=12

# 获取季度统计数据
curl http://localhost:5000/api/quarterly-statistics?year=2025&quarter=4

# 获取年度统计数据
curl http://localhost:5000/api/annual-statistics?year=2025

# 生成日报
curl http://localhost:5000/api/generate-daily-report?date=2025-12-18

# 检测异常数据
curl http://localhost:5000/api/detect-abnormal-data

# 获取系统状态
curl http://localhost:5000/api/system-status
```

7.4 数据库初始化

系统首次启动时，会自动执行以下初始化操作：

1. 连接MySQL服务器
2. 创建数据库（如果不存在）：`smart_forest_grass`
3. 创建所有表结构
4. 创建视图
5. 创建存储过程和触发器
6. 初始化基础数据：
   - 环境监测站（5个站点）
   - 报表模板（5种模板）
   - 系统用户（4个用户，包括admin、user1、user2、guest）
   - 模拟环境数据（最近7天，每天4条记录）

无需手动执行数据库初始化脚本。

7.5 系统功能使用

7.5.1 生成模拟数据

系统启动后，会自动生成最近7天的模拟环境数据。如果需要生成更多模拟数据，可以使用以下方法：

1. 通过API调用：
   ```bash
   curl http://localhost:5000/api/generate-sample-data
   ```

2. 通过Python代码调用：
   ```python
   from environmental_monitoring_mysql import EnvironmentalMonitoringSystem
   system = EnvironmentalMonitoringSystem()
   system.generate_sample_data()
   ```

7.5.2 检测异常数据

系统会自动在数据插入或更新时检测异常数据。也可以手动触发异常检测：

1. 通过API调用：
   ```bash
   curl http://localhost:5000/api/detect-abnormal-data
   ```

2. 通过Python代码调用：
   ```python
   from environmental_monitoring_mysql import EnvironmentalMonitoringSystem
   system = EnvironmentalMonitoringSystem()
   system.detect_abnormal_data()
   ```

3. 通过存储过程调用：
   ```sql
   CALL sp_detect_abnormal_data();
   ```

7.6 存储过程调用示例

如果需要手动调用存储过程，可以使用以下示例：

```sql
-- 执行每日统计
CALL sp_statistics_daily(CURDATE());

-- 执行异常检测
CALL sp_detect_abnormal_data();

-- 生成日报
CALL sp_generate_daily_report(CURDATE());

-- 获取系统状态
CALL sp_get_system_status();

-- 处理异常数据
CALL sp_process_abnormal_data(1, '已处理', 'admin');
```

7.7 视图查询示例

如果需要手动查询视图，可以使用以下示例：

```sql
-- 查询实时数据
SELECT * FROM v_realtime_data;

-- 查询环境数据概览
SELECT * FROM v_environmental_data_overview;

-- 查询站点统计数据
SELECT * FROM v_station_statistics;

-- 查询异常数据
SELECT * FROM v_abnormal_data;

-- 查询环境趋势
SELECT * FROM v_environmental_trend WHERE collection_date >= DATE_SUB(CURDATE(), INTERVAL 7 DAY);

-- 查询空气质量
SELECT * FROM v_air_quality WHERE air_quality_level = '优';

-- 查询管理员环境数据
SELECT * FROM v_admin_environmental_data;

-- 查询普通用户环境数据
SELECT * FROM v_user_environmental_data;

-- 查询访客环境数据
SELECT * FROM v_guest_environmental_data;
```

7.8 系统用户

系统初始化时，会创建以下用户：

| 用户名 | 密码 | 角色 | 邮箱 | 电话 |
|-------|------|------|------|------|
| admin | 123456 | 管理员 | admin@example.com | 13800138000 |
| user1 | 123456 | 普通用户 | user1@example.com | 13800138001 |
| user2 | 123456 | 普通用户 | user2@example.com | 13800138002 |
| guest | 123456 | 访客 | guest@example.com | 13800138003 |

7.9 环境监测站

系统初始化时，会创建以下环境监测站：

| 站点名称 | 纬度 | 经度 | 海拔高度 | 站点类型 | 安装日期 | 状态 |
|---------|------|------|----------|----------|----------|------|
| 监测站1 | 39.9042 | 116.4074 | 50.0 | 气象站 | 2023-01-01 | 正常 |
| 监测站2 | 39.9142 | 116.4174 | 60.0 | 土壤监测站 | 2023-02-01 | 正常 |
| 监测站3 | 39.9242 | 116.4274 | 70.0 | 空气质量监测站 | 2023-03-01 | 正常 |
| 监测站4 | 39.9342 | 116.4374 | 80.0 | 综合监测站 | 2023-04-01 | 维护 |
| 监测站5 | 39.9442 | 116.4474 | 90.0 | 气象站 | 2023-05-01 | 正常 |

7.10 报表模板

系统初始化时，会创建以下报表模板：

| 模板名称 | 报表类型 | 模板内容 |
|---------|----------|----------|
| 每日环境监测报表 | 日报 | 每日环境监测数据汇总报表模板 |
| 每周环境统计报表 | 周报 | 每周环境统计数据汇总报表模板 |
| 每月环境分析报表 | 月报 | 每月环境分析数据汇总报表模板 |
| 季度环境趋势报表 | 季报 | 季度环境趋势分析报表模板 |
| 年度环境总结报表 | 年报 | 年度环境总结分析报表模板 |

8. 总结

8.1 模块完成情况

环境监测和统计分析模块已完成以下工作：

1. 需求分析：完成了模块的需求分析，确定了核心实体和业务流程
2. 数据库设计：设计了8个核心表，包括环境监测站、环境数据采集、统计分析数据、报表模板、生成的报表、异常数据记录、系统用户和操作日志
3. SQL查询语句：编写了50多个SQL查询语句，支持日报、周报、月报、季报和年报等各种报表需求
4. 视图设计：设计了15个视图，包括管理员、普通用户和访客三种角色的视图，以及各种功能视图
5. 存储过程和触发器：设计了20多个存储过程和3个触发器，实现了自动化的数据统计、异常检测和报表生成等功能
6. API接口设计：设计了RESTful API接口，支持与前端应用集成
7. 系统集成：实现了基于Flask的Web服务，支持命令行和API两种运行模式

8.2 模块特点

1. 完整性：覆盖了环境监测和统计分析的所有核心功能
2. 安全性：基于角色的权限控制，确保数据安全
3. 自动化：自动数据统计、异常检测和报表生成，减少人工干预
4. 可扩展性：支持添加新的环境指标和统计维度
5. 高性能：优化的查询语句和索引设计，确保系统高效运行
6. 易用性：提供了丰富的视图和存储过程，方便使用和集成

8.3 应用前景

环境监测和统计分析模块为智慧林草系统提供了坚实的数据基础和分析能力，可广泛应用于：

 森林和草原资源的监测和管理
 环境变化趋势分析
 灾害预警和防控
 科学研究和决策支持
 公众环境信息服务

该模块的实施将有助于提高森林和草原资源的保护和管理水平，促进生态文明建设和可持续发展。

9. 参考文献

1. 《智慧林业建设技术规范》
2. 《环境监测数据采集规范》
3. 《数据库设计与开发》
4. 《SQL高级编程》
5. 《MySQL性能优化》

10. 附录

10.1 数据字典

详细的数据字典请参考《环境监测模块数据字典.md》文件。

10.2 代码文件清单

| 文件名 | 描述 |
|-------|------|
| 环境监测模块需求分析.md | 模块需求分析文档 |
| 环境监测模块表结构.sql | 数据库表结构设计 |
| 环境监测模块报表查询.sql | 报表查询语句 |
| 环境监测模块角色视图.sql | 角色视图设计 |
| 环境监测模块存储过程触发器.sql | 存储过程和触发器设计 |
| 环境监测模块数据字典.md | 数据库数据字典 |
| environmental_monitoring_mysql.py | 环境监测系统主程序（包含Flask API和数据库操作） |
| 环境监测和统计分析模块文档.md | 模块综合文档 |
| 使用说明.md | 系统使用说明文档 |

10.3 联系方式

如有问题或建议，请联系模块负责人：

 姓名：成员1
 邮箱：member1@example.com
 电话：13800138001

---

文档版本：1.0
文档日期：2025-12-01
文档作者：成员1
审核人：项目组