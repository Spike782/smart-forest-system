<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧林草系统 - 环境监测和统计分析</title>
    <!-- 引入Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background-color: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .nav-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #666;
        }

        .nav-tab:hover {
            background-color: #f0f2f5;
        }

        .nav-tab.active {
            background-color: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .card-icon {
            font-size: 20px;
            color: #3498db;
        }

        .realtime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .data-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 4px solid #3498db;
        }

        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .data-value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .data-label {
            font-size: 14px;
            color: #666;
        }

        .data-unit {
            font-size: 16px;
            color: #999;
            margin-left: 5px;
        }

        .chart-container {
            height: 300px;
            margin: 20px 0;
        }

        .stats-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background-color: #f0f2f5;
        }

        .filter-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }

        .date-picker {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background-color: #f5f7fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-normal {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        .status-warning {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-danger {
            background-color: #f8d7da;
            color: #721c24;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading i {
            font-size: 24px;
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .report-content {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: 'Courier New', Courier, monospace;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .realtime-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .stats-filter {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1><i class="fas fa-leaf"></i> 智慧林草系统</h1>
                <p>环境监测和统计分析模块</p>
            </div>
            <div>
                <span id="current-time"></span>
            </div>
        </header>

        <!-- 导航标签 -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="realtime">
                <i class="fas fa-clock"></i> 实时数据
            </div>
            <div class="nav-tab" data-tab="statistics">
                <i class="fas fa-chart-bar"></i> 统计分析
            </div>
            <div class="nav-tab" data-tab="trend">
                <i class="fas fa-chart-line"></i> 环境趋势
            </div>
            <div class="nav-tab" data-tab="air-quality">
                <i class="fas fa-wind"></i> 空气质量
            </div>
            <div class="nav-tab" data-tab="abnormal">
                <i class="fas fa-exclamation-triangle"></i> 异常数据
            </div>
            <div class="nav-tab" data-tab="reports">
                <i class="fas fa-file-alt"></i> 报表生成
            </div>
        </div>

        <!-- 实时数据标签页 -->
        <div id="realtime" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-tachometer-alt"></i> 实时环境数据</h3>
                    <button class="btn btn-primary" onclick="refreshRealtimeData()">
                        <i class="fas fa-sync"></i> 刷新
                    </button>
                </div>
                <div id="realtime-data" class="loading">
                    <i class="fas fa-spinner"></i> 加载中...
                </div>
            </div>
        </div>

        <!-- 统计分析标签页 -->
        <div id="statistics" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chart-pie"></i> 统计数据</h3>
                    <div class="stats-filter">
                        <button class="filter-btn active" data-period="daily">日统计</button>
                        <button class="filter-btn" data-period="weekly">周统计</button>
                        <button class="filter-btn" data-period="monthly">月统计</button>
                        <input type="date" id="stats-date" class="date-picker" value="">
                        <button class="btn btn-info" onclick="loadStatistics()">
                            <i class="fas fa-search"></i> 查询
                        </button>
                    </div>
                </div>
                <div id="statistics-content" class="loading">
                    <i class="fas fa-spinner"></i> 加载中...
                </div>
            </div>
        </div>

        <!-- 环境趋势标签页 -->
        <div id="trend" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chart-line"></i> 环境趋势分析</h3>
                    <div class="stats-filter">
                        <select id="station-select" class="filter-btn">
                            <option value="监测站1">监测站1</option>
                            <option value="监测站2">监测站2</option>
                            <option value="监测站3">监测站3</option>
                            <option value="监测站5">监测站5</option>
                        </select>
                        <select id="days-select" class="filter-btn">
                            <option value="7">最近7天</option>
                            <option value="14">最近14天</option>
                            <option value="30" selected>最近30天</option>
                        </select>
                        <button class="btn btn-info" onclick="loadEnvironmentalTrend()">
                            <i class="fas fa-chart-line"></i> 生成趋势图
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="trend-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- 空气质量标签页 -->
        <div id="air-quality" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-wind"></i> 空气质量监测</h3>
                    <div class="stats-filter">
                        <select id="air-station-select" class="filter-btn">
                            <option value="监测站3">监测站3</option>
                            <option value="监测站5">监测站5</option>
                        </select>
                        <select id="air-days-select" class="filter-btn">
                            <option value="7">最近7天</option>
                            <option value="14" selected>最近14天</option>
                            <option value="30">最近30天</option>
                        </select>
                        <button class="btn btn-info" onclick="loadAirQuality()">
                            <i class="fas fa-chart-bar"></i> 生成空气质量图
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="air-quality-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- 异常数据标签页 -->
        <div id="abnormal" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-exclamation-triangle"></i> 异常数据统计</h3>
                    <div class="stats-filter">
                        <select id="abnormal-days" class="filter-btn">
                            <option value="7">最近7天</option>
                            <option value="30" selected>最近30天</option>
                            <option value="90">最近90天</option>
                        </select>
                        <button class="btn btn-info" onclick="loadAbnormalData()">
                            <i class="fas fa-search"></i> 查询
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="abnormal-chart"></canvas>
                </div>
                <div id="abnormal-table" class="loading">
                    <i class="fas fa-spinner"></i> 加载中...
                </div>
            </div>
        </div>

        <!-- 报表生成标签页 -->
        <div id="reports" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-file-alt"></i> 报表生成</h3>
                    <div class="stats-filter">
                        <input type="date" id="report-date" class="date-picker" value="">
                        <button class="btn btn-success" onclick="generateDailyReport()">
                            <i class="fas fa-file-export"></i> 生成日报
                        </button>
                    </div>
                </div>
                <div id="report-result">
                    <p>请选择日期并点击生成按钮</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API基础URL
        const API_BASE_URL = 'http://localhost:5000/api';
        
        // 全局图表实例
        let trendChart = null;
        let airQualityChart = null;
        let abnormalChart = null;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置当前时间
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // 设置默认日期
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('stats-date').value = today;
            document.getElementById('report-date').value = today;
            
            // 初始化标签切换
            initTabSwitching();
            
            // 加载初始数据
            loadRealtimeData();
            loadEnvironmentalTrend();
            loadAirQuality();
            loadAbnormalData();
        });

        // 更新当前时间
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('zh-CN');
        }

        // 初始化标签切换
        function initTabSwitching() {
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有活动状态
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    // 添加当前活动状态
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }

        // 加载实时数据
        function loadRealtimeData() {
            fetch(`${API_BASE_URL}/realtime-data`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderRealtimeData(data.data);
                    } else {
                        document.getElementById('realtime-data').innerHTML = `<div class="alert alert-error">加载失败: ${data.error}</div>`;
                    }
                })
                .catch(error => {
                    document.getElementById('realtime-data').innerHTML = `<div class="alert alert-error">加载失败: ${error.message}</div>`;
                });
        }

        // 渲染实时数据
        function renderRealtimeData(data) {
            if (data.length === 0) {
                document.getElementById('realtime-data').innerHTML = '<div class="alert alert-warning">暂无实时数据</div>';
                return;
            }

            let html = '<div class="realtime-grid">';
            data.forEach(station => {
                html += `
                    <div class="data-card">
                        <h4>${station.station_name} <small>(${station.station_type})</small></h4>
                        <div style="margin-top: 15px;">
                            <div class="data-value">${station.temperature}<span class="data-unit">℃</span></div>
                            <div class="data-label">温度</div>
                        </div>
                        <div style="margin-top: 15px;">
                            <div class="data-value">${station.humidity}<span class="data-unit">%</span></div>
                            <div class="data-label">湿度</div>
                        </div>
                        <div style="margin-top: 15px;">
                            <div class="data-value">${station.wind_speed}<span class="data-unit">m/s</span></div>
                            <div class="data-label">风速</div>
                        </div>
                        <div style="margin-top: 15px; font-size: 12px; color: #999;">
                            更新时间: ${station.collection_time}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            document.getElementById('realtime-data').innerHTML = html;
        }

        // 刷新实时数据
        function refreshRealtimeData() {
            document.getElementById('realtime-data').innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> 刷新中...</div>';
            loadRealtimeData();
        }

        // 加载统计数据
        function loadStatistics() {
            const period = document.querySelector('.filter-btn.active').getAttribute('data-period');
            const date = document.getElementById('stats-date').value;
            let url = '';

            switch(period) {
                case 'daily':
                    url = `${API_BASE_URL}/daily-statistics?date=${date}`;
                    break;
                case 'weekly':
                    const week = getWeekNumber(new Date(date));
                    const year = new Date(date).getFullYear();
                    url = `${API_BASE_URL}/weekly-statistics?year=${year}&week=${week}`;
                    break;
                case 'monthly':
                    const yearMonth = date.split('-');
                    url = `${API_BASE_URL}/monthly-statistics?year=${yearMonth[0]}&month=${yearMonth[1]}`;
                    break;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderStatistics(data.data, period);
                    } else {
                        document.getElementById('statistics-content').innerHTML = `<div class="alert alert-error">加载失败: ${data.error}</div>`;
                    }
                })
                .catch(error => {
                    document.getElementById('statistics-content').innerHTML = `<div class="alert alert-error">加载失败: ${error.message}</div>`;
                });
        }

        // 渲染统计数据
        function renderStatistics(data, period) {
            if (data.length === 0) {
                document.getElementById('statistics-content').innerHTML = '<div class="alert alert-warning">暂无统计数据</div>';
                return;
            }

            let html = '<table>';
            html += `
                <thead>
                    <tr>
                        <th>站点名称</th>
                        <th>数据条数</th>
                        <th>平均温度</th>
                        <th>最高温度</th>
                        <th>最低温度</th>
                        <th>平均湿度</th>
                        <th>总降雨量</th>
                    </tr>
                </thead>
                <tbody>
            `;

            data.forEach(stat => {
                // 将值转换为数字类型，避免toFixed调用失败
                const avgTemp = parseFloat(stat.avg_temperature) || 0;
                const maxTemp = parseFloat(stat.max_temperature) || 0;
                const minTemp = parseFloat(stat.min_temperature) || 0;
                const avgHumidity = parseFloat(stat.avg_humidity) || 0;
                const totalRainfall = parseFloat(stat.total_rainfall) || 0;
                
                html += `
                    <tr>
                        <td>${stat.station_name}</td>
                        <td>${stat.data_count}</td>
                        <td>${avgTemp.toFixed(2)}℃</td>
                        <td>${maxTemp.toFixed(2)}℃</td>
                        <td>${minTemp.toFixed(2)}℃</td>
                        <td>${avgHumidity.toFixed(2)}%</td>
                        <td>${totalRainfall.toFixed(2)}mm</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('statistics-content').innerHTML = html;
        }

        // 加载环境趋势数据
        function loadEnvironmentalTrend() {
            const stationName = document.getElementById('station-select').value;
            const days = document.getElementById('days-select').value;

            fetch(`${API_BASE_URL}/environmental-trend?station_name=${stationName}&days=${days}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderEnvironmentalTrend(data.data, stationName);
                    } else {
                        console.error('加载环境趋势数据失败:', data.error);
                    }
                })
                .catch(error => {
                    console.error('加载环境趋势数据失败:', error);
                });
        }

        // 渲染环境趋势图表
        function renderEnvironmentalTrend(data, stationName) {
            const ctx = document.getElementById('trend-chart').getContext('2d');
            
            // 准备数据
            const dates = data.map(item => item.trend_date);
            const temperatures = data.map(item => {
                const temp = parseFloat(item.avg_temperature);
                return isNaN(temp) ? 0 : temp.toFixed(1);
            });
            const humidity = data.map(item => {
                const hum = parseFloat(item.avg_humidity);
                return isNaN(hum) ? 0 : hum.toFixed(1);
            });
            const rainfall = data.map(item => {
                const rain = parseFloat(item.total_rainfall);
                return isNaN(rain) ? 0 : rain.toFixed(1);
            });

            // 销毁现有图表
            if (trendChart) {
                trendChart.destroy();
            }

            // 创建新图表
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: '平均温度 (℃)',
                            data: temperatures,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: '平均湿度 (%)',
                            data: humidity,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: '总降雨量 (mm)',
                            data: rainfall,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${stationName} - 环境趋势分析`,
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '温度/湿度'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '降雨量 (mm)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // 加载空气质量数据
        function loadAirQuality() {
            const stationName = document.getElementById('air-station-select').value;
            const days = document.getElementById('air-days-select').value;

            fetch(`${API_BASE_URL}/air-quality?station_name=${stationName}&days=${days}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderAirQuality(data.data, stationName);
                    } else {
                        console.error('加载空气质量数据失败:', data.error);
                    }
                })
                .catch(error => {
                    console.error('加载空气质量数据失败:', error);
                });
        }

        // 渲染空气质量图表
        function renderAirQuality(data, stationName) {
            const ctx = document.getElementById('air-quality-chart').getContext('2d');
            
            // 准备数据
            const dates = data.map(item => item.air_date);
            const pm25 = data.map(item => {
                const pm25Value = parseFloat(item.avg_pm25);
                return isNaN(pm25Value) ? 0 : pm25Value.toFixed(1);
            });
            const pm10 = data.map(item => {
                const pm10Value = parseFloat(item.avg_pm10);
                return isNaN(pm10Value) ? 0 : pm10Value.toFixed(1);
            });

            // 销毁现有图表
            if (airQualityChart) {
                airQualityChart.destroy();
            }

            // 创建新图表
            airQualityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'PM2.5 (μg/m³)',
                            data: pm25,
                            backgroundColor: '#e67e22'
                        },
                        {
                            label: 'PM10 (μg/m³)',
                            data: pm10,
                            backgroundColor: '#9b59b6'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${stationName} - 空气质量分析`,
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '浓度 (μg/m³)'
                            }
                        }
                    }
                }
            });
        }

        // 加载异常数据
        function loadAbnormalData() {
            const days = document.getElementById('abnormal-days').value;

            fetch(`${API_BASE_URL}/abnormal-data-statistics?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderAbnormalData(data.data);
                    } else {
                        console.error('加载异常数据失败:', data.error);
                    }
                })
                .catch(error => {
                    console.error('加载异常数据失败:', error);
                });
        }

        // 渲染异常数据
        function renderAbnormalData(data) {
            // 渲染图表
            renderAbnormalChart(data);
            
            // 渲染表格
            renderAbnormalTable(data);
        }

        // 渲染异常数据图表
        function renderAbnormalChart(data) {
            const ctx = document.getElementById('abnormal-chart').getContext('2d');
            
            // 按站点和异常类型分组统计
            const stationData = {};
            data.forEach(item => {
                if (!stationData[item.station_name]) {
                    stationData[item.station_name] = {};
                }
                stationData[item.station_name][item.abnormal_type] = item.abnormal_count;
            });

            // 准备图表数据
            const labels = Object.keys(stationData);
            const datasets = [];
            const abnormalTypes = [...new Set(data.map(item => item.abnormal_type))];
            
            // 颜色映射
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            
            abnormalTypes.forEach((type, index) => {
                datasets.push({
                    label: type,
                    data: labels.map(station => stationData[station][type] || 0),
                    backgroundColor: colors[index % colors.length]
                });
            });

            // 销毁现有图表
            if (abnormalChart) {
                abnormalChart.destroy();
            }

            // 创建新图表
            abnormalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '异常数据统计',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '异常数量'
                            }
                        }
                    }
                }
            });
        }

        // 渲染异常数据表格
        function renderAbnormalTable(data) {
            if (data.length === 0) {
                document.getElementById('abnormal-table').innerHTML = '<div class="alert alert-warning">暂无异常数据</div>';
                return;
            }

            let html = '<table>';
            html += `
                <thead>
                    <tr>
                        <th>站点名称</th>
                        <th>异常类型</th>
                        <th>异常数量</th>
                    </tr>
                </thead>
                <tbody>
            `;

            data.forEach(item => {
                html += `
                    <tr>
                        <td>${item.station_name}</td>
                        <td>${item.abnormal_type}</td>
                        <td><span class="status-badge status-danger">${item.abnormal_count}</span></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('abnormal-table').innerHTML = html;
        }

        // 生成日报
        function generateDailyReport() {
            const reportDate = document.getElementById('report-date').value;
            
            if (!reportDate) {
                document.getElementById('report-result').innerHTML = '<div class="alert alert-warning">请选择日期</div>';
                return;
            }

            document.getElementById('report-result').innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> 生成中...</div>';

            fetch(`${API_BASE_URL}/generate-daily-report?date=${reportDate}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('report-result').innerHTML = `
                            <div class="alert alert-success">报表生成成功</div>
                            <h4>日报内容</h4>
                            <div class="report-content">${data.data.report_content}</div>
                        `;
                    } else {
                        document.getElementById('report-result').innerHTML = `<div class="alert alert-error">生成失败: ${data.error}</div>`;
                    }
                })
                .catch(error => {
                    document.getElementById('report-result').innerHTML = `<div class="alert alert-error">生成失败: ${error.message}</div>`;
                });
        }

        // 辅助函数：获取周数
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // 初始化统计分析标签页的过滤按钮
        document.querySelectorAll('.filter-btn[data-period]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn[data-period]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                loadStatistics();
            });
        });
    </script>
</body>
</html>