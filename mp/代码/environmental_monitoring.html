<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧林草系统 - 环境监测和统计分析</title>
    <!-- 引入Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background-color: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .nav-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #666;
        }

        .nav-tab:hover {
            background-color: #f0f2f5;
        }

        .nav-tab.active {
            background-color: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .card-icon {
            font-size: 20px;
            color: #3498db;
        }

        .realtime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .data-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 4px solid #3498db;
        }

        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .data-value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .data-label {
            font-size: 14px;
            color: #666;
        }

        .data-unit {
            font-size: 16px;
            color: #999;
            margin-left: 5px;
        }

        .chart-container {
            height: 300px;
            margin: 20px 0;
        }

        .stats-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background-color: #f0f2f5;
        }

        .filter-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }

        .date-picker {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background-color: #f5f7fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-normal {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        .status-warning {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-danger {
            background-color: #f8d7da;
            color: #721c24;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading i {
            font-size: 24px;
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .report-content {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: 'Courier New', Courier, monospace;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .realtime-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .stats-filter {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1><i class="fas fa-leaf"></i> 智慧林草系统</h1>
                <p>环境监测和统计分析模块</p>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span id="current-time"></span>
                <span id="user-info" style="display: none;"></span>
                <button id="logout-btn" style="display: none; padding: 8px 16px; background-color: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    <i class="fas fa-sign-out-alt"></i> 退出登录
                </button>
            </div>
        </header>

        <!-- 导航标签 -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="realtime">
                <i class="fas fa-clock"></i> 实时数据
            </div>
            <div class="nav-tab" data-tab="regions">
                <i class="fas fa-map-marker-alt"></i> 区域管理
            </div>
            <div class="nav-tab" data-tab="sensors">
                <i class="fas fa-microchip"></i> 传感器管理
            </div>
            <div class="nav-tab" data-tab="environmental-data">
                <i class="fas fa-database"></i> 监测数据
            </div>
            <div class="nav-tab" data-tab="statistics">
                <i class="fas fa-chart-bar"></i> 统计分析
            </div>
            <div class="nav-tab" data-tab="trend">
                <i class="fas fa-chart-line"></i> 环境趋势
            </div>
            <div class="nav-tab" data-tab="air-quality">
                <i class="fas fa-wind"></i> 空气质量
            </div>
            <div class="nav-tab" data-tab="abnormal">
                <i class="fas fa-exclamation-triangle"></i> 异常数据
            </div>
            <div class="nav-tab" data-tab="sensor-summary">
                <i class="fas fa-chart-pie"></i> 传感器数据汇总
            </div>
            <div class="nav-tab" data-tab="region-daily-avg">
                <i class="fas fa-chart-area"></i> 区域日均值实图
            </div>
            <div class="nav-tab" data-tab="reports">
                <i class="fas fa-file-alt"></i> 报表生成
            </div>
            <div class="nav-tab" data-tab="login">
                <i class="fas fa-sign-in-alt"></i> 用户登录
            </div>
        </div>

        <!-- 实时数据标签页 -->
        <div id="realtime" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-tachometer-alt"></i> 实时环境数据</h3>
                    <button class="btn btn-primary" onclick="refreshRealtimeData()">
                        <i class="fas fa-sync"></i> 刷新
                    </button>
                </div>
                <div id="realtime-data" class="loading">
                    <i class="fas fa-spinner"></i> 加载中...
                </div>
            </div>
        </div>

        <!-- 统计分析标签页 -->
        <div id="statistics" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chart-pie"></i> 统计数据</h3>
                    <div class="stats-filter">
                        <button class="filter-btn active" data-period="daily">日统计</button>
                        <button class="filter-btn" data-period="weekly">周统计</button>
                        <button class="filter-btn" data-period="monthly">月统计</button>
                        <input type="date" id="stats-date" class="date-picker" value="">
                        <button class="btn btn-info" onclick="loadStatistics()">
                            <i class="fas fa-search"></i> 查询
                        </button>
                    </div>
                </div>
                <div id="statistics-content" class="loading">
                    <i class="fas fa-spinner"></i> 加载中...
                </div>
            </div>
        </div>

        <!-- 环境趋势标签页 -->
        <div id="trend" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chart-line"></i> 环境趋势分析</h3>
                    <div class="stats-filter">
                        <select id="station-select" class="filter-btn">
                            <option value="监测站1">监测站1</option>
                            <option value="监测站2">监测站2</option>
                            <option value="监测站3">监测站3</option>
                            <option value="监测站4">监测站4</option>
                        </select>
                        <select id="days-select" class="filter-btn">
                            <option value="7">最近7天</option>
                            <option value="14">最近14天</option>
                            <option value="30" selected>最近30天</option>
                        </select>
                        <button class="btn btn-info" onclick="loadEnvironmentalTrend()">
                            <i class="fas fa-chart-line"></i> 生成趋势图
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="trend-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- 空气质量标签页 -->
        <div id="air-quality" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-wind"></i> 空气质量监测</h3>
                    <div class="stats-filter">
                        <select id="air-station-select" class="filter-btn">
                            <option value="监测站3">监测站3</option>
                            <option value="监测站4">监测站4</option>
                        </select>
                        <select id="air-days-select" class="filter-btn">
                            <option value="7">最近7天</option>
                            <option value="14" selected>最近14天</option>
                            <option value="30">最近30天</option>
                        </select>
                        <button class="btn btn-info" onclick="loadAirQuality()">
                            <i class="fas fa-chart-bar"></i> 生成空气质量图
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="air-quality-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- 异常数据标签页 -->
        <div id="abnormal" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-exclamation-triangle"></i> 异常数据统计</h3>
                    <div class="stats-filter">
                        <select id="abnormal-days" class="filter-btn">
                            <option value="7">最近7天</option>
                            <option value="30" selected>最近30天</option>
                            <option value="90">最近90天</option>
                        </select>
                        <button class="btn btn-info" onclick="loadAbnormalData()">
                            <i class="fas fa-search"></i> 查询
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="abnormal-chart"></canvas>
                </div>
                <div id="abnormal-table" class="loading">
                    <i class="fas fa-spinner"></i> 加载中...
                </div>
            </div>
        </div>

        <!-- 区域管理标签页 -->
        <div id="regions" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-map-marker-alt"></i> 区域管理</h3>
                    <button class="btn btn-primary" onclick="openRegionModal()">
                        <i class="fas fa-plus"></i> 新增区域
                    </button>
                </div>
                <div class="stats-filter">
                    <select id="region-type-filter" class="filter-btn">
                        <option value="">全部类型</option>
                        <option value="森林">森林</option>
                        <option value="草地">草地</option>
                    </select>
                    <button class="btn btn-info" onclick="loadRegions()">
                        <i class="fas fa-search"></i> 查询
                    </button>
                </div>
                <div id="regions-table" class="loading">
                    <i class="fas fa-spinner"></i> 加载中...
                </div>
            </div>
        </div>

        <!-- 传感器管理标签页 -->
        <div id="sensors" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-microchip"></i> 传感器管理</h3>
                    <button class="btn btn-primary" onclick="openSensorModal()">
                        <i class="fas fa-plus"></i> 新增传感器
                    </button>
                </div>
                <div class="stats-filter">
                    <select id="sensor-region-filter" class="filter-btn">
                        <option value="">全部区域</option>
                    </select>
                    <select id="sensor-type-filter" class="filter-btn">
                        <option value="">全部类型</option>
                    </select>
                    <select id="sensor-status-filter" class="filter-btn">
                        <option value="">全部状态</option>
                        <option value="正常">正常</option>
                        <option value="故障">故障</option>
                        <option value="维护">维护</option>
                    </select>
                    <button class="btn btn-info" onclick="loadSensors()">
                        <i class="fas fa-search"></i> 查询
                    </button>
                </div>
                <div id="sensors-table" class="loading">
                    <i class="fas fa-spinner"></i> 加载中...
                </div>
            </div>
        </div>

        <!-- 监测数据标签页 -->
        <div id="environmental-data" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-database"></i> 监测数据管理</h3>
                    <button class="btn btn-primary" onclick="openDataModal()">
                        <i class="fas fa-plus"></i> 新增数据
                    </button>
                </div>
                <div class="stats-filter">
                    <select id="data-region-filter" class="filter-btn">
                        <option value="">全部区域</option>
                    </select>
                    <select id="data-sensor-filter" class="filter-btn">
                        <option value="">全部传感器</option>
                    </select>
                    <input type="text" id="data-sensor-code" class="filter-btn" placeholder="传感器编号">
                    <select id="data-status-filter" class="filter-btn">
                        <option value="">全部状态</option>
                        <option value="有效">有效</option>
                        <option value="无效">无效</option>
                    </select>
                    <input type="date" id="data-start-date" class="date-picker" placeholder="开始日期">
                    <input type="date" id="data-end-date" class="date-picker" placeholder="结束日期">
                    <button class="btn btn-info" onclick="loadEnvironmentalData()">
                        <i class="fas fa-search"></i> 查询
                    </button>
                </div>
                <div id="environmental-data-table" class="loading">
                    <i class="fas fa-spinner"></i> 加载中...
                </div>
            </div>
        </div>

        <!-- 传感器数据汇总标签页 -->
        <div id="sensor-summary" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chart-pie"></i> 传感器数据汇总</h3>
                    <div class="stats-filter">
                        <select id="sensor-summary-filter" class="filter-btn">
                            <option value="all">全部传感器</option>
                            <option value="温度">温度传感器</option>
                            <option value="湿度">湿度传感器</option>
                            <option value="PM2.5">PM2.5传感器</option>
                            <option value="PM10">PM10传感器</option>
                            <option value="风速">风速传感器</option>
                        </select>
                        <button class="btn btn-info" onclick="loadSensorSummary()">
                            <i class="fas fa-search"></i> 查询
                        </button>
                    </div>
                </div>
                <div id="sensor-summary-content" class="loading">
                    <i class="fas fa-spinner"></i> 加载中...
                </div>
            </div>
        </div>

        <!-- 区域日均值实图标签页 -->
        <div id="region-daily-avg" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chart-area"></i> 区域日均值实图</h3>
                    <div class="stats-filter">
                        <select id="region-daily-region" class="filter-btn">
                            <option value="全部区域">全部区域</option>
                            <option value="森林区域1">森林区域1</option>
                            <option value="草地区域1">草地区域1</option>
                            <option value="森林区域2">森林区域2</option>
                            <option value="草地区域2">草地区域2</option>
                            <option value="混合区域1">混合区域1</option>
                        </select>
                        <input type="date" id="region-daily-date" class="date-picker" value="">
                        <button class="btn btn-info" onclick="loadRegionDailyAvg()">
                            <i class="fas fa-chart-area"></i> 生成实图
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="region-daily-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- 报表生成标签页 -->
        <div id="reports" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-file-alt"></i> 报表生成</h3>
                    <div class="stats-filter">
                        <input type="date" id="report-date" class="date-picker" value="">
                        <button class="btn btn-success" onclick="generateDailyReport()">
                            <i class="fas fa-file-export"></i> 生成日报
                        </button>
                        <button class="btn btn-success" onclick="generateWeeklyReport()">
                            <i class="fas fa-file-export"></i> 生成周报
                        </button>
                    </div>
                </div>
                <div id="report-result">
                    <p>请选择日期并点击生成按钮</p>
                </div>
            </div>
        </div>

        <!-- 登录标签页 -->
        <div id="login" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-sign-in-alt"></i> 用户认证</h3>
                </div>
                <div class="login-container" style="max-width: 400px; margin: 20px auto;">
                    <!-- 切换标签 -->
                    <div style="display: flex; margin-bottom: 20px; border-bottom: 1px solid #eee;">
                        <button id="login-tab-btn" class="auth-tab-btn active" onclick="switchAuthTab('login')" style="flex: 1; padding: 10px; background: none; border: none; cursor: pointer; font-size: 16px; font-weight: 500; color: #3498db; border-bottom: 2px solid #3498db;">登录</button>
                        <button id="register-tab-btn" class="auth-tab-btn" onclick="switchAuthTab('register')" style="flex: 1; padding: 10px; background: none; border: none; cursor: pointer; font-size: 16px; font-weight: 500; color: #666;">注册</button>
                    </div>
                    
                    <!-- 登录表单 -->
                    <div id="login-form-container">
                        <form id="login-form">
                            <div style="margin-bottom: 15px;">
                                <label for="login-username" style="display: block; margin-bottom: 5px; font-weight: 500;">用户名:</label>
                                <input type="text" id="login-username" name="username" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="login-password" style="display: block; margin-bottom: 5px; font-weight: 500;">密码:</label>
                                <input type="password" id="login-password" name="password" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label for="login-role" style="display: block; margin-bottom: 5px; font-weight: 500;">角色:</label>
                                <select id="login-role" name="role" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                    <option value="管理员">管理员</option>
                                    <option value="普通用户">普通用户</option>
                                </select>
                            </div>
                            <div style="text-align: center; margin-top: 20px;">
                                <button type="submit" style="padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; background-color: #3498db; color: white; font-size: 16px;">
                                    <i class="fas fa-sign-in-alt"></i> 登录
                                </button>
                            </div>
                        </form>
                        <div id="login-status" style="margin-top: 20px; text-align: center;"></div>
                    </div>
                    
                    <!-- 注册表单 -->
                    <div id="register-form-container" style="display: none;">
                        <form id="register-form">
                            <div style="margin-bottom: 15px;">
                                <label for="register-username" style="display: block; margin-bottom: 5px; font-weight: 500;">用户名:</label>
                                <input type="text" id="register-username" name="username" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="register-password" style="display: block; margin-bottom: 5px; font-weight: 500;">密码:</label>
                                <input type="password" id="register-password" name="password" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="register-confirm-password" style="display: block; margin-bottom: 5px; font-weight: 500;">确认密码:</label>
                                <input type="password" id="register-confirm-password" name="confirm_password" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">角色:</label>
                                <input type="text" value="普通用户" readonly style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background-color: #f5f7fa;">
                                <input type="hidden" id="register-role" name="role" value="普通用户">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label for="register-email" style="display: block; margin-bottom: 5px; font-weight: 500;">邮箱 (可选):</label>
                                <input type="email" id="register-email" name="email" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label for="register-phone" style="display: block; margin-bottom: 5px; font-weight: 500;">电话 (可选):</label>
                                <input type="tel" id="register-phone" name="phone" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div style="text-align: center; margin-top: 20px;">
                                <button type="submit" style="padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; background-color: #2ecc71; color: white; font-size: 16px;">
                                    <i class="fas fa-user-plus"></i> 注册
                                </button>
                            </div>
                        </form>
                        <div id="register-status" style="margin-top: 20px; text-align: center;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 模态框 -->
        <div id="modal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
            <div class="modal-content" style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                    <h2 id="modal-title" style="margin: 0; font-size: 20px; color: #2c3e50;"></h2>
                    <span class="close" onclick="closeModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                </div>
                <div id="modal-body">
                    <!-- 模态框内容将通过JavaScript动态加载 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // API基础URL
        const API_BASE_URL = 'http://localhost:5000/api';
        
        // 全局图表实例
        let trendChart = null;
        let airQualityChart = null;
        let abnormalChart = null;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置当前时间
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // 设置默认日期
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('stats-date').value = today;
            document.getElementById('report-date').value = today;
            
            // 初始化标签切换
            initTabSwitching();
            
            // 加载初始数据
            loadRealtimeData();
            loadEnvironmentalTrend();
            loadAirQuality();
            loadAbnormalData();
            
            // 填充所有页面的下拉选择框
            loadAllFilters();
        });
        
        // 填充所有页面的下拉选择框
        function loadAllFilters() {
            // 填充监测数据页面的下拉选择框
            loadDataFilters();
            
            // 填充传感器管理页面的下拉选择框
            loadSensorFilters();
            
            // 填充区域日均值实图页面的下拉选择框
            loadRegionDailyFilters();
        }
        
        // 填充监测数据页面的下拉选择框
        function loadDataFilters() {
            loadDataRegionFilter();
            loadDataSensorFilter();
        }
        
        // 填充区域下拉选择框
        function loadDataRegionFilter() {
            const select = document.getElementById('data-region-filter');
            fetch(`${API_BASE_URL}/regions`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 清空现有选项，保留默认选项
                        const defaultOption = select.querySelector('option[value=""]');
                        select.innerHTML = '';
                        select.appendChild(defaultOption);
                        
                        // 添加区域选项
                        data.data.forEach(region => {
                            const option = document.createElement('option');
                            option.value = region.region_id;
                            option.textContent = region.region_name;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('加载区域数据失败:', error);
                });
        }
        
        // 填充传感器下拉选择框
        function loadDataSensorFilter() {
            const select = document.getElementById('data-sensor-filter');
            fetch(`${API_BASE_URL}/sensors`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 清空现有选项，保留默认选项
                        const defaultOption = select.querySelector('option[value=""]');
                        select.innerHTML = '';
                        select.appendChild(defaultOption);
                        
                        // 添加传感器选项
                        data.data.forEach(sensor => {
                            const option = document.createElement('option');
                            option.value = sensor.sensor_id;
                            option.textContent = sensor.sensor_code;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('加载传感器数据失败:', error);
                });
        }
        
        // 填充传感器管理页面的下拉选择框
        function loadSensorFilters() {
            loadSensorRegionFilter();
            loadSensorTypeFilter();
        }
        
        // 填充传感器管理页面的区域下拉选择框
        function loadSensorRegionFilter() {
            const select = document.getElementById('sensor-region-filter');
            fetch(`${API_BASE_URL}/regions`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 清空现有选项，保留默认选项
                        const defaultOption = select.querySelector('option[value=""]');
                        select.innerHTML = '';
                        select.appendChild(defaultOption);
                        
                        // 添加区域选项
                        data.data.forEach(region => {
                            const option = document.createElement('option');
                            option.value = region.region_id;
                            option.textContent = region.region_name;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('加载传感器区域数据失败:', error);
                });
        }
        
        // 填充传感器管理页面的类型下拉选择框
        function loadSensorTypeFilter() {
            const select = document.getElementById('sensor-type-filter');
            fetch(`${API_BASE_URL}/sensors`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 清空现有选项，保留默认选项
                        const defaultOption = select.querySelector('option[value=""]');
                        select.innerHTML = '';
                        select.appendChild(defaultOption);
                        
                        // 获取所有唯一的传感器类型
                        const types = [...new Set(data.data.map(sensor => sensor.monitoring_type))];
                        
                        // 添加类型选项
                        types.forEach(type => {
                            const option = document.createElement('option');
                            option.value = type;
                            option.textContent = type;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('加载传感器类型数据失败:', error);
                });
        }
        
        // 填充区域日均值实图页面的下拉选择框
        function loadRegionDailyFilters() {
            loadRegionDailyRegionFilter();
        }
        
        // 填充区域日均值实图页面的区域下拉选择框
        function loadRegionDailyRegionFilter() {
            const select = document.getElementById('region-daily-region');
            fetch(`${API_BASE_URL}/regions`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 清空现有选项，保留默认选项
                        const defaultOption = select.querySelector('option[value="全部区域"]');
                        select.innerHTML = '';
                        select.appendChild(defaultOption);
                        
                        // 添加区域选项
                        data.data.forEach(region => {
                            const option = document.createElement('option');
                            option.value = region.region_name;
                            option.textContent = region.region_name;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('加载区域日均值区域数据失败:', error);
                });
        }

        // 更新当前时间
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('zh-CN');
        }

        // 初始化标签切换
        function initTabSwitching() {
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有活动状态
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    // 添加当前活动状态
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        // 切换标签页的函数
        function switchTab(tabId) {
            // 移除所有活动状态
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // 添加当前活动状态
            const tab = document.querySelector(`.nav-tab[data-tab="${tabId}"]`);
            if (tab) {
                tab.classList.add('active');
            }
            document.getElementById(tabId).classList.add('active');
        }

        // 加载实时数据
        function loadRealtimeData() {
            fetch(`${API_BASE_URL}/realtime-data`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderRealtimeData(data.data);
                    } else {
                        document.getElementById('realtime-data').innerHTML = `<div class="alert alert-error">加载失败: ${data.error}</div>`;
                    }
                })
                .catch(error => {
                    document.getElementById('realtime-data').innerHTML = `<div class="alert alert-error">加载失败: ${error.message}</div>`;
                });
        }

        // 渲染实时数据
        function renderRealtimeData(data) {
            if (data.length === 0) {
                document.getElementById('realtime-data').innerHTML = '<div class="alert alert-warning">暂无实时数据</div>';
                return;
            }

            let html = '<div class="realtime-grid">';
            data.forEach(station => {
                html += `
                    <div class="data-card">
                        <h4>${station.station_name} <small>(${station.station_type})</small></h4>
                        <div style="margin-top: 15px;">
                            <div class="data-value">${station.temperature}<span class="data-unit">℃</span></div>
                            <div class="data-label">温度</div>
                        </div>
                        <div style="margin-top: 15px;">
                            <div class="data-value">${station.humidity}<span class="data-unit">%</span></div>
                            <div class="data-label">湿度</div>
                        </div>
                        <div style="margin-top: 15px;">
                            <div class="data-value">${station.wind_speed}<span class="data-unit">m/s</span></div>
                            <div class="data-label">风速</div>
                        </div>
                        <div style="margin-top: 15px; font-size: 12px; color: #999;">
                            更新时间: ${station.collection_time}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            document.getElementById('realtime-data').innerHTML = html;
        }

        // 刷新实时数据
        function refreshRealtimeData() {
            document.getElementById('realtime-data').innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> 刷新中...</div>';
            loadRealtimeData();
        }

        // 加载统计数据
        function loadStatistics() {
            const period = document.querySelector('.filter-btn.active').getAttribute('data-period');
            const date = document.getElementById('stats-date').value;
            let url = '';

            switch(period) {
                case 'daily':
                    url = `${API_BASE_URL}/daily-statistics?date=${date}`;
                    break;
                case 'weekly':
                    const week = getWeekNumber(new Date(date));
                    const year = new Date(date).getFullYear();
                    url = `${API_BASE_URL}/weekly-statistics?year=${year}&week=${week}`;
                    break;
                case 'monthly':
                    const yearMonth = date.split('-');
                    url = `${API_BASE_URL}/monthly-statistics?year=${yearMonth[0]}&month=${yearMonth[1]}`;
                    break;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderStatistics(data.data, period);
                    } else {
                        document.getElementById('statistics-content').innerHTML = `<div class="alert alert-error">加载失败: ${data.error}</div>`;
                    }
                })
                .catch(error => {
                    document.getElementById('statistics-content').innerHTML = `<div class="alert alert-error">加载失败: ${error.message}</div>`;
                });
        }

        // 渲染统计数据
        function renderStatistics(data, period) {
            if (data.length === 0) {
                document.getElementById('statistics-content').innerHTML = '<div class="alert alert-warning">暂无统计数据</div>';
                return;
            }

            let html = '<table>';
            html += `
                <thead>
                    <tr>
                        <th>站点名称</th>
                        <th>数据条数</th>
                        <th>平均温度</th>
                        <th>最高温度</th>
                        <th>最低温度</th>
                        <th>平均湿度</th>
                        <th>总降雨量</th>
                    </tr>
                </thead>
                <tbody>
            `;

            data.forEach(stat => {
                // 将值转换为数字类型，避免toFixed调用失败
                const avgTemp = parseFloat(stat.avg_temperature) || 0;
                const maxTemp = parseFloat(stat.max_temperature) || 0;
                const minTemp = parseFloat(stat.min_temperature) || 0;
                const avgHumidity = parseFloat(stat.avg_humidity) || 0;
                const totalRainfall = parseFloat(stat.total_rainfall) || 0;
                
                html += `
                    <tr>
                        <td>${stat.station_name}</td>
                        <td>${stat.data_count}</td>
                        <td>${avgTemp.toFixed(2)}℃</td>
                        <td>${maxTemp.toFixed(2)}℃</td>
                        <td>${minTemp.toFixed(2)}℃</td>
                        <td>${avgHumidity.toFixed(2)}%</td>
                        <td>${totalRainfall.toFixed(2)}mm</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('statistics-content').innerHTML = html;
        }

        // 加载环境趋势数据
        function loadEnvironmentalTrend() {
            const stationName = document.getElementById('station-select').value;
            const days = document.getElementById('days-select').value;

            fetch(`${API_BASE_URL}/environmental-trend?station_name=${stationName}&days=${days}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderEnvironmentalTrend(data.data, stationName);
                    } else {
                        console.error('加载环境趋势数据失败:', data.error);
                    }
                })
                .catch(error => {
                    console.error('加载环境趋势数据失败:', error);
                });
        }

        // 渲染环境趋势图表
        function renderEnvironmentalTrend(data, stationName) {
            const ctx = document.getElementById('trend-chart').getContext('2d');
            
            // 准备数据
            const dates = data.map(item => item.trend_date);
            const temperatures = data.map(item => {
                const temp = parseFloat(item.avg_temperature);
                return isNaN(temp) ? 0 : temp;
            });
            const humidity = data.map(item => {
                const hum = parseFloat(item.avg_humidity);
                return isNaN(hum) ? 0 : hum;
            });
            const rainfall = data.map(item => {
                const rain = parseFloat(item.total_rainfall);
                return isNaN(rain) ? 0 : rain;
            });

            // 销毁现有图表
            if (trendChart) {
                trendChart.destroy();
            }

            // 创建新图表
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: '平均温度 (℃)',
                            data: temperatures,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: '平均湿度 (%)',
                            data: humidity,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: '总降雨量 (mm)',
                            data: rainfall,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${stationName} - 环境趋势分析`,
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '温度/湿度'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '降雨量 (mm)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // 加载空气质量数据
        function loadAirQuality() {
            const stationName = document.getElementById('air-station-select').value;
            const days = document.getElementById('air-days-select').value;

            fetch(`${API_BASE_URL}/air-quality?station_name=${stationName}&days=${days}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderAirQuality(data.data, stationName);
                    } else {
                        console.error('加载空气质量数据失败:', data.error);
                    }
                })
                .catch(error => {
                    console.error('加载空气质量数据失败:', error);
                });
        }

        // 渲染空气质量图表
        function renderAirQuality(data, stationName) {
            const ctx = document.getElementById('air-quality-chart').getContext('2d');
            
            // 准备数据
            const dates = data.map(item => item.air_date);
            const pm25 = data.map(item => {
                const pm25Value = parseFloat(item.avg_pm25);
                return isNaN(pm25Value) ? 0 : pm25Value.toFixed(1);
            });
            const pm10 = data.map(item => {
                const pm10Value = parseFloat(item.avg_pm10);
                return isNaN(pm10Value) ? 0 : pm10Value.toFixed(1);
            });

            // 销毁现有图表
            if (airQualityChart) {
                airQualityChart.destroy();
            }

            // 创建新图表
            airQualityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'PM2.5 (μg/m³)',
                            data: pm25,
                            backgroundColor: '#e67e22'
                        },
                        {
                            label: 'PM10 (μg/m³)',
                            data: pm10,
                            backgroundColor: '#9b59b6'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${stationName} - 空气质量分析`,
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '浓度 (μg/m³)'
                            }
                        }
                    }
                }
            });
        }

        // 加载异常数据
        function loadAbnormalData() {
            const days = document.getElementById('abnormal-days').value;

            fetch(`${API_BASE_URL}/abnormal-data-statistics?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderAbnormalData(data.data);
                    } else {
                        if (data.error.includes('未登录')) {
                            // 显示登录提示
                            const abnormalTable = document.getElementById('abnormal-table');
                            abnormalTable.innerHTML = `
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i> 
                                    加载异常数据失败: ${data.error} <br>
                                    <button class="btn btn-primary" onclick="switchToLoginTab()" style="margin-top: 10px;">
                                        <i class="fas fa-sign-in-alt"></i> 前往登录
                                    </button>
                                </div>
                            `;
                        } else {
                            console.error('加载异常数据失败:', data.error);
                        }
                    }
                })
                .catch(error => {
                    console.error('加载异常数据失败:', error);
                });
        }

        // 切换到登录标签页
        function switchToLoginTab() {
            // 隐藏所有标签页
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有导航标签的active类
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示登录标签页
            const loginTabContent = document.getElementById('login');
            loginTabContent.classList.add('active');
            
            // 设置登录导航标签为active
            const loginNavTab = document.querySelector('.nav-tab[data-tab="login"]');
            loginNavTab.classList.add('active');
        }

        // 渲染异常数据
        function renderAbnormalData(data) {
            // 渲染图表
            renderAbnormalChart(data);
            
            // 渲染表格
            renderAbnormalTable(data);
        }

        // 渲染异常数据图表
        function renderAbnormalChart(data) {
            const ctx = document.getElementById('abnormal-chart').getContext('2d');
            
            // 按站点和异常类型分组统计
            const stationData = {};
            data.forEach(item => {
                if (!stationData[item.station_name]) {
                    stationData[item.station_name] = {};
                }
                stationData[item.station_name][item.abnormal_type] = item.abnormal_count;
            });

            // 准备图表数据
            const labels = Object.keys(stationData);
            const datasets = [];
            const abnormalTypes = [...new Set(data.map(item => item.abnormal_type))];
            
            // 颜色映射
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            
            abnormalTypes.forEach((type, index) => {
                datasets.push({
                    label: type,
                    data: labels.map(station => stationData[station][type] || 0),
                    backgroundColor: colors[index % colors.length]
                });
            });

            // 销毁现有图表
            if (abnormalChart) {
                abnormalChart.destroy();
            }

            // 创建新图表
            abnormalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '异常数据统计',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '异常数量'
                            }
                        }
                    }
                }
            });
        }

        // 渲染异常数据表格
        function renderAbnormalTable(data) {
            if (data.length === 0) {
                document.getElementById('abnormal-table').innerHTML = '<div class="alert alert-warning">暂无异常数据</div>';
                return;
            }

            let html = '<table>';
            html += `
                <thead>
                    <tr>
                        <th>站点名称</th>
                        <th>异常类型</th>
                        <th>异常数量</th>
                    </tr>
                </thead>
                <tbody>
            `;

            data.forEach(item => {
                html += `
                    <tr>
                        <td>${item.station_name}</td>
                        <td>${item.abnormal_type}</td>
                        <td><span class="status-badge status-danger">${item.abnormal_count}</span></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('abnormal-table').innerHTML = html;
        }

        // 生成日报
        function generateDailyReport() {
            const reportDate = document.getElementById('report-date').value;
            
            if (!reportDate) {
                document.getElementById('report-result').innerHTML = '<div class="alert alert-warning">请选择日期</div>';
                return;
            }

            document.getElementById('report-result').innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> 生成中...</div>';

            fetch(`${API_BASE_URL}/generate-daily-report?date=${reportDate}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('report-result').innerHTML = `
                            <div class="alert alert-success">报表生成成功</div>
                            <h4>日报内容</h4>
                            <div class="report-content">${data.data.report_content}</div>
                        `;
                    } else {
                        document.getElementById('report-result').innerHTML = `<div class="alert alert-error">生成失败: ${data.error}</div>`;
                    }
                })
                .catch(error => {
                    document.getElementById('report-result').innerHTML = `<div class="alert alert-error">生成失败: ${error.message}</div>`;
                });
        }

        // 辅助函数：获取周数
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // 初始化统计分析标签页的过滤按钮
        document.querySelectorAll('.filter-btn[data-period]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn[data-period]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                loadStatistics();
            });
        });

        // 区域管理函数
        function loadRegions() {
            const regionType = document.getElementById('region-type-filter').value;
            fetch(`${API_BASE_URL}/regions${regionType ? `?region_type=${regionType}` : ''}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderRegionsTable(data.data);
                    } else {
                        document.getElementById('regions-table').innerHTML = `<div class="alert alert-error">加载失败: ${data.error}</div>`;
                    }
                })
                .catch(error => {
                    document.getElementById('regions-table').innerHTML = `<div class="alert alert-error">加载失败: ${error.message}</div>`;
                });
        }

        function renderRegionsTable(regions) {
            if (regions.length === 0) {
                document.getElementById('regions-table').innerHTML = '<div class="alert alert-warning">暂无区域数据</div>';
                return;
            }

            let html = '<table>';
            html += `
                <thead>
                    <tr>
                        <th>区域ID</th>
                        <th>区域名称</th>
                        <th>区域类型</th>
                        <th>纬度</th>
                        <th>经度</th>
                        <th>负责人ID</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
            `;

            regions.forEach(region => {
                html += `
                    <tr>
                        <td>${region.region_id}</td>
                        <td>${region.region_name}</td>
                        <td>${region.region_type}</td>
                        <td>${region.latitude}</td>
                        <td>${region.longitude}</td>
                        <td>${region.manager_id || '-'}</td>
                        <td>
                            <button class="btn btn-primary" onclick="openRegionModal(${region.region_id})" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="btn btn-danger" onclick="deleteRegion(${region.region_id})" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('regions-table').innerHTML = html;
        }

        function openRegionModal(regionId = null) {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');

            modalTitle.textContent = regionId ? '编辑区域' : '新增区域';
            modalBody.innerHTML = `
                <form id="region-form">
                    <input type="hidden" id="region-id" value="${regionId || ''}">
                    <div style="margin-bottom: 15px;">
                        <label for="region-name" style="display: block; margin-bottom: 5px; font-weight: 500;">区域名称:</label>
                        <input type="text" id="region-name" name="region_name" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="region-type" style="display: block; margin-bottom: 5px; font-weight: 500;">区域类型:</label>
                        <select id="region-type" name="region_type" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="森林">森林</option>
                            <option value="草地">草地</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="region-latitude" style="display: block; margin-bottom: 5px; font-weight: 500;">纬度:</label>
                        <input type="number" id="region-latitude" name="latitude" step="0.000001" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="region-longitude" style="display: block; margin-bottom: 5px; font-weight: 500;">经度:</label>
                        <input type="number" id="region-longitude" name="longitude" step="0.000001" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="region-manager-id" style="display: block; margin-bottom: 5px; font-weight: 500;">负责人ID:</label>
                        <input type="number" id="region-manager-id" name="manager_id" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" onclick="closeModal()" style="padding: 10px 20px; margin-right: 10px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; background-color: white; font-size: 14px;">取消</button>
                        <button type="submit" style="padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; background-color: #3498db; color: white; font-size: 14px;">保存</button>
                    </div>
                </form>
            `;

            // 添加表单提交事件
            document.getElementById('region-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveRegion();
            });

            // 如果是编辑模式，填充现有数据
            if (regionId) {
                fetch(`${API_BASE_URL}/regions/${regionId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const region = data.data;
                            document.getElementById('region-name').value = region.region_name;
                            document.getElementById('region-type').value = region.region_type;
                            document.getElementById('region-latitude').value = region.latitude;
                            document.getElementById('region-longitude').value = region.longitude;
                            document.getElementById('region-manager-id').value = region.manager_id || '';
                        }
                    });
            }

            modal.style.display = 'block';
        }

        function saveRegion() {
            const regionId = document.getElementById('region-id').value;
            const regionName = document.getElementById('region-name').value;
            const regionType = document.getElementById('region-type').value;
            const latitude = document.getElementById('region-latitude').value;
            const longitude = document.getElementById('region-longitude').value;
            const managerId = document.getElementById('region-manager-id').value;

            const data = {
                region_name: regionName,
                region_type: regionType,
                latitude: parseFloat(latitude),
                longitude: parseFloat(longitude),
                manager_id: managerId ? parseInt(managerId) : null
            };

            const url = regionId ? `${API_BASE_URL}/regions/${regionId}` : `${API_BASE_URL}/regions`;
            const method = regionId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal();
                    loadRegions();
                    showAlert('操作成功', 'success');
                } else {
                    showAlert(`操作失败: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                showAlert(`操作失败: ${error.message}`, 'error');
            });
        }

        function deleteRegion(regionId) {
            if (confirm('确定要删除这个区域吗？')) {
                fetch(`${API_BASE_URL}/regions/${regionId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadRegions();
                        showAlert('删除成功', 'success');
                    } else {
                        showAlert(`删除失败: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    showAlert(`删除失败: ${error.message}`, 'error');
                });
            }
        }

        // 传感器管理函数
        function loadSensors() {
            const regionId = document.getElementById('sensor-region-filter').value;
            const sensorType = document.getElementById('sensor-type-filter').value;
            const status = document.getElementById('sensor-status-filter').value;

            let url = `${API_BASE_URL}/sensors`;
            const params = [];
            if (regionId) params.push(`region_id=${regionId}`);
            if (sensorType) params.push(`monitoring_type=${sensorType}`);
            if (status) params.push(`status=${status}`);
            if (params.length > 0) url += `?${params.join('&')}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderSensorsTable(data.data);
                    } else {
                        document.getElementById('sensors-table').innerHTML = `<div class="alert alert-error">加载失败: ${data.error}</div>`;
                    }
                })
                .catch(error => {
                    document.getElementById('sensors-table').innerHTML = `<div class="alert alert-error">加载失败: ${error.message}</div>`;
                });
        }

        function renderSensorsTable(sensors) {
            if (sensors.length === 0) {
                document.getElementById('sensors-table').innerHTML = '<div class="alert alert-warning">暂无传感器数据</div>';
                return;
            }

            let html = '<table>';
            html += `
                <thead>
                    <tr>
                        <th>传感器ID</th>
                        <th>传感器编号</th>
                        <th>区域ID</th>
                        <th>站点ID</th>
                        <th>监测类型</th>
                        <th>设备型号</th>
                        <th>安装时间</th>
                        <th>通信协议</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
            `;

            sensors.forEach(sensor => {
                html += `
                    <tr>
                        <td>${sensor.sensor_id}</td>
                        <td>${sensor.sensor_code}</td>
                        <td>${sensor.region_id}</td>
                        <td>${sensor.station_id}</td>
                        <td>${sensor.monitoring_type}</td>
                        <td>${sensor.device_model}</td>
                        <td>${sensor.installation_date}</td>
                        <td>${sensor.communication_protocol}</td>
                        <td><span class="status-badge status-${sensor.status === '正常' ? 'normal' : sensor.status === '故障' ? 'danger' : 'warning'}">${sensor.status}</span></td>
                        <td>
                            <button class="btn btn-primary" onclick="openSensorModal(${sensor.sensor_id})" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="btn btn-danger" onclick="deleteSensor(${sensor.sensor_id})" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('sensors-table').innerHTML = html;
        }

        function openSensorModal(sensorId = null) {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');

            modalTitle.textContent = sensorId ? '编辑传感器' : '新增传感器';
            modalBody.innerHTML = `
                <form id="sensor-form">
                    <input type="hidden" id="sensor-id" value="${sensorId || ''}">
                    <div style="margin-bottom: 15px;">
                        <label for="sensor-code" style="display: block; margin-bottom: 5px; font-weight: 500;">传感器编号:</label>
                        <input type="text" id="sensor-code" name="sensor_code" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="sensor-region-id" style="display: block; margin-bottom: 5px; font-weight: 500;">区域ID:</label>
                        <input type="number" id="sensor-region-id" name="region_id" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="sensor-station-id" style="display: block; margin-bottom: 5px; font-weight: 500;">站点ID:</label>
                        <input type="number" id="sensor-station-id" name="station_id" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="sensor-type" style="display: block; margin-bottom: 5px; font-weight: 500;">监测类型:</label>
                        <input type="text" id="sensor-type" name="monitoring_type" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="sensor-model" style="display: block; margin-bottom: 5px; font-weight: 500;">设备型号:</label>
                        <input type="text" id="sensor-model" name="device_model" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="sensor-install-date" style="display: block; margin-bottom: 5px; font-weight: 500;">安装时间:</label>
                        <input type="date" id="sensor-install-date" name="installation_date" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="sensor-protocol" style="display: block; margin-bottom: 5px; font-weight: 500;">通信协议:</label>
                        <input type="text" id="sensor-protocol" name="communication_protocol" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="sensor-status" style="display: block; margin-bottom: 5px; font-weight: 500;">状态:</label>
                        <select id="sensor-status" name="status" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="正常">正常</option>
                            <option value="故障">故障</option>
                            <option value="维护">维护</option>
                        </select>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" onclick="closeModal()" style="padding: 10px 20px; margin-right: 10px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; background-color: white; font-size: 14px;">取消</button>
                        <button type="submit" style="padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; background-color: #3498db; color: white; font-size: 14px;">保存</button>
                    </div>
                </form>
            `;

            // 添加表单提交事件
            document.getElementById('sensor-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSensor();
            });

            // 如果是编辑模式，填充现有数据
            if (sensorId) {
                fetch(`${API_BASE_URL}/sensors/${sensorId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const sensor = data.data;
                            document.getElementById('sensor-code').value = sensor.sensor_code;
                            document.getElementById('sensor-region-id').value = sensor.region_id;
                            document.getElementById('sensor-station-id').value = sensor.station_id;
                            document.getElementById('sensor-type').value = sensor.monitoring_type;
                            document.getElementById('sensor-model').value = sensor.device_model;
                            document.getElementById('sensor-install-date').value = sensor.installation_date;
                            document.getElementById('sensor-protocol').value = sensor.communication_protocol;
                            document.getElementById('sensor-status').value = sensor.status;
                        }
                    });
            }

            modal.style.display = 'block';
        }

        function saveSensor() {
            const sensorId = document.getElementById('sensor-id').value;
            const sensorCode = document.getElementById('sensor-code').value;
            const regionId = document.getElementById('sensor-region-id').value;
            const stationId = document.getElementById('sensor-station-id').value;
            const monitoringType = document.getElementById('sensor-type').value;
            const deviceModel = document.getElementById('sensor-model').value;
            const installationDate = document.getElementById('sensor-install-date').value;
            const communicationProtocol = document.getElementById('sensor-protocol').value;
            const status = document.getElementById('sensor-status').value;

            const data = {
                sensor_code: sensorCode,
                region_id: parseInt(regionId),
                station_id: parseInt(stationId),
                monitoring_type: monitoringType,
                device_model: deviceModel,
                installation_date: installationDate,
                communication_protocol: communicationProtocol,
                status: status
            };

            const url = sensorId ? `${API_BASE_URL}/sensors/${sensorId}` : `${API_BASE_URL}/sensors`;
            const method = sensorId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal();
                    loadSensors();
                    showAlert('操作成功', 'success');
                } else {
                    showAlert(`操作失败: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                showAlert(`操作失败: ${error.message}`, 'error');
            });
        }

        function deleteSensor(sensorId) {
            if (confirm('确定要删除这个传感器吗？')) {
                fetch(`${API_BASE_URL}/sensors/${sensorId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadSensors();
                        showAlert('删除成功', 'success');
                    } else {
                        showAlert(`删除失败: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    showAlert(`删除失败: ${error.message}`, 'error');
                });
            }
        }

        // 监测数据管理函数
        function loadEnvironmentalData() {
            const regionId = document.getElementById('data-region-filter').value;
            // 只使用sensor_code进行查询，不使用sensor_id
            const sensorCode = document.getElementById('data-sensor-code').value;
            const dataStatus = document.getElementById('data-status-filter').value;
            const startDate = document.getElementById('data-start-date').value;
            const endDate = document.getElementById('data-end-date').value;

            let url = `${API_BASE_URL}/environmental-data?`;
            const params = [];
            if (regionId) params.push(`region_id=${regionId}`);
            // 当sensorCode有值时，只使用sensor_code进行查询
            if (sensorCode) {
                params.push(`sensor_code=${sensorCode}`);
            } else {
                // 只有当sensorCode为空时，才使用sensor_id查询
                const sensorId = document.getElementById('data-sensor-filter').value;
                if (sensorId) params.push(`sensor_id=${sensorId}`);
            }
            if (dataStatus) params.push(`data_status=${dataStatus}`);
            if (startDate) params.push(`start_time=${startDate}T00:00:00`);
            if (endDate) params.push(`end_time=${endDate}T23:59:59`);
            url += params.join('&');

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderEnvironmentalDataTable(data.data);
                    } else {
                        document.getElementById('environmental-data-table').innerHTML = `<div class="alert alert-error">加载失败: ${data.error}</div>`;
                    }
                })
                .catch(error => {
                    document.getElementById('environmental-data-table').innerHTML = `<div class="alert alert-error">加载失败: ${error.message}</div>`;
                });
        }

        function renderEnvironmentalDataTable(data) {
            if (data.length === 0) {
                document.getElementById('environmental-data-table').innerHTML = '<div class="alert alert-warning">暂无监测数据</div>';
                return;
            }

            let html = '<table>';
            html += `
                <thead>
                    <tr>
                        <th>数据ID</th>
                        <th>传感器编号</th>
                        <th>监测类型</th>
                        <th>站点名称</th>
                        <th>区域名称</th>
                        <th>采集时间</th>
                        <th>温度</th>
                        <th>湿度</th>
                        <th>风速</th>
                        <th>数据状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
            `;

            data.forEach(item => {
                html += `
                    <tr>
                        <td>${item.data_id}</td>
                        <td>${item.sensor_code || '-'}</td>
                        <td>${item.monitoring_type || '-'}</td>
                        <td>${item.station_name}</td>
                        <td>${item.region_name}</td>
                        <td>${item.collection_time}</td>
                        <td>${item.temperature ? `${item.temperature}℃` : '-'}</td>
                        <td>${item.humidity ? `${item.humidity}%` : '-'}</td>
                        <td>${item.wind_speed ? `${item.wind_speed}m/s` : '-'}</td>
                        <td><span class="status-badge status-${item.data_status === '有效' ? 'normal' : 'danger'}">${item.data_status}</span></td>
                        <td>
                            <button class="btn btn-primary" onclick="editDataStatus(${item.data_id}, '${item.data_status}')" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;">
                                <i class="fas fa-edit"></i> 切换状态
                            </button>
                            <button class="btn btn-danger" onclick="deleteEnvironmentalData(${item.data_id})" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('environmental-data-table').innerHTML = html;
        }

        function openDataModal() {
            // 简化版的数据添加功能
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');

            modalTitle.textContent = '新增监测数据';
            modalBody.innerHTML = `
                <form id="data-form">
                    <p style="color: #666; margin-bottom: 15px;">监测数据通常由系统自动采集，手动添加功能暂未完全实现。</p>
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="button" onclick="closeModal()" style="padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; background-color: #3498db; color: white; font-size: 14px;">关闭</button>
                    </div>
                </form>
            `;

            modal.style.display = 'block';
        }

        function editDataStatus(dataId, currentStatus) {
            const newStatus = currentStatus === '有效' ? '无效' : '有效';
            if (confirm(`确定要将数据状态切换为${newStatus}吗？`)) {
                fetch(`${API_BASE_URL}/environmental-data/${dataId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ data_status: newStatus })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadEnvironmentalData();
                        showAlert('状态更新成功', 'success');
                    } else {
                        showAlert(`状态更新失败: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    showAlert(`状态更新失败: ${error.message}`, 'error');
                });
            }
        }

        function deleteEnvironmentalData(dataId) {
            if (confirm('确定要删除这条监测数据吗？')) {
                fetch(`${API_BASE_URL}/environmental-data/${dataId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadEnvironmentalData();
                        showAlert('删除成功', 'success');
                    } else {
                        showAlert(`删除失败: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    showAlert(`删除失败: ${error.message}`, 'error');
                });
            }
        }

        // 模态框函数
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // 点击模态框外部关闭模态框
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // 显示提示信息
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '10000';
            alertDiv.style.padding = '15px 20px';
            alertDiv.style.borderRadius = '6px';
            alertDiv.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
            alertDiv.style.transition = 'all 0.3s ease';
            
            document.body.appendChild(alertDiv);
            
            // 3秒后自动移除
            setTimeout(() => {
                alertDiv.style.opacity = '0';
                alertDiv.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(alertDiv);
                }, 300);
            }, 3000);
        }

        // 传感器数据汇总函数
        function loadSensorSummary() {
            const sensorType = document.getElementById('sensor-summary-filter').value;
            let url = `${API_BASE_URL}/sensor-summary`;
            if (sensorType !== 'all') {
                url += `?monitoring_type=${sensorType}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderSensorSummary(data.data);
                    } else {
                        document.getElementById('sensor-summary-content').innerHTML = `<div class="alert alert-error">加载失败: ${data.error}</div>`;
                    }
                })
                .catch(error => {
                    document.getElementById('sensor-summary-content').innerHTML = `<div class="alert alert-error">加载失败: ${error.message}</div>`;
                });
        }

        // 渲染传感器数据汇总
        function renderSensorSummary(data) {
            if (data.length === 0) {
                document.getElementById('sensor-summary-content').innerHTML = '<div class="alert alert-warning">暂无传感器数据汇总</div>';
                return;
            }

            let html = '<div class="realtime-grid">';
            data.forEach(sensor => {
                html += `
                    <div class="data-card">
                        <h4>${sensor.sensor_name} <small>(${sensor.monitoring_type})</small></h4>
                        <div style="margin-top: 15px;">
                            <div class="data-value">${sensor.data_count}<span class="data-unit">条数据</span></div>
                            <div class="data-label">数据总量</div>
                        </div>
                        <div style="margin-top: 15px;">
                            <div class="data-value">${sensor.avg_value}<span class="data-unit">${sensor.unit}</span></div>
                            <div class="data-label">平均值</div>
                        </div>
                        <div style="margin-top: 15px;">
                            <div class="data-value">${sensor.max_value}<span class="data-unit">${sensor.unit}</span></div>
                            <div class="data-label">最大值</div>
                        </div>
                        <div style="margin-top: 15px;">
                            <div class="data-value">${sensor.min_value}<span class="data-unit">${sensor.unit}</span></div>
                            <div class="data-label">最小值</div>
                        </div>
                        <div style="margin-top: 15px; font-size: 12px; color: #999;">
                            最新数据时间: ${sensor.last_update_time}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            document.getElementById('sensor-summary-content').innerHTML = html;
        }

        // 区域日均值实图函数
        function loadRegionDailyAvg() {
            const regionName = document.getElementById('region-daily-region').value;
            const selectedDate = document.getElementById('region-daily-date').value || new Date().toISOString().split('T')[0];

            fetch(`${API_BASE_URL}/region-daily-avg?region_name=${regionName}&date=${selectedDate}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderRegionDailyAvg(data.data, regionName, selectedDate);
                    } else {
                        console.error('加载区域日均值数据失败:', data.error);
                    }
                })
                .catch(error => {
                    console.error('加载区域日均值数据失败:', error);
                });
        }

        // 渲染区域日均值实图
        function renderRegionDailyAvg(data, regionName, date) {
            const ctx = document.getElementById('region-daily-chart').getContext('2d');
            
            // 准备数据
            const timePoints = data.map(item => item.collection_time);
            const temperatures = data.map(item => {
                const temp = parseFloat(item.temperature);
                return isNaN(temp) ? 0 : temp;
            });
            const humidity = data.map(item => {
                const hum = parseFloat(item.humidity);
                return isNaN(hum) ? 0 : hum;
            });
            const rainfall = data.map(item => {
                const rain = parseFloat(item.rainfall);
                return isNaN(rain) ? 0 : rain;
            });

            // 销毁现有图表
            if (window.regionDailyChart) {
                window.regionDailyChart.destroy();
            }

            // 创建新图表
            window.regionDailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timePoints,
                    datasets: [
                        {
                            label: '温度 (℃)',
                            data: temperatures,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: '湿度 (%)',
                            data: humidity,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: '降雨量 (mm)',
                            data: rainfall,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${regionName} - ${date} 日均值实图`,
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '温度/湿度'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '降雨量 (mm)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认日期
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('region-daily-date').value = today;
        });

        // 生成周报函数
        function generateWeeklyReport() {
            const reportDate = document.getElementById('report-date').value;
            if (!reportDate) {
                document.getElementById('report-result').innerHTML = '<div class="alert alert-warning">请选择日期</div>';
                return;
            }

            const date = new Date(reportDate);
            const year = date.getFullYear();
            const week = getWeekNumber(date);

            document.getElementById('report-result').innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> 生成中...</div>';

            fetch(`${API_BASE_URL}/generate-weekly-report?year=${year}&week=${week}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('report-result').innerHTML = `
                            <div class="alert alert-success">报表生成成功</div>
                            <h4>周报内容</h4>
                            <div class="report-content">${data.data.report_content}</div>
                        `;
                    } else {
                        document.getElementById('report-result').innerHTML = `<div class="alert alert-error">生成失败: ${data.error}</div>`;
                    }
                })
                .catch(error => {
                    document.getElementById('report-result').innerHTML = `<div class="alert alert-error">生成失败: ${error.message}</div>`;
                });
        }

        // 页面加载完成后加载初始数据
        document.addEventListener('DOMContentLoaded', function() {
            // 加载区域、传感器和监测数据
            loadRegions();
            loadSensors();
            loadEnvironmentalData();
        });

        // 登录和注册功能
        document.addEventListener('DOMContentLoaded', function() {
            // 登录表单事件监听
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleLogin();
                });
            }
            
            // 注册表单事件监听
            const registerForm = document.getElementById('register-form');
            if (registerForm) {
                registerForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleRegister();
                });
            }
        });

        // 切换登录/注册标签
        function switchAuthTab(tabName) {
            // 切换标签按钮样式
            document.querySelectorAll('.auth-tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.color = '#666';
                btn.style.borderBottom = 'none';
            });
            
            document.getElementById(tabName + '-tab-btn').classList.add('active');
            document.getElementById(tabName + '-tab-btn').style.color = '#3498db';
            document.getElementById(tabName + '-tab-btn').style.borderBottom = '2px solid #3498db';
            
            // 切换表单显示
            document.getElementById('login-form-container').style.display = tabName === 'login' ? 'block' : 'none';
            document.getElementById('register-form-container').style.display = tabName === 'register' ? 'block' : 'none';
        }

        // 处理登录
        function handleLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const role = document.getElementById('login-role').value;
            
            const loginStatus = document.getElementById('login-status');
            loginStatus.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> 登录中...</div>';

            fetch(`${API_BASE_URL}/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    password: password,
                    role: role
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loginStatus.innerHTML = '<div class="alert alert-success">登录成功！欢迎 ' + username + '</div>';
                    // 保存登录状态到本地存储
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('username', username);
                    localStorage.setItem('role', role);
                    
                    // 更新UI显示用户信息和注销按钮
                    checkCurrentUser();
                    
                    // 刷新页面
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    loginStatus.innerHTML = '<div class="alert alert-error">' + data.error + '</div>';
                }
            })
            .catch(error => {
                loginStatus.innerHTML = '<div class="alert alert-error">登录失败：' + error.message + '</div>';
            });
        }

        // 处理注册
        function handleRegister() {
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const role = document.getElementById('register-role').value;
            const email = document.getElementById('register-email').value;
            const phone = document.getElementById('register-phone').value;
            
            const registerStatus = document.getElementById('register-status');
            
            // 验证密码是否一致
            if (password !== confirmPassword) {
                registerStatus.innerHTML = '<div class="alert alert-error">密码和确认密码不一致</div>';
                return;
            }
            
            // 验证密码长度
            if (password.length < 6) {
                registerStatus.innerHTML = '<div class="alert alert-error">密码长度不能少于6位</div>';
                return;
            }
            
            registerStatus.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> 注册中...</div>';

            fetch(`${API_BASE_URL}/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    password: password,
                    role: role,
                    email: email,
                    phone: phone
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    registerStatus.innerHTML = '<div class="alert alert-success">注册成功！请登录</div>';
                    // 切换回登录表单
                    setTimeout(() => {
                        switchAuthTab('login');
                        // 清空注册表单
                        document.getElementById('register-form').reset();
                    }, 1500);
                } else {
                    registerStatus.innerHTML = '<div class="alert alert-error">' + data.error + '</div>';
                }
            })
            .catch(error => {
                registerStatus.innerHTML = '<div class="alert alert-error">注册失败：' + error.message + '</div>';
            });
        }

        // 检查登录状态
        function checkLoginStatus() {
            return localStorage.getItem('isLoggedIn') === 'true';
        }

        // 检查当前用户状态并显示相关信息
        function checkCurrentUser() {
            const userInfoElement = document.getElementById('user-info');
            const logoutBtnElement = document.getElementById('logout-btn');
            const loginTabElement = document.querySelector('.nav-tab[data-tab="login"]');
            const loginTabContentElement = document.getElementById('login');
            
            if (checkLoginStatus()) {
                const username = localStorage.getItem('username');
                const role = localStorage.getItem('role');
                userInfoElement.innerHTML = `欢迎, ${username} (${role})`;
                userInfoElement.style.display = 'inline';
                logoutBtnElement.style.display = 'inline-block';
                
                // 隐藏登录标签和登录标签页
                if (loginTabElement) {
                    loginTabElement.style.display = 'none';
                }
                if (loginTabContentElement) {
                    loginTabContentElement.style.display = 'none';
                }
                
                // 如果当前显示的是登录标签页，切换到实时数据标签页
                if (loginTabContentElement && loginTabContentElement.classList.contains('active')) {
                    switchTab('realtime');
                }
            } else {
                userInfoElement.style.display = 'none';
                logoutBtnElement.style.display = 'none';
                
                // 显示登录标签
                if (loginTabElement) {
                    loginTabElement.style.display = 'block';
                }
            }
        }

        // 处理注销
        function handleLogout() {
            if (confirm('确定要退出登录吗？')) {
                fetch(`${API_BASE_URL}/logout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 清除本地存储中的登录状态
                        localStorage.removeItem('isLoggedIn');
                        localStorage.removeItem('username');
                        localStorage.removeItem('role');
                        
                        // 更新UI
                        checkCurrentUser();
                        showAlert('注销成功', 'success');
                        
                        // 刷新页面
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        showAlert(`注销失败: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    // 即使API调用失败，也要清除本地状态
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('username');
                    localStorage.removeItem('role');
                    checkCurrentUser();
                    showAlert('注销失败: 网络错误', 'error');
                });
            }
        }

        // 页面加载完成后检查用户状态
        document.addEventListener('DOMContentLoaded', function() {
            checkCurrentUser();
            
            // 添加注销按钮事件监听
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
        });
    </script>
</body>
</html>