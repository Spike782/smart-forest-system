<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>æ™ºæ…§æ—è‰ - ç¾å®³é¢„è­¦æ¼”ç¤º</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial; margin: 0; background:#f6f7fb; }
    header { background:#111827; color:#fff; padding:14px 18px; display:flex; justify-content:space-between; align-items:center; }
    .wrap { max-width: 1100px; margin: 18px auto; padding: 0 14px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .card { background:#fff; border-radius:12px; box-shadow: 0 8px 24px rgba(0,0,0,.06); padding:14px; }
    .row { display:flex; gap:10px; flex-wrap: wrap; }
    input, select, textarea { padding:8px 10px; border:1px solid #d1d5db; border-radius:10px; outline:none; width: 100%; box-sizing: border-box; }
    button { padding:8px 12px; border:0; border-radius:10px; cursor:pointer; background:#111827; color:#fff; }
    button.secondary{ background:#374151; }
    button.danger { background:#b91c1c; }
    .muted { color:#6b7280; font-size: 12px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; font-size: 13px; vertical-align: top; }
    th { color:#374151; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#eef2ff; color:#3730a3; }
    .right { text-align:right; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
  </style>
</head>
<body>
<div id="app">
  <header>
    <div>ğŸŒ² æ™ºæ…§æ—è‰ç³»ç»Ÿ - ç¾å®³é¢„è­¦ï¼ˆå•é¡µæ¼”ç¤ºï¼‰</div>
    <div v-if="token" class="muted">
      ç™»å½•ç”¨æˆ·ï¼š{{ me?.username }}ï¼ˆ{{ me?.role }}ï¼‰
      <button class="secondary" style="margin-left:10px" @click="logout">é€€å‡º</button>
    </div>
  </header>

  <div class="wrap">
    <div v-if="!token" class="card" style="max-width:520px;margin:20px auto;">
      <h3>ç™»å½•</h3>
      <div class="row">
        <div style="flex:1">
          <div class="muted">ç”¨æˆ·å</div>
          <input v-model="loginForm.username" placeholder="admin / ranger"/>
        </div>
        <div style="flex:1">
          <div class="muted">å¯†ç </div>
          <input v-model="loginForm.password" type="password" placeholder="ç¨ååœ¨æ­¥éª¤é‡Œè®¾ç½®"/>
        </div>
      </div>
      <div style="margin-top:10px" class="row">
        <button @click="doLogin">ç™»å½•</button>
        <div class="muted" style="padding-top:10px">
          é¦–æ¬¡éœ€è¦ç”¨åç«¯æ¥å£ç»™ admin / ranger è®¾ç½®å¯†ç ï¼ˆä¸‹é¢æ­¥éª¤ä¼šæ•™ï¼‰
        </div>
      </div>
      <div v-if="err" style="margin-top:8px;color:#b91c1c">{{ err }}</div>
    </div>

    <div v-else class="grid">
      <!-- å·¦ï¼šç›‘æµ‹æ•°æ® + é¢„è­¦åˆ—è¡¨ -->
      <div class="card">
        <h3>1) æ’å…¥ç›‘æµ‹æ•°æ®ï¼ˆDBè§¦å‘å™¨è‡ªåŠ¨ç”Ÿæˆé¢„è­¦/é€šçŸ¥ï¼‰</h3>
        <div class="row">
          <div style="flex:1">
            <div class="muted">åŒºåŸŸ</div>
            <select v-model="reading.area_id">
              <option v-for="a in areas" :value="a.area_id">{{ a.area_id }} - {{ a.area_name }}</option>
            </select>
          </div>
          <div style="flex:1">
            <div class="muted">æ¸©åº¦(â„ƒ)</div>
            <input v-model.number="reading.temperature" type="number" step="0.01" placeholder="ä¾‹å¦‚ 39"/>
          </div>
          <div style="flex:1">
            <div class="muted">æ¹¿åº¦(%)</div>
            <input v-model.number="reading.humidity" type="number" step="0.01" placeholder="ä¾‹å¦‚ 19"/>
          </div>
        </div>
        <div style="margin-top:10px" class="row">
          <button @click="submitReading">æäº¤ç›‘æµ‹æ•°æ®</button>
          <button class="secondary" @click="loadWarnings">åˆ·æ–°é¢„è­¦åˆ—è¡¨</button>
          <button class="secondary" @click="loadMyNotifications">åˆ·æ–°æˆ‘çš„é€šçŸ¥</button>
        </div>
        <div class="muted" style="margin-top:6px">
          è§¦å‘æ¡ä»¶ç¤ºä¾‹ï¼šç«ç¾è§„åˆ™å­˜çš„æ˜¯ JSON å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ <span class="mono">{"temp_gte":38,"hum_lte":20}</span>
        </div>

        <hr style="border:none;border-top:1px solid #eee;margin:14px 0"/>

        <h3>2) é¢„è­¦åˆ—è¡¨ï¼ˆæœ€å¤š200æ¡ï¼‰</h3>
        <div class="row">
          <div style="flex:1">
            <div class="muted">æŒ‰å¤„ç†çŠ¶æ€è¿‡æ»¤</div>
            <select v-model="filter.handle_status">
              <option value="">å…¨éƒ¨</option>
              <option value="0">æœªå¤„ç†</option>
              <option value="1">å¤„ç†ä¸­</option>
              <option value="2">å·²ç»“æ¡ˆ</option>
            </select>
          </div>
          <div style="flex:1">
            <div class="muted">æŒ‰åŒºåŸŸè¿‡æ»¤</div>
            <select v-model="filter.area_id">
              <option value="">å…¨éƒ¨</option>
              <option v-for="a in areas" :value="a.area_id">{{ a.area_id }} - {{ a.area_name }}</option>
            </select>
          </div>
          <div style="align-self:end">
            <button class="secondary" @click="loadWarnings">æŸ¥è¯¢</button>
          </div>
        </div>

        <div style="overflow:auto;margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>åŒºåŸŸ</th>
                <th>ç±»å‹/çº§åˆ«</th>
                <th>å†…å®¹</th>
                <th>æ—¶é—´</th>
                <th>çŠ¶æ€</th>
                <th class="right">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="w in warnings" :key="w.warning_id">
                <td>{{ w.warning_id }}</td>
                <td>{{ w.area_id }}<div class="muted">{{ w.area_name }}</div></td>
                <td><span class="badge">{{ w.warning_type }}</span> L{{ w.warning_level }}</td>
                <td>{{ w.warning_content }}</td>
                <td class="mono">{{ w.trigger_time }}</td>
                <td>
                  <span v-if="w.handle_status===0" class="badge">æœªå¤„ç†</span>
                  <span v-else-if="w.handle_status===1" class="badge">å¤„ç†ä¸­</span>
                  <span v-else class="badge">å·²ç»“æ¡ˆ</span>
                  <div class="muted" v-if="w.handler_id">å¤„ç†äººï¼š{{ w.handler_id }}</div>
                </td>
                <td class="right">
                  <button class="secondary" @click="openHandle(w)">å¤„ç†</button>
                </td>
              </tr>
              <tr v-if="warnings.length===0"><td colspan="7" class="muted">æš‚æ— æ•°æ®</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- å³ï¼šé€šçŸ¥ + ç®¡ç†è§„åˆ™ -->
      <div class="card">
        <h3>3) æˆ‘çš„é€šçŸ¥</h3>
        <div class="muted">receive_statusï¼š0æœªæ¥æ”¶ / 1å·²æ¥æ”¶ / 2å·²è¯»</div>
        <div style="overflow:auto;margin-top:8px; max-height:260px">
          <table>
            <thead>
              <tr>
                <th>é€šçŸ¥ID</th>
                <th>é¢„è­¦ID</th>
                <th>å†…å®¹</th>
                <th>çŠ¶æ€</th>
                <th class="right">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="n in notifications" :key="n.notification_id">
                <td>{{ n.notification_id }}</td>
                <td>{{ n.warning_id }}</td>
                <td style="max-width:340px">{{ n.warning_content }}</td>
                <td>{{ n.receive_status }}</td>
                <td class="right">
                  <button class="secondary" @click="setNotify(n,1)">æ¥æ”¶</button>
                  <button class="secondary" @click="setNotify(n,2)">å·²è¯»</button>
                </td>
              </tr>
              <tr v-if="notifications.length===0"><td colspan="5" class="muted">æš‚æ— é€šçŸ¥</td></tr>
            </tbody>
          </table>
        </div>

        <hr style="border:none;border-top:1px solid #eee;margin:14px 0"/>

        <div v-if="me?.role==='admin'">
          <h3>4) é¢„è­¦è§„åˆ™ç®¡ç†ï¼ˆä»… adminï¼‰</h3>
          <div class="row">
            <div style="flex:1">
              <div class="muted">ç±»å‹</div>
              <input v-model="ruleForm.warning_type" placeholder="ç«ç¾/æ—±æƒ…/ç—…è™«å®³..."/>
            </div>
            <div style="flex:1">
              <div class="muted">çº§åˆ«(1-4)</div>
              <select v-model.number="ruleForm.warning_level">
                <option :value="1">1 ä¸€èˆ¬</option>
                <option :value="2">2 è¾ƒé‡</option>
                <option :value="3">3 ä¸¥é‡</option>
                <option :value="4">4 ç‰¹åˆ«ä¸¥é‡</option>
              </select>
            </div>
            <div style="flex:1">
              <div class="muted">çŠ¶æ€</div>
              <select v-model.number="ruleForm.status">
                <option :value="1">å¯ç”¨</option>
                <option :value="0">ç¦ç”¨</option>
              </select>
            </div>
          </div>
          <div style="margin-top:8px">
            <div class="muted">è§¦å‘æ¡ä»¶(JSONå­—ç¬¦ä¸²)</div>
            <input v-model="ruleForm.trigger_condition" class="mono" placeholder='{"temp_gte":38,"hum_lte":20}'/>
          </div>
          <div style="margin-top:10px" class="row">
            <button @click="saveRule">{{ ruleForm.rule_id ? 'æ›´æ–°è§„åˆ™' : 'æ–°å¢è§„åˆ™' }}</button>
            <button class="secondary" @click="clearRule">æ¸…ç©º</button>
            <button class="secondary" @click="loadRules">åˆ·æ–°è§„åˆ™åˆ—è¡¨</button>
          </div>

          <div style="overflow:auto;margin-top:10px; max-height:280px">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>ç±»å‹</th>
                  <th>æ¡ä»¶</th>
                  <th>çº§åˆ«</th>
                  <th>çŠ¶æ€</th>
                  <th class="right">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="r in rules" :key="r.rule_id">
                  <td>{{ r.rule_id }}</td>
                  <td>{{ r.warning_type }}</td>
                  <td class="mono" style="max-width:280px">{{ r.trigger_condition }}</td>
                  <td>{{ r.warning_level }}</td>
                  <td>{{ r.status }}</td>
                  <td class="right">
                    <button class="secondary" @click="editRule(r)">ç¼–è¾‘</button>
                    <button class="danger" v-if="r.status===1" @click="toggleRule(r,0)">ç¦ç”¨</button>
                    <button v-else class="secondary" @click="toggleRule(r,1)">å¯ç”¨</button>
                  </td>
                </tr>
                <tr v-if="rules.length===0"><td colspan="6" class="muted">æš‚æ— è§„åˆ™</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div v-else class="muted">
          ä½ å½“å‰ä¸æ˜¯ adminï¼Œè§„åˆ™ç®¡ç†åŒºéšè—ã€‚
        </div>
      </div>
    </div>
  </div>

  <!-- å¤„ç†é¢„è­¦å¼¹çª—ï¼ˆç®€å•å®ç°ï¼‰ -->
  <div v-if="handleModal.show" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:14px;">
    <div class="card" style="width:720px;max-width:95vw;">
      <h3>å¤„ç†é¢„è­¦ #{{ handleModal.warning?.warning_id }}</h3>
      <div class="muted">å†…å®¹ï¼š{{ handleModal.warning?.warning_content }}</div>
      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <div class="muted">å¤„ç†çŠ¶æ€</div>
          <select v-model.number="handleModal.form.handle_status">
            <option :value="0">æœªå¤„ç†</option>
            <option :value="1">å¤„ç†ä¸­</option>
            <option :value="2">å·²ç»“æ¡ˆ</option>
          </select>
        </div>
        <div style="flex:2">
          <div class="muted">å¤„ç†ç»“æœï¼ˆå¯é€‰ï¼‰</div>
          <input v-model="handleModal.form.handle_result" placeholder="ä¾‹å¦‚ï¼šå·²æ´¾äººå·¡æŸ¥ï¼Œæœªå‘ç°æ˜ç«"/>
        </div>
      </div>
      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button class="secondary" @click="handleModal.show=false">å–æ¶ˆ</button>
        <button @click="submitHandle">æäº¤</button>
      </div>
    </div>
  </div>

</div>

<script>
const { createApp } = Vue;

createApp({
  data(){
    return {
      API: "http://127.0.0.1:8000",
      token: localStorage.getItem("token") || "",
      me: JSON.parse(localStorage.getItem("me") || "null"),
      err: "",

      loginForm: { username: "admin", password: "" },

      areas: [],
      reading: { area_id: "A001", temperature: 39, humidity: 19 },

      filter: { area_id: "", handle_status: "" },
      warnings: [],

      notifications: [],

      rules: [],
      ruleForm: { rule_id: null, warning_type: "ç«ç¾", trigger_condition: '{"temp_gte":38,"hum_lte":20}', warning_level: 3, status: 1 },

      handleModal: { show:false, warning:null, form:{ handle_status:1, handle_result:"" } }
    }
  },
  methods:{
    api(){
      const headers = this.token ? { Authorization: "Bearer " + this.token } : {};
      return axios.create({ baseURL: this.API, headers });
    },
    async doLogin(){
      this.err = "";
      try{
        const res = await axios.post(this.API + "/api/auth/login", this.loginForm);
        this.token = res.data.token;
        this.me = res.data.user;
        localStorage.setItem("token", this.token);
        localStorage.setItem("me", JSON.stringify(this.me));
        await this.bootstrap();
      }catch(e){
        this.err = e?.response?.data?.detail || e.message;
      }
    },
    logout(){
      this.token = "";
      this.me = null;
      localStorage.removeItem("token");
      localStorage.removeItem("me");
      location.reload();
    },
    async bootstrap(){
      await this.loadAreas();
      await this.loadWarnings();
      await this.loadMyNotifications();
      if(this.me?.role === 'admin') await this.loadRules();
    },
    async loadAreas(){
      const res = await this.api().get("/api/areas");
      this.areas = res.data;
      if(this.areas.length && !this.reading.area_id) this.reading.area_id = this.areas[0].area_id;
    },
    async submitReading(){
      await this.api().post("/api/monitoring/reading", this.reading);
      await this.loadWarnings();
      await this.loadMyNotifications();
      alert("å·²å†™å…¥ç›‘æµ‹æ•°æ®ï¼ˆè‹¥å‘½ä¸­è§„åˆ™ï¼ŒDBè§¦å‘å™¨å·²è‡ªåŠ¨ç”Ÿæˆé¢„è­¦/é€šçŸ¥ï¼‰");
    },
    async loadWarnings(){
      const params = {};
      if(this.filter.area_id) params.area_id = this.filter.area_id;
      if(this.filter.handle_status !== "") params.handle_status = Number(this.filter.handle_status);
      const res = await this.api().get("/api/warnings", { params });
      this.warnings = res.data;
    },
    openHandle(w){
      this.handleModal.warning = w;
      this.handleModal.form = { handle_status: w.handle_status === 0 ? 1 : w.handle_status, handle_result: w.handle_result || "" };
      this.handleModal.show = true;
    },
    async submitHandle(){
      const wid = this.handleModal.warning.warning_id;
      await this.api().put(`/api/warnings/${wid}/handle`, this.handleModal.form);
      this.handleModal.show = false;
      await this.loadWarnings();
    },
    async loadMyNotifications(){
      const res = await this.api().get("/api/notifications/my");
      this.notifications = res.data;
    },
    async setNotify(n, s){
      await this.api().put(`/api/notifications/${n.notification_id}/status`, { receive_status: s });
      await this.loadMyNotifications();
    },

    // admin rules
    async loadRules(){
      const res = await this.api().get("/api/rules");
      this.rules = res.data;
    },
    editRule(r){
      this.ruleForm = {
        rule_id: r.rule_id,
        warning_type: r.warning_type,
        trigger_condition: r.trigger_condition,
        warning_level: r.warning_level,
        status: r.status
      }
    },
    clearRule(){
      this.ruleForm = { rule_id: null, warning_type: "ç«ç¾", trigger_condition: '{"temp_gte":38,"hum_lte":20}', warning_level: 3, status: 1 };
    },
    async saveRule(){
      if(!this.ruleForm.warning_type || !this.ruleForm.trigger_condition) return alert("ç±»å‹/æ¡ä»¶ä¸èƒ½ä¸ºç©º");
      if(this.ruleForm.rule_id){
        await this.api().put(`/api/rules/${this.ruleForm.rule_id}`, this.ruleForm);
      }else{
        await this.api().post(`/api/rules`, this.ruleForm);
      }
      await this.loadRules();
      this.clearRule();
    },
    async toggleRule(r, status){
      await this.api().put(`/api/rules/${r.rule_id}/status`, { status });
      await this.loadRules();
    }
  },
  async mounted(){
    if(this.token){
      try{
        // tokenæ²¡è¿‡æœŸå°±åˆå§‹åŒ–
        await this.bootstrap();
      }catch(e){
        // tokenè¿‡æœŸ/æ— æ•ˆ
        this.logout();
      }
    }
  }
}).mount("#app");
</script>
</body>
</html>
