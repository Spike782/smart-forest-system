# 环境监测系统数据库结构文档

## 1. 数据库概述

环境监测系统数据库（smart_forest_grass）用于存储和管理智慧林草环境监测系统的各类数据，包括监测站点信息、环境监测数据、统计分析数据、异常数据、报表信息以及系统管理数据等。该数据库支持实时数据采集、历史数据查询、统计分析、异常检测、报表生成等核心功能。

## 2. 实体关系图

已生成ER图文件：`环境监测系统ER图.svg`，位于项目根目录。

## 3. 表结构详情

### 3.1 监测站表（monitoring_station）

**功能**：存储环境监测站点的基本信息。

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| station_id | INT | PRIMARY KEY AUTO_INCREMENT | 监测站ID |
| station_name | VARCHAR(100) | NOT NULL | 监测站名称 |
| station_type | VARCHAR(50) | NOT NULL | 监测站类型 |
| location | VARCHAR(255) | NOT NULL | 监测站位置 |
| status | VARCHAR(20) | NOT NULL DEFAULT '正常' | 监测站状态（正常、故障、维护） |
| installation_date | DATE | NOT NULL | 安装日期 |
| longitude | DECIMAL(10, 6) | | 经度 |
| latitude | DECIMAL(10, 6) | | 纬度 |
| description | TEXT | | 站点描述 |

### 3.2 环境数据表（environmental_data）

**功能**：存储从监测站采集的实时环境数据。

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| data_id | INT | PRIMARY KEY AUTO_INCREMENT | 数据ID |
| station_id | INT | NOT NULL, FOREIGN KEY REFERENCES monitoring_station(station_id) | 监测站ID |
| collection_time | DATETIME | NOT NULL | 数据采集时间 |
| temperature | DECIMAL(5, 2) | | 温度（℃） |
| humidity | DECIMAL(5, 2) | | 湿度（%） |
| wind_speed | DECIMAL(5, 2) | | 风速（m/s） |
| wind_direction | VARCHAR(10) | | 风向 |
| rainfall | DECIMAL(8, 2) | | 降雨量（mm） |
| sunshine_duration | DECIMAL(5, 2) | | 日照时长（h） |
| soil_temperature | DECIMAL(5, 2) | | 土壤温度（℃） |
| soil_humidity | DECIMAL(5, 2) | | 土壤湿度（%） |
| soil_ph | DECIMAL(4, 2) | | 土壤pH值 |
| pm25 | DECIMAL(6, 2) | | PM2.5（μg/m³） |
| pm10 | DECIMAL(6, 2) | | PM10（μg/m³） |
| create_time | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 数据创建时间 |

**索引**：
- `idx_station_time` (station_id, collection_time)

### 3.3 统计数据表（statistical_data）

**功能**：存储按不同时间段统计的环境数据摘要。

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| stat_id | INT | PRIMARY KEY AUTO_INCREMENT | 统计ID |
| station_id | INT | NOT NULL, FOREIGN KEY REFERENCES monitoring_station(station_id) | 监测站ID |
| stat_period | VARCHAR(10) | NOT NULL | 统计周期（日、周、月、季、年） |
| stat_date | DATE | NOT NULL | 统计日期 |
| avg_temperature | DECIMAL(5, 2) | | 平均温度 |
| max_temperature | DECIMAL(5, 2) | | 最高温度 |
| min_temperature | DECIMAL(5, 2) | | 最低温度 |
| avg_humidity | DECIMAL(5, 2) | | 平均湿度 |
| total_rainfall | DECIMAL(8, 2) | | 总降雨量 |
| avg_wind_speed | DECIMAL(5, 2) | | 平均风速 |
| data_source | VARCHAR(50) | NOT NULL DEFAULT 'system' | 数据来源 |
| update_time | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引**：
- `idx_station_period_date` (station_id, stat_period, stat_date)

### 3.4 异常数据表（abnormal_data）

**功能**：存储检测到的异常环境数据信息。

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| abnormal_id | INT | PRIMARY KEY AUTO_INCREMENT | 异常ID |
| data_id | INT | NOT NULL, FOREIGN KEY REFERENCES environmental_data(data_id) | 关联的环境数据ID |
| abnormal_type | VARCHAR(50) | NOT NULL | 异常类型 |
| abnormal_description | TEXT | NOT NULL | 异常描述 |
| detection_time | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 检测时间 |
| processing_status | VARCHAR(20) | DEFAULT '未处理' | 处理状态（未处理、处理中、已处理） |
| processing_time | TIMESTAMP | | 处理时间 |
| processed_by | VARCHAR(50) | | 处理人 |

### 3.5 报表模板表（report_template）

**功能**：存储各类报表的模板信息。

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| template_id | INT | PRIMARY KEY AUTO_INCREMENT | 模板ID |
| template_name | VARCHAR(100) | NOT NULL | 模板名称 |
| template_content | TEXT | NOT NULL | 模板内容 |
| create_time | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 3.6 生成的报表表（generated_report）

**功能**：存储系统生成的各类报表记录。

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| report_id | INT | PRIMARY KEY AUTO_INCREMENT | 报表ID |
| template_id | INT | NOT NULL, FOREIGN KEY REFERENCES report_template(template_id) | 报表模板ID |
| report_name | VARCHAR(200) | NOT NULL | 报表名称 |
| generate_time | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 生成时间 |
| report_content | LONGTEXT | NOT NULL | 报表内容 |
| generated_by | VARCHAR(50) | NOT NULL | 生成人 |

### 3.7 系统用户表（system_user）

**功能**：存储系统用户信息。

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| user_id | INT | PRIMARY KEY AUTO_INCREMENT | 用户ID |
| username | VARCHAR(50) | NOT NULL UNIQUE | 用户名 |
| password | VARCHAR(255) | NOT NULL | 密码（加密存储） |
| role | VARCHAR(20) | NOT NULL | 角色（管理员、操作员、访客） |
| email | VARCHAR(100) | | 邮箱 |
| phone | VARCHAR(20) | | 电话 |
| create_time | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| last_login_time | TIMESTAMP | | 最后登录时间 |

### 3.8 操作日志表（operation_log）

**功能**：记录系统的操作日志信息。

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| log_id | INT | PRIMARY KEY AUTO_INCREMENT | 日志ID |
| user_id | INT | FOREIGN KEY REFERENCES system_user(user_id) | 用户ID |
| operation_type | VARCHAR(50) | NOT NULL | 操作类型 |
| operation_content | TEXT | NOT NULL | 操作内容 |
| operation_time | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 操作时间 |
| ip_address | VARCHAR(50) | | IP地址 |

## 4. 视图定义

系统中定义了多个视图用于简化数据查询和权限控制：

### 4.1 v_environmental_data_overview
环境数据概览视图，提供监测站点和环境数据的关联查询。

### 4.2 v_station_statistics
站点统计视图，展示各监测站点的统计数据。

### 4.3 v_abnormal_data
异常数据视图，关联展示异常数据及其对应的环境数据。

### 4.4 v_admin_environmental_data / v_user_environmental_data / v_guest_environmental_data
不同权限级别的环境数据视图，用于数据访问控制。

### 4.5 v_realtime_data
实时数据视图，专门用于展示最新的环境监测数据。

### 4.6 v_environmental_trend
环境趋势视图，用于分析环境数据的变化趋势。

### 4.7 v_air_quality
空气质量视图，专注于空气污染物数据的展示。

## 5. 存储过程

### 5.1 数据统计类存储过程

1. **sp_statistics_daily(p_stat_date DATE)**：按日统计环境数据。
2. **sp_statistics_weekly(p_stat_year INT, p_stat_week INT)**：按周统计环境数据。
3. **sp_statistics_monthly(p_stat_year INT, p_stat_month INT)**：按月统计环境数据。
4. **sp_statistics_quarterly(p_stat_year INT, p_stat_quarter INT)**：按季度统计环境数据。
5. **sp_statistics_yearly(p_stat_year INT)**：按年统计环境数据。
6. **sp_statistics_batch(p_start_date DATE, p_end_date DATE)**：批量执行不同时间段的统计。

### 5.2 异常数据处理类存储过程

1. **sp_detect_abnormal_data()**：检测环境数据中的异常值。
2. **sp_process_abnormal_data(p_abnormal_id INT, p_processing_status VARCHAR(20), p_processed_by VARCHAR(50))**：更新异常数据的处理状态。

### 5.3 报表生成类存储过程

1. **sp_generate_daily_report(p_report_date DATE)**：生成每日环境监测报表。
2. **sp_generate_weekly_report(p_year INT, p_week INT)**：生成每周环境统计报表。
3. **sp_generate_monthly_report(p_year INT, p_month INT)**：生成每月环境分析报表。

### 5.4 数据管理类存储过程

1. **sp_clean_history_data(p_before_date DATE)**：清理指定时间之前的历史数据。
2. **sp_backup_data(p_backup_date DATE)**：备份环境监测数据到备份表。
3. **sp_restore_data(p_backup_id INT)**：从备份表恢复环境监测数据。

### 5.5 系统管理类存储过程

1. **sp_get_system_status()**：获取系统运行状态信息。
2. **sp_auto_statistics_scheduler()**：自动调度执行各种统计任务。

## 6. 触发器

### 6.1 tr_after_insert_environmental_data
插入环境数据后自动触发异常检测。

### 6.2 tr_after_update_environmental_data
更新环境数据后自动重新检测异常。

### 6.3 tr_after_delete_environmental_data
删除环境数据后自动删除相关异常记录。

## 7. 数据完整性和安全性

### 7.1 数据完整性
- 通过主键、外键约束确保数据的引用完整性
- 使用非空约束确保必要字段有值
- 通过触发器自动维护相关数据的一致性

### 7.2 安全性
- 用户密码加密存储
- 基于角色的访问控制（通过不同视图实现）
- 完整的操作日志记录

## 8. 性能优化

### 8.1 索引优化
- 在频繁查询的字段上创建索引
- 复合索引用于多字段查询场景

### 8.2 查询优化
- 使用视图简化复杂查询
- 存储过程用于封装常用的业务逻辑操作

## 9. 数据备份与恢复

系统提供了完整的数据备份与恢复机制：
- **sp_backup_data**：将指定日期的环境数据备份到备份表
- **sp_restore_data**：从备份表恢复指定的备份数据
- **sp_clean_history_data**：定期清理历史数据，保持数据库性能

## 10. 事件调度

系统预留了事件调度配置，用于自动执行以下任务：
- 每日统计数据生成
- 每周统计数据生成
- 每月统计数据生成
- 异常数据定期检测
- 日报自动生成
- 历史数据定期清理

## 11. 总结

环境监测系统数据库设计完整，涵盖了监测站点管理、环境数据采集、统计分析、异常处理、报表生成等核心功能需求。通过合理的表结构设计、视图定义、存储过程和触发器的使用，确保了数据的完整性、一致性和系统的高效运行。数据库还考虑了安全性和可维护性，提供了数据备份恢复机制和性能优化措施。