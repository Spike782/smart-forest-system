<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§æ—è‰ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap;
        }

        .nav-item {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border-right: 1px solid #e9ecef;
            transition: all 0.3s;
            min-width: 120px;
        }

        .nav-item:hover {
            background: #e9ecef;
        }

        .nav-item.active {
            background: #667eea;
            color: white;
        }

        .content {
            padding: 30px;
            min-height: 500px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow: auto;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* ä¸‹æ‹‰èœå•æ ·å¼ */
        #user-menu {
            position: relative;
            cursor: pointer;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f9f9f9;
            min-width: 120px;
            box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
        }

        .dropdown-content div {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
        }

        .dropdown-content div:hover {
            background-color: #f1f1f1;
        }

        #user-menu:hover .dropdown-content {
            display: block;
        }

        /* å®æ—¶ç›‘æµ‹æ ·å¼ */
        .monitoring-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .monitoring-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .monitoring-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }

        .monitoring-card h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
        }

        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .metric-time {
            font-size: 12px;
            color: #666;
        }

        /* é¢„è­¦é€šçŸ¥è®°å½•æ ·å¼ */
        .alert-record {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .alert-record.warning {
            border-left-color: #ffc107;
        }

        .alert-record.danger {
            border-left-color: #dc3545;
        }

        .alert-record.info {
            border-left-color: #17a2b8;
        }

        .alert-record .alert-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .alert-record .alert-time {
            font-size: 12px;
            color: #666;
        }

        /* èµ„æºå˜åŠ¨è®°å½•æ ·å¼ */
        .change-record {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .change-record .change-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .change-record .change-type.new {
            background: #d4edda;
            color: #155724;
        }

        .change-record .change-type.remove {
            background: #f8d7da;
            color: #721c24;
        }

        .change-record .change-type.update {
            background: #fff3cd;
            color: #856404;
        }

        /* è®¾å¤‡çŠ¶æ€å’Œç»´æŠ¤è®°å½•æ ·å¼ */
        .status-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-card .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-card .status-indicator.online {
            background: #28a745;
        }

        .status-card .status-indicator.offline {
            background: #dc3545;
        }

        .status-card .status-indicator.warning {
            background: #ffc107;
        }

        .maintenance-record {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #17a2b8;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* é¢„è­¦ç®¡ç†é€‰é¡¹å¡æ ·å¼ */
        .alert-tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        /* èµ„æºç®¡ç†é€‰é¡¹å¡æ ·å¼ */
        .resource-tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: #f8f9fa;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .alert-tab-content, .resource-tab-content, .device-tab-content {
            display: none;
        }

        .alert-tab-content.active, .resource-tab-content.active, .device-tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .nav {
                flex-direction: column;
            }

            .nav-item {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }

            .toolbar {
                flex-direction: column;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ² æ™ºæ…§æ—è‰ç³»ç»Ÿ</h1>
            <p>æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ä¸èµ„æºç®¡ç†å¹³å°</p>
        </div>

        <div class="nav">
            <div class="nav-item active" onclick="showSection('regions')">åŒºåŸŸç®¡ç†</div>
            <div class="nav-item" onclick="showSection('monitoring')">å®æ—¶ç›‘æµ‹</div>
            <div class="nav-item" onclick="showSection('sensors')">ä¼ æ„Ÿå™¨ç®¡ç†</div>
            <div class="nav-item" onclick="showSection('alerts')">é¢„è­¦ç®¡ç†</div>
            <div class="nav-item" onclick="showSection('resources')">èµ„æºç®¡ç†</div>
            <div class="nav-item" onclick="showSection('devices')">è®¾å¤‡ç®¡ç†</div>
            <div class="nav-item" onclick="showSection('reports')">æŠ¥è¡¨ç®¡ç†</div>
            <div class="nav-item" onclick="showSection('statistics')">ç»Ÿè®¡åˆ†æ</div>
            <div class="nav-item" id="user-menu">
                <span id="user-menu-content">ç™»å½•/æ³¨å†Œ</span>
                <div id="user-dropdown" class="dropdown-content">
                    <div onclick="openLoginModal()">ç™»å½•</div>
                    <div onclick="openRegisterModal()">æ³¨å†Œ</div>
                </div>
            </div>
        </div>

        <div class="content">
            <!-- å®æ—¶ç›‘æµ‹ -->
            <div id="monitoring" class="section">
                <div class="toolbar">
                    <h2>å®æ—¶ç›‘æµ‹æ•°æ®</h2>
                    <div class="search-form">
                        <select id="monitoring-region" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <option value="">æ‰€æœ‰åŒºåŸŸ</option>
                        </select>
                        <select id="monitoring-metric" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <option value="">æ‰€æœ‰æŒ‡æ ‡</option>
                            <option value="temperature">æ¸©åº¦</option>
                            <option value="humidity">æ¹¿åº¦</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadMonitoringData()">åˆ·æ–°æ•°æ®</button>
                    </div>
                </div>
                <div id="monitoring-alert"></div>
                <div id="monitoring-content">
                    <div class="monitoring-grid">
                        <div class="monitoring-card">
                            <h3>æ¸©åº¦</h3>
                            <div class="metric-value">--Â°C</div>
                            <div class="metric-time">æœ€åæ›´æ–°: --</div>
                        </div>
                        <div class="monitoring-card">
                            <h3>æ¹¿åº¦</h3>
                            <div class="metric-value">--%</div>
                            <div class="metric-time">æœ€åæ›´æ–°: --</div>
                        </div>
                        <div class="monitoring-card" style="display: none;">
                            <h3>é£é€Ÿ</h3>
                            <div class="metric-value">--m/s</div>
                            <div class="metric-time">æœ€åæ›´æ–°: --</div>
                        </div>
                        <div class="monitoring-card" style="display: none;">
                            <h3>é™é›¨é‡</h3>
                            <div class="metric-value">--mm</div>
                            <div class="metric-time">æœ€åæ›´æ–°: --</div>
                        </div>
                        <div class="monitoring-card" style="display: none;">
                            <h3>åœŸå£¤æ¸©åº¦</h3>
                            <div class="metric-value">--Â°C</div>
                            <div class="metric-time">æœ€åæ›´æ–°: --</div>
                        </div>
                        <div class="monitoring-card" style="display: none;">
                            <h3>åœŸå£¤æ¹¿åº¦</h3>
                            <div class="metric-value">--%</div>
                            <div class="metric-time">æœ€åæ›´æ–°: --</div>
                        </div>
                        <div class="monitoring-card" style="display: none;">
                            <h3>PM2.5</h3>
                            <div class="metric-value">--Î¼g/mÂ³</div>
                            <div class="metric-time">æœ€åæ›´æ–°: --</div>
                        </div>
                        <div class="monitoring-card" style="display: none;">
                            <h3>PM10</h3>
                            <div class="metric-value">--Î¼g/mÂ³</div>
                            <div class="metric-time">æœ€åæ›´æ–°: --</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åŒºåŸŸç®¡ç† -->
            <div id="regions" class="section active">
                <div class="toolbar">
                    <h2>åŒºåŸŸç®¡ç†</h2>
                    <div class="search-form">
                        <input type="text" id="regions-search-name" placeholder="åŒºåŸŸåç§°" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                        <select id="regions-search-type" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <option value="">æ‰€æœ‰ç±»å‹</option>
                            <option value="FOREST">æ£®æ—</option>
                            <option value="GRASSLAND">è‰åœ°</option>
                        </select>
                        <button class="btn btn-primary" onclick="searchRegions()">æŸ¥è¯¢</button>
                        <button class="btn btn-secondary" onclick="resetRegionsSearch()">é‡ç½®</button>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('region')">+ æ–°å¢åŒºåŸŸ</button>
                </div>
                <div id="regions-alert"></div>
                <div id="regions-content"></div>
            </div>

            <!-- ä¼ æ„Ÿå™¨ç®¡ç† -->
            <div id="sensors" class="section">
                <div class="toolbar">
                    <h2>ä¼ æ„Ÿå™¨ç®¡ç†</h2>
                    <div class="search-form">
                        <input type="text" id="sensors-search-id" placeholder="ä¼ æ„Ÿå™¨ID" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                        <select id="sensors-search-type" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <option value="">æ‰€æœ‰ç±»å‹</option>
                            <option value="TEMPERATURE">æ¸©åº¦</option>
                            <option value="HUMIDITY">æ¹¿åº¦</option>
                            <option value="IMAGE">å›¾åƒ</option>
                            <option value="OTHER">å…¶ä»–</option>
                        </select>
                        <select id="sensors-search-status" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <option value="">æ‰€æœ‰çŠ¶æ€</option>
                            <option value="ACTIVE">æ¿€æ´»</option>
                            <option value="INACTIVE">æœªæ¿€æ´»</option>
                        </select>
                        <button class="btn btn-primary" onclick="searchSensors()">æŸ¥è¯¢</button>
                        <button class="btn btn-secondary" onclick="resetSensorsSearch()">é‡ç½®</button>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('sensor')">+ æ–°å¢ä¼ æ„Ÿå™¨</button>
                </div>
                <div id="sensors-alert"></div>
                <div id="sensors-content"></div>
            </div>

            <!-- é¢„è­¦ç®¡ç† -->
            <div id="alerts" class="section">
                <div class="toolbar">
                    <h2>é¢„è­¦ç®¡ç†</h2>
                    <div class="alert-tabs">
                        <button class="tab-btn active" onclick="switchAlertTab('alerts')">é¢„è­¦åˆ—è¡¨</button>
                        <button class="tab-btn" onclick="switchAlertTab('notifications')">é€šçŸ¥è®°å½•</button>
                    </div>
                </div>

                <!-- é¢„è­¦åˆ—è¡¨ -->
                <div id="alerts-list" class="alert-tab-content active">
                    <div class="toolbar" style="border-top: 1px solid #e9ecef; padding-top: 20px;">
                        <div class="search-form">
                            <select id="alerts-search-type" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                                <option value="">æ‰€æœ‰ç±»å‹</option>
                                <option value="FIRE">ç«ç¾</option>
                                <option value="DROUGHT">å¹²æ—±</option>
                                <option value="PEST">è™«å®³</option>
                                <option value="OTHER">å…¶ä»–</option>
                            </select>
                            <select id="alerts-search-severity" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                                <option value="">æ‰€æœ‰ä¸¥é‡ç¨‹åº¦</option>
                                <option value="GENERAL">ä¸€èˆ¬</option>
                                <option value="MODERATE">ä¸­ç­‰</option>
                                <option value="SEVERE">ä¸¥é‡</option>
                                <option value="CRITICAL">ç´§æ€¥</option>
                            </select>
                            <select id="alerts-search-status" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                                <option value="">æ‰€æœ‰çŠ¶æ€</option>
                                <option value="PENDING">å¾…å¤„ç†</option>
                                <option value="PROCESSING">å¤„ç†ä¸­</option>
                                <option value="CLOSED">å·²å…³é—­</option>
                            </select>
                            <button class="btn btn-primary" onclick="searchAlerts()">æŸ¥è¯¢</button>
                            <button class="btn btn-secondary" onclick="resetAlertsSearch()">é‡ç½®</button>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-primary" onclick="openModal('alert-rule')">+ æ–°å¢é¢„è­¦è§„åˆ™</button>
                            <button class="btn btn-success" onclick="openModal('alert')">+ æ–°å¢é¢„è­¦</button>
                        </div>
                    </div>
                    <div id="alerts-alert"></div>
                    <div id="alerts-content"></div>
                </div>

                <!-- é€šçŸ¥è®°å½• -->
                <div id="notifications-list" class="alert-tab-content">
                    <div class="toolbar" style="border-top: 1px solid #e9ecef; padding-top: 20px;">
                        <div class="search-form">
                            <select id="notifications-search-alert-id" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                                <option value="">æ‰€æœ‰é¢„è­¦</option>
                            </select>
                            <input type="date" id="notifications-search-date" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;" placeholder="é€‰æ‹©æ—¥æœŸ">
                            <button class="btn btn-primary" onclick="loadNotifications()">æŸ¥è¯¢</button>
                            <button class="btn btn-secondary" onclick="resetNotificationsSearch()">é‡ç½®</button>
                        </div>
                    </div>
                    <div id="notifications-alert"></div>
                    <div id="notifications-content"></div>
                </div>
            </div>

            <!-- èµ„æºç®¡ç† -->
            <div id="resources" class="section">
                <div class="toolbar">
                    <h2>èµ„æºç®¡ç†</h2>
                    <div class="resource-tabs">
                        <button class="tab-btn active" onclick="switchResourceTab('resources')">èµ„æºåˆ—è¡¨</button>
                        <button class="tab-btn" onclick="switchResourceTab('changes')">å˜åŠ¨è®°å½•</button>
                    </div>
                </div>

                <!-- èµ„æºåˆ—è¡¨ -->
                <div id="resources-list" class="resource-tab-content active">
                    <div class="toolbar" style="border-top: 1px solid #e9ecef; padding-top: 20px;">
                        <div class="search-form">
                            <select id="resources-search-type" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                                <option value="">æ‰€æœ‰ç±»å‹</option>
                                <option value="TREE">æ ‘æœ¨</option>
                                <option value="GRASS">è‰åœ°</option>
                            </select>
                            <select id="resources-search-stage" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                                <option value="">æ‰€æœ‰ç”Ÿé•¿é˜¶æ®µ</option>
                                <option value="SEEDLING">å¹¼è‹—</option>
                                <option value="GROWING">æˆé•¿æœŸ</option>
                                <option value="MATURE">æˆç†ŸæœŸ</option>
                            </select>
                            <input type="number" id="resources-search-region-id" placeholder="åŒºåŸŸID" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <button class="btn btn-primary" onclick="searchResources()">æŸ¥è¯¢</button>
                            <button class="btn btn-secondary" onclick="resetResourcesSearch()">é‡ç½®</button>
                        </div>
                        <button class="btn btn-primary" onclick="openModal('resource')">+ æ–°å¢èµ„æº</button>
                    </div>
                    <div id="resources-alert"></div>
                    <div id="resources-content"></div>
                </div>

                <!-- å˜åŠ¨è®°å½• -->
                <div id="changes-list" class="resource-tab-content">
                    <div class="toolbar" style="border-top: 1px solid #e9ecef; padding-top: 20px;">
                        <div class="search-form">
                            <input type="text" id="changes-search-resource-id" placeholder="èµ„æºID" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <select id="changes-search-type" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                                <option value="">æ‰€æœ‰å˜åŠ¨ç±»å‹</option>
                                <option value="NEW">æ–°å¢</option>
                                <option value="REDUCE">å‡å°‘</option>
                                <option value="UPDATE">çŠ¶æ€æ›´æ–°</option>
                            </select>
                            <input type="date" id="changes-search-date" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <button class="btn btn-primary" onclick="loadResourceChanges()">æŸ¥è¯¢</button>
                            <button class="btn btn-secondary" onclick="resetChangesSearch()">é‡ç½®</button>
                        </div>
                    </div>
                    <div id="changes-alert"></div>
                    <div id="changes-content"></div>
                </div>
            </div>

            <!-- è®¾å¤‡ç®¡ç† -->
            <div id="devices" class="section">
                <div class="toolbar">
                    <h2>è®¾å¤‡ç®¡ç†</h2>
                    <div class="device-tabs">
                        <button class="tab-btn active" onclick="switchDeviceTab('devices')">è®¾å¤‡åˆ—è¡¨</button>
                        <button class="tab-btn" onclick="switchDeviceTab('status')">è®¾å¤‡çŠ¶æ€</button>
                        <button class="tab-btn" onclick="switchDeviceTab('maintenance')">ç»´æŠ¤è®°å½•</button>
                    </div>
                </div>

                <!-- è®¾å¤‡åˆ—è¡¨ -->
                <div id="devices-list" class="device-tab-content active">
                    <div class="toolbar" style="border-top: 1px solid #e9ecef; padding-top: 20px;">
                        <div class="search-form">
                            <select id="devices-search-type" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                                <option value="">æ‰€æœ‰ç±»å‹</option>
                                <option value="SENSOR">ä¼ æ„Ÿå™¨</option>
                                <option value="CAMERA">æ‘„åƒå¤´</option>
                                <option value="ALERTER">æŠ¥è­¦å™¨</option>
                                <option value="OTHER">å…¶ä»–</option>
                            </select>
                            <input type="number" id="devices-search-region-id" placeholder="å®‰è£…åŒºåŸŸID" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <input type="text" id="devices-search-name" placeholder="è®¾å¤‡åç§°" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <button class="btn btn-primary" onclick="searchDevices()">æŸ¥è¯¢</button>
                            <button class="btn btn-secondary" onclick="resetDevicesSearch()">é‡ç½®</button>
                        </div>
                        <button class="btn btn-primary" onclick="openModal('device')">+ æ–°å¢è®¾å¤‡</button>
                    </div>
                    <div id="devices-alert"></div>
                    <div id="devices-content"></div>
                </div>

                <!-- è®¾å¤‡çŠ¶æ€ -->
                <div id="status-list" class="device-tab-content">
                    <div class="toolbar" style="border-top: 1px solid #e9ecef; padding-top: 20px;">
                        <div class="search-form">
                            <input type="text" id="status-search-device-id" placeholder="è®¾å¤‡ID" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <select id="status-search-status" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                                <option value="">æ‰€æœ‰çŠ¶æ€</option>
                                <option value="ONLINE">åœ¨çº¿</option>
                                <option value="OFFLINE">ç¦»çº¿</option>
                                <option value="WARNING">è­¦å‘Š</option>
                                <option value="ERROR">æ•…éšœ</option>
                            </select>
                            <input type="date" id="status-search-date" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <button class="btn btn-primary" onclick="loadDeviceStatus()">æŸ¥è¯¢</button>
                            <button class="btn btn-secondary" onclick="resetStatusSearch()">é‡ç½®</button>
                        </div>
                        <button class="btn btn-success" onclick="openModal('device-status')">+ è®°å½•çŠ¶æ€</button>
                    </div>
                    <div id="status-alert"></div>
                    <div id="status-content"></div>
                </div>

                <!-- ç»´æŠ¤è®°å½• -->
                <div id="maintenance-list" class="device-tab-content">
                    <div class="toolbar" style="border-top: 1px solid #e9ecef; padding-top: 20px;">
                        <div class="search-form">
                            <input type="text" id="maintenance-search-device-id" placeholder="è®¾å¤‡ID" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <select id="maintenance-search-type" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                                <option value="">æ‰€æœ‰ç±»å‹</option>
                                <option value="REPAIR">ç»´ä¿®</option>
                                <option value="REPLACE">æ›´æ¢</option>
                                <option value="INSPECTION">æ£€æŸ¥</option>
                                <option value="UPGRADE">å‡çº§</option>
                                <option value="OTHER">å…¶ä»–</option>
                            </select>
                            <input type="date" id="maintenance-search-date" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <button class="btn btn-primary" onclick="loadDeviceMaintenance()">æŸ¥è¯¢</button>
                            <button class="btn btn-secondary" onclick="resetMaintenanceSearch()">é‡ç½®</button>
                        </div>
                    </div>
                    <div id="maintenance-alert"></div>
                    <div id="maintenance-content"></div>
                </div>
            </div>

            <!-- æŠ¥è¡¨ç®¡ç† -->
            <div id="reports" class="section">
                <div class="toolbar">
                    <h2>æŠ¥è¡¨ç®¡ç†</h2>
                    <div class="search-form">
                        <select id="reports-search-type" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <option value="">æ‰€æœ‰ç±»å‹</option>
                            <option value="daily">æ—¥æŠ¥</option>
                            <option value="weekly">å‘¨æŠ¥</option>
                            <option value="monthly">æœˆæŠ¥</option>
                            <option value="quarterly">å­£æŠ¥</option>
                            <option value="yearly">å¹´æŠ¥</option>
                        </select>
                        <input type="number" id="reports-search-template-id" placeholder="æ¨¡æ¿ID" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                        <select id="reports-search-status" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <option value="">æ‰€æœ‰çŠ¶æ€</option>
                            <option value="GENERATED">å·²ç”Ÿæˆ</option>
                            <option value="PROCESSING">ç”Ÿæˆä¸­</option>
                            <option value="FAILED">ç”Ÿæˆå¤±è´¥</option>
                        </select>
                        <button class="btn btn-primary" onclick="searchReports()">æŸ¥è¯¢</button>
                        <button class="btn btn-secondary" onclick="resetReportsSearch()">é‡ç½®</button>
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="openModal('report-template')">+ æ–°å¢æ¨¡æ¿</button>
                        <button class="btn btn-success" onclick="openModal('report')">+ æ–°å¢æŠ¥è¡¨</button>
                        <button class="btn btn-warning" onclick="openModal('generate-report')">ç”ŸæˆæŠ¥è¡¨</button>
                    </div>
                </div>
                <div id="reports-alert"></div>
                <div id="reports-content"></div>
            </div>

            <!-- ç»Ÿè®¡åˆ†æ -->
            <div id="statistics" class="section">
                <div class="toolbar">
                    <h2>ç»Ÿè®¡åˆ†æ</h2>
                    <button class="btn btn-primary" onclick="loadStatistics()">åˆ·æ–°æ•°æ®</button>
                </div>
                <div id="statistics-alert"></div>
                <div id="statistics-content"></div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">æ ‡é¢˜</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        let currentSection = 'regions';
        let currentEditId = null;
        let token = localStorage.getItem('token');
        let user = JSON.parse(localStorage.getItem('user'));

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–é¡µé¢
            initializeApp();
        });

        // åˆå§‹åŒ–åº”ç”¨
        function initializeApp() {
            // åŠ è½½å½“å‰åŒºåŸŸçš„æ•°æ®
            loadSectionData(currentSection);
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkLoginStatus();
            
            // æ ¹æ®ç™»å½•çŠ¶æ€æ§åˆ¶æ–°å¢æŒ‰é’®çš„æ˜¾ç¤º
            updateToolbarButtons();
        }
        
        // æ ¹æ®ç™»å½•çŠ¶æ€æ§åˆ¶å·¥å…·æ æŒ‰é’®çš„æ˜¾ç¤º
        function updateToolbarButtons() {
            // è·å–æ‰€æœ‰å·¥å…·æ ä¸­çš„æŒ‰é’®
            const buttons = document.querySelectorAll('.toolbar button');
            buttons.forEach(button => {
                // å¦‚æœæŒ‰é’®æ–‡æœ¬åŒ…å«"æ–°å¢"ã€"ç¼–è¾‘"ã€"åˆ é™¤"ã€"ä¿å­˜"ã€"ç”Ÿæˆ"ç­‰æ“ä½œè¯æ±‡ï¼Œåˆ™æ ¹æ®ç™»å½•çŠ¶æ€æ§åˆ¶æ˜¾ç¤º
                if (button.textContent.includes('æ–°å¢') || button.textContent.includes('ç¼–è¾‘') || button.textContent.includes('åˆ é™¤') || button.textContent.includes('ä¿å­˜') || button.textContent.includes('ç”Ÿæˆ')) {
                    if (token) {
                        button.style.display = 'inline-block';
                    } else {
                        button.style.display = 'none';
                    }
                }
            });
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            if (token) {
                // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                showUserInfo();
            } else {
                // æ˜¾ç¤ºç™»å½•/æ³¨å†ŒæŒ‰é’®
                showLoginButtons();
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function showUserInfo() {
            const userMenu = document.getElementById('user-menu');
            const userMenuContent = document.getElementById('user-menu-content');
            const userDropdown = document.getElementById('user-dropdown');
            
            // æ›´æ–°ç”¨æˆ·èœå•å†…å®¹
            userMenuContent.innerHTML = user ? `æ¬¢è¿, ${user.real_name || user.username}` : 'æ¬¢è¿å›æ¥';
            
            // æ›´æ–°ä¸‹æ‹‰èœå•å†…å®¹ï¼Œæ˜¾ç¤ºé€€å‡ºç™»å½•é€‰é¡¹
            userDropdown.innerHTML = `
                <div onclick="logout()">é€€å‡ºç™»å½•</div>
            `;
        }

        // æ˜¾ç¤ºç™»å½•/æ³¨å†ŒæŒ‰é’®
        function showLoginButtons() {
            const userMenu = document.getElementById('user-menu');
            const userMenuContent = document.getElementById('user-menu-content');
            const userDropdown = document.getElementById('user-dropdown');
            
            // æ›´æ–°ç”¨æˆ·èœå•å†…å®¹
            userMenuContent.innerHTML = 'ç™»å½•/æ³¨å†Œ';
            
            // æ›´æ–°ä¸‹æ‹‰èœå•å†…å®¹ï¼Œæ˜¾ç¤ºç™»å½•å’Œæ³¨å†Œé€‰é¡¹
            userDropdown.innerHTML = `
                <div onclick="openLoginModal()">ç™»å½•</div>
                <div onclick="openRegisterModal()">æ³¨å†Œ</div>
            `;
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            token = null;
            user = null;
            // é‡æ–°åŠ è½½é¡µé¢ï¼Œç¡®ä¿æ‰€æœ‰çŠ¶æ€é‡ç½®
            location.reload();
        }

        // æ˜¾ç¤ºæŒ‡å®šéƒ¨åˆ†
        function showSection(section) {
            currentSection = section;
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.section').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(section).classList.add('active');
            
            // åŠ è½½æ•°æ®
            loadSectionData(section);
            
            // æ ¹æ®ç™»å½•çŠ¶æ€æ§åˆ¶æ–°å¢æŒ‰é’®çš„æ˜¾ç¤º
            updateToolbarButtons();
        }

        // åŠ è½½å„éƒ¨åˆ†æ•°æ®
        function loadSectionData(section) {
            switch(section) {
                case 'regions': loadRegions(); break;
                case 'monitoring': loadMonitoringData(); break;
                case 'sensors': loadSensors(); break;
                case 'alerts': loadAlertsAndNotifications(); break;
                case 'resources': loadResources(); break;
                case 'devices': loadDevices(); break;
                case 'reports': loadReports(); break;
                case 'statistics': loadStatistics(); break;
            }
        }

        // APIè¯·æ±‚å°è£…
        async function apiRequest(method, url, data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : '',
                }
            };
            if (data) {
                options.body = JSON.stringify(data);
            }
            const response = await fetch(API_BASE + url, options);
            
            // æ£€æŸ¥å“åº”çŠ¶æ€
            if (!response.ok) {
                // å¤„ç†è®¤è¯å’Œæƒé™é”™è¯¯
                if (response.status === 401) {
                    // 401: æœªè®¤è¯ï¼Œéœ€è¦é‡æ–°ç™»å½•
                    // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„tokenå’Œç”¨æˆ·ä¿¡æ¯
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    token = null;
                    user = null;

                    // æ›´æ–°UIï¼Œæ˜¾ç¤ºç™»å½•/æ³¨å†ŒæŒ‰é’®
                    showLoginButtons();

                    // æ˜¾ç¤ºé‡æ–°ç™»å½•æç¤º
                    showAlert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');

                    // è·³è½¬åˆ°ç™»å½•é¡µé¢æˆ–æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
                    openLoginModal();

                    throw new Error('éœ€è¦ç™»å½•');
                } else if (response.status === 403) {
                    // 403: æƒé™ä¸è¶³ï¼Œæ— éœ€é‡æ–°ç™»å½•
                    const errorData = await response.json().catch(() => ({}));
                    showAlert(errorData.error || 'æ²¡æœ‰æ“ä½œæƒé™', 'error');
                    throw new Error('æƒé™ä¸è¶³');
                }
                
                const errorData = await response.json().catch(() => ({}));
                const errorMsg = errorData.error || `è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`;
                throw new Error(errorMsg);
            }
            
            return await response.json();
        }

        // ç™»å½•åŠŸèƒ½
        function openLoginModal() {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            
            title.textContent = 'ç™»å½•';
            body.innerHTML = `
                <form onsubmit="login(event)">
                    <div class="form-group">
                        <label>ç”¨æˆ·å *</label>
                        <input type="text" name="username" required>
                    </div>
                    <div class="form-group">
                        <label>å¯†ç  *</label>
                        <input type="password" name="password" required>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ç™»å½•</button>
                    </div>
                </form>
            `;
            modal.style.display = 'block';
        }

        // ç™»å½•å¤„ç†
        async function login(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                username: formData.get('username'),
                password: formData.get('password'),
            };
            
            try {
                const result = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (!result.ok) {
                    const errorData = await result.json().catch(() => ({}));
                    throw new Error(errorData.error || 'ç™»å½•å¤±è´¥');
                }
                
                const loginResult = await result.json();
                token = loginResult.token;
                user = {
                    id: loginResult.user_id,
                    username: loginResult.username,
                    real_name: loginResult.real_name
                };
                localStorage.setItem('token', token);
                localStorage.setItem('user', JSON.stringify(user));
                
                showAlert('ç™»å½•æˆåŠŸï¼', 'success');
                closeModal();
                
                // æ›´æ–°UIï¼Œæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                checkLoginStatus();
                
                // æ˜¾ç¤ºæ‰€æœ‰æ“ä½œæŒ‰é’®
                updateToolbarButtons();
                
                // é‡æ–°åŠ è½½å½“å‰åŒºåŸŸçš„æ•°æ®
                loadSectionData(currentSection);
            } catch (error) {
                showAlert(`ç™»å½•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ³¨å†ŒåŠŸèƒ½
        function openRegisterModal() {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = 'æ³¨å†Œ';
            body.innerHTML = `
                <form onsubmit="register(event)">
                    <div class="form-group">
                        <label>ç”¨æˆ·å *</label>
                        <input type="text" name="username" required>
                    </div>
                    <div class="form-group">
                        <label>å¯†ç  *</label>
                        <input type="password" name="password" required>
                    </div>
                    <div class="form-group">
                        <label>ç¡®è®¤å¯†ç  *</label>
                        <input type="password" name="confirm_password" required>
                    </div>
                    <div class="form-group">
                        <label>é‚®ç®± *</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>çœŸå®å§“å</label>
                        <input type="text" name="real_name">
                    </div>
                    <div class="form-group">
                        <label>æ³¨å†Œèº«ä»½ *</label>
                        <select name="role_id" id="role-select" required>
                            <option value="">è¯·é€‰æ‹©èº«ä»½</option>
                        </select>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">æ³¨å†Œ</button>
                    </div>
                </form>
            `;

            // åŠ è½½è§’è‰²åˆ—è¡¨
            loadRolesForRegistration();

            modal.style.display = 'block';
        }

        // åŠ è½½è§’è‰²åˆ—è¡¨ç”¨äºæ³¨å†Œ
        async function loadRolesForRegistration() {
            try {
                const response = await fetch('/roles');
                if (!response.ok) {
                    throw new Error('è·å–è§’è‰²åˆ—è¡¨å¤±è´¥');
                }

                const data = await response.json();
                const roleSelect = document.getElementById('role-select');

                // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™é»˜è®¤é€‰é¡¹ï¼‰
                roleSelect.innerHTML = '<option value="">è¯·é€‰æ‹©èº«ä»½</option>';

                // æ·»åŠ è§’è‰²é€‰é¡¹
                data.roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.ID || role.id;
                    option.textContent = `${role.RoleName || role.role_name} - ${role.Description || role.description}`;
                    roleSelect.appendChild(option);
                });
            } catch (error) {
                console.error('åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥:', error);
                const roleSelect = document.getElementById('role-select');
                roleSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</option>';
            }
        }

        // æ³¨å†Œå¤„ç†
        async function register(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            if (formData.get('password') !== formData.get('confirm_password')) {
                showAlert('å¯†ç ä¸ä¸€è‡´ï¼', 'error');
                return;
            }
            
            const data = {
                username: formData.get('username'),
                password: formData.get('password'),
                email: formData.get('email'),
                real_name: formData.get('real_name'),
                phone: formData.get('phone') || '',
                role_id: parseInt(formData.get('role_id')),
            };
            
            try {
                const result = await fetch('/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (!result.ok) {
                    const errorData = await result.json().catch(() => ({}));
                    throw new Error(errorData.error || 'æ³¨å†Œå¤±è´¥');
                }
                
                showAlert('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•', 'success');
                closeModal();
                openLoginModal();
            } catch (error) {
                showAlert('æ³¨å†Œå¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type = 'success') {
            let alertDiv;
            let section = null;
            
            // æ ‡å‡†åŒ–è¾“å…¥å‚æ•°
            if (typeof message === 'object') {
                // æ”¯æŒå…¨å±€æç¤ºæˆ–ç‰¹å®šåŒºåŸŸæç¤º
                section = message.section;
                message = message.message || 'æœªçŸ¥æ¶ˆæ¯';
            } else {
                // ç¡®ä¿æ¶ˆæ¯æ˜¯å­—ç¬¦ä¸²ç±»å‹
                message = String(message || 'æœªçŸ¥æ¶ˆæ¯');
            }
            
            // ç¡®ä¿ç±»å‹æ˜¯æœ‰æ•ˆå€¼
            const validTypes = ['success', 'error', 'warning', 'info'];
            type = validTypes.includes(type) ? type : 'success';
            
            // æŸ¥æ‰¾æˆ–åˆ›å»ºæç¤ºå®¹å™¨
            if (section) {
                alertDiv = document.getElementById(section + '-alert');
            } else {
                alertDiv = document.getElementById(currentSection + '-alert') || 
                          document.getElementById('global-alert');
            }
            
            // å¦‚æœæç¤ºå®¹å™¨ä¸å­˜åœ¨ï¼Œåˆ›å»ºå…¨å±€æç¤º
            if (!alertDiv) {
                alertDiv = document.createElement('div');
                alertDiv.id = section ? section + '-alert' : 'global-alert';
                
                if (section) {
                    // åŒºåŸŸæç¤ºæ ·å¼
                    alertDiv.style.marginBottom = '15px';
                } else {
                    // å…¨å±€æç¤ºæ ·å¼
                    alertDiv.style.position = 'fixed';
                    alertDiv.style.top = '20px';
                    alertDiv.style.right = '20px';
                    alertDiv.style.zIndex = '1000';
                    alertDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    alertDiv.style.fontWeight = '500';
                    alertDiv.style.color = 'white';
                    document.body.appendChild(alertDiv);
                }
            }
            
            // è®¾ç½®æ ·å¼å’Œå†…å®¹
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            alertDiv.style.padding = '15px 20px';
            alertDiv.style.borderRadius = '6px';
            
            // è‡ªåŠ¨éšè—
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }

        // åŒºåŸŸç®¡ç†
        async function loadRegions(searchParams = {}) {
            const content = document.getElementById('regions-content');
            const alertDiv = document.getElementById('regions-alert');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                // æ¸…ç©ºä¹‹å‰çš„æç¤º
                if (alertDiv) {
                    alertDiv.innerHTML = '';
                }
                
                // æ„å»ºæŸ¥è¯¢å‚æ•°
                let queryString = '';
                const params = [];
                if (searchParams.name && searchParams.name.trim() !== '') params.push(`region_name=${encodeURIComponent(searchParams.name)}`);
                if (searchParams.type && searchParams.type !== 'æ‰€æœ‰ç±»å‹') params.push(`region_type=${encodeURIComponent(searchParams.type)}`);
                if (params.length > 0) queryString = '?' + params.join('&');
                
                const result = await apiRequest('GET', `/api/regions${queryString}`);
                
                // æ£€æŸ¥å“åº”æ•°æ®æ ¼å¼
                const regions = result.data || result;
                
                if (Array.isArray(regions) && regions.length > 0) {
                    let html = '<table><thead><tr><th>ID</th><th>åç§°</th><th>ç±»å‹</th><th>çº¬åº¦</th><th>ç»åº¦</th><th>è´Ÿè´£äººID</th><th>æ“ä½œ</th></tr></thead><tbody>';
                    regions.forEach(region => {
                        const regionId = region.ID || region.id;
                        const managerId = region.ManagerID !== undefined ? region.ManagerID : (region.manager_id !== undefined ? region.manager_id : '-');
                        const regionType = region.Type || region.type;
                        const regionName = region.Name || region.name;
                        const latitude = region.Latitude || region.latitude || '-';
                        const longitude = region.Longitude || region.longitude || '-';
                        
                        html += `<tr>
                            <td>${regionId}</td>
                            <td>${regionName}</td>
                            <td>${regionType === 'FOREST' ? 'æ£®æ—' : 'è‰åœ°'}</td>
                            <td>${latitude}</td>
                            <td>${longitude}</td>
                            <td>${managerId}</td>
                            <td>`;
                        if (token) {
                            html += `<button class="btn btn-secondary" onclick="editRegion(${regionId})">ç¼–è¾‘</button>
                                <button class="btn btn-danger" onclick="deleteRegion(${regionId})">åˆ é™¤</button>`;
                        } else {
                            html += '<span>æ— æƒé™æ“ä½œ</span>';
                        }
                        html += `</td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = '<div class="empty-state"><p>æš‚æ— æ•°æ®</p></div>';
                }

                // æ›´æ–°ç›‘æ§åŒºåŸŸä¸‹æ‹‰æ¡†
                updateMonitoringRegions(regions);
            } catch (error) {
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const errorMsg = `åŠ è½½åŒºåŸŸæ•°æ®å¤±è´¥: ${error.message}`;
                content.innerHTML = '<div class="empty-state"><p>åŠ è½½å¤±è´¥</p></div>';

                // ä½¿ç”¨showAlertæ˜¾ç¤ºé”™è¯¯
                showAlert(errorMsg, 'error');
            }
        }

        // åŒºåŸŸæœç´¢åŠŸèƒ½
        function searchRegions() {
            const name = document.getElementById('regions-search-name').value;
            const type = document.getElementById('regions-search-type').value;
            loadRegions({ name, type });
        }

        // é‡ç½®åŒºåŸŸæœç´¢
        function resetRegionsSearch() {
            document.getElementById('regions-search-name').value = '';
            document.getElementById('regions-search-type').value = '';
            loadRegions();
        }

        // æ›´æ–°ç›‘æ§åŒºåŸŸä¸‹æ‹‰æ¡†
        function updateMonitoringRegions(regions) {
            const monitoringRegionSelect = document.getElementById('monitoring-region');
            if (!monitoringRegionSelect) return;

            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼Œä¿ç•™"æ‰€æœ‰åŒºåŸŸ"
            monitoringRegionSelect.innerHTML = '<option value="">æ‰€æœ‰åŒºåŸŸ</option>';

            // æ·»åŠ åŒºåŸŸé€‰é¡¹
            if (Array.isArray(regions)) {
                regions.forEach(region => {
                    const regionId = region.ID || region.id;
                    const regionName = region.Name || region.name;
                    const option = document.createElement('option');
                    option.value = regionId;
                    option.textContent = regionName;
                    monitoringRegionSelect.appendChild(option);
                });
            }
        }

        // åˆ‡æ¢é¢„è­¦ç®¡ç†é€‰é¡¹å¡
        function switchAlertTab(tab) {
            // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('#alerts .tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('#alerts .alert-tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + '-list').classList.add('active');

            // åŠ è½½å¯¹åº”æ•°æ®
            if (tab === 'alerts') {
                loadAlerts();
            } else if (tab === 'notifications') {
                loadNotifications();
            }
        }

        // åˆ‡æ¢èµ„æºç®¡ç†é€‰é¡¹å¡
        function switchResourceTab(tab) {
            // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('#resources .tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('#resources .resource-tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + '-list').classList.add('active');

            // åŠ è½½å¯¹åº”æ•°æ®
            if (tab === 'resources') {
                loadResources();
            } else if (tab === 'changes') {
                loadResourceChanges();
            }
        }

        // åˆ‡æ¢è®¾å¤‡ç®¡ç†é€‰é¡¹å¡
        function switchDeviceTab(tab) {
            // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('#devices .tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('#devices .device-tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + '-list').classList.add('active');

            // åŠ è½½å¯¹åº”æ•°æ®
            if (tab === 'devices') {
                loadDevices();
            } else if (tab === 'status') {
                loadDeviceStatus();
            } else if (tab === 'maintenance') {
                loadDeviceMaintenance();
            }
        }

        // åŠ è½½é¢„è­¦å’Œé€šçŸ¥æ•°æ®
        async function loadAlertsAndNotifications() {
            // é»˜è®¤æ˜¾ç¤ºé¢„è­¦åˆ—è¡¨
            loadAlerts();
            // åŒæ—¶å‡†å¤‡é€šçŸ¥è®°å½•çš„é¢„è­¦ä¸‹æ‹‰æ¡†
            loadAlertsForNotificationsSelect();
        }

        // ä¸ºé€šçŸ¥è®°å½•åŠ è½½é¢„è­¦é€‰æ‹©ä¸‹æ‹‰æ¡†
        async function loadAlertsForNotificationsSelect() {
            try {
                const result = await apiRequest('GET', '/api/alerts');
                const alerts = result.data || [];
                const select = document.getElementById('notifications-search-alert-id');

                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                select.innerHTML = '<option value="">æ‰€æœ‰é¢„è­¦</option>';

                // æ·»åŠ é¢„è­¦é€‰é¡¹
                if (Array.isArray(alerts)) {
                    alerts.forEach(alert => {
                        const alertId = alert.ID || alert.id;
                        const alertType = alert.AlertType || alert.alert_type;
                        const severity = alert.Severity || alert.severity;
                        const option = document.createElement('option');
                        option.value = alertId;
                        option.textContent = `é¢„è­¦${alertId} (${alertType})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.warn('åŠ è½½é¢„è­¦åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åŠ è½½é€šçŸ¥è®°å½•
        async function loadNotifications() {
            const content = document.getElementById('notifications-content');
            const alertId = document.getElementById('notifications-search-alert-id').value;
            const date = document.getElementById('notifications-search-date').value;

            content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                let allNotifications = [];

                // é¦–å…ˆè·å–æ‰€æœ‰é¢„è­¦ä¿¡æ¯ï¼Œç”¨äºå…³è”
                const alertsResult = await apiRequest('GET', '/api/alerts');
                const alerts = alertsResult.data || [];
                const alertMap = {};
                alerts.forEach(alert => {
                    const alertIdCurrent = alert.ID || alert.id;
                    alertMap[alertIdCurrent] = {
                        type: alert.AlertType || alert.alert_type,
                        severity: alert.Severity || alert.severity
                    };
                });

                if (alertId) {
                    // å¦‚æœæŒ‡å®šäº†é¢„è­¦IDï¼Œç›´æ¥è·å–è¯¥é¢„è­¦çš„é€šçŸ¥
                    try {
                        const notificationsResult = await apiRequest('GET', `/api/alerts/${alertId}/notifications`);
                        const notifications = notificationsResult.data || [];
                        const alertInfo = alertMap[alertId] || {};
                        notifications.forEach(notification => {
                            allNotifications.push({
                                ...notification,
                                alert_type: alertInfo.type,
                                alert_severity: alertInfo.severity
                            });
                        });
                    } catch (error) {
                        console.warn(`è·å–é¢„è­¦ ${alertId} çš„é€šçŸ¥å¤±è´¥:`, error);
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰æŒ‡å®šé¢„è­¦IDï¼Œè·å–æ‰€æœ‰é¢„è­¦çš„é€šçŸ¥
                    for (const alert of alerts) {
                        const alertIdCurrent = alert.ID || alert.id;
                        try {
                            const notificationsResult = await apiRequest('GET', `/api/alerts/${alertIdCurrent}/notifications`);
                            const notifications = notificationsResult.data || [];
                            const alertInfo = alertMap[alertIdCurrent] || {};
                            notifications.forEach(notification => {
                                allNotifications.push({
                                    ...notification,
                                    alert_type: alertInfo.type,
                                    alert_severity: alertInfo.severity
                                });
                            });
                        } catch (error) {
                            console.warn(`è·å–é¢„è­¦ ${alertIdCurrent} çš„é€šçŸ¥å¤±è´¥:`, error);
                        }
                    }
                }

                // æŒ‰æ—¥æœŸç­›é€‰
                if (date) {
                    allNotifications = allNotifications.filter(notification => {
                        const notificationDate = new Date(notification.created_at || notification.CreatedAt).toISOString().split('T')[0];
                        return notificationDate === date;
                    });
                }

                // æŒ‰æ—¶é—´å€’åºæ’åº
                allNotifications.sort((a, b) => new Date(b.created_at || b.CreatedAt) - new Date(a.created_at || a.CreatedAt));

                if (allNotifications.length > 0) {
                    let html = '';
                    allNotifications.forEach(notification => {
                        const severity = notification.alert_severity;
                        const severityClass = getSeverityClass(severity);
                        const createTime = new Date(notification.created_at).toLocaleString();

                        html += `
                            <div class="alert-record ${severityClass}">
                                <div class="alert-title">
                                    <strong>é¢„è­¦${notification.alert_id} - ${notification.alert_type || 'æœªçŸ¥ç±»å‹'}</strong>
                                    <span style="float: right;">${getSeverityText(severity) || 'æœªçŸ¥'}</span>
                                </div>
                                <div class="alert-content">${notification.message || 'æ— æ¶ˆæ¯å†…å®¹'}</div>
                                <div class="alert-time">å‘é€æ—¶é—´: ${createTime}</div>
                                <div class="alert-meta">
                                    æ¥æ”¶äºº: ${notification.recipient || 'æœªæŒ‡å®š'} |
                                    é€šçŸ¥æ–¹å¼: ${notification.notification_type || 'æœªçŸ¥'}
                                </div>
                            </div>
                        `;
                    });
                    content.innerHTML = html;
                } else {
                    content.innerHTML = '<div class="empty-state"><p>æš‚æ— é€šçŸ¥è®°å½•</p></div>';
                }

            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">åŠ è½½é€šçŸ¥è®°å½•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // è·å–ä¸¥é‡ç¨‹åº¦å¯¹åº”çš„CSSç±»
        function getSeverityClass(severity) {
            switch (severity) {
                case 'CRITICAL': return 'danger';
                case 'SEVERE': return 'danger';
                case 'MODERATE': return 'warning';
                case 'GENERAL': return 'info';
                default: return 'info';
            }
        }

        // è·å–ä¸¥é‡ç¨‹åº¦çš„æ–‡æœ¬
        function getSeverityText(severity) {
            switch (severity) {
                case 'CRITICAL': return 'ç´§æ€¥';
                case 'SEVERE': return 'ä¸¥é‡';
                case 'MODERATE': return 'ä¸­ç­‰';
                case 'GENERAL': return 'ä¸€èˆ¬';
                default: return 'æœªçŸ¥';
            }
        }

        // é‡ç½®é€šçŸ¥è®°å½•æœç´¢
        function resetNotificationsSearch() {
            document.getElementById('notifications-search-alert-id').value = '';
            document.getElementById('notifications-search-date').value = '';
            loadNotifications();
        }

        // åŠ è½½èµ„æºå˜åŠ¨è®°å½•
        async function loadResourceChanges() {
            const content = document.getElementById('changes-content');
            const resourceId = document.getElementById('changes-search-resource-id').value;
            const changeType = document.getElementById('changes-search-type').value;
            const date = document.getElementById('changes-search-date').value;

            content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                // è·å–æ‰€æœ‰èµ„æºï¼Œç„¶åè·å–æ¯ä¸ªèµ„æºçš„å˜åŠ¨è®°å½•
                const resourcesResult = await apiRequest('GET', '/api/resources');
                const resources = resourcesResult.data || [];

                let allChanges = [];

                // è·å–æ¯ä¸ªèµ„æºçš„å˜åŠ¨è®°å½•
                for (const resource of resources) {
                    const resourceIdCurrent = resource.ID || resource.id;
                    // å¦‚æœæŒ‡å®šäº†èµ„æºIDï¼Œåªè·å–è¯¥èµ„æºçš„å˜åŠ¨è®°å½•
                    if (resourceId && resourceId !== resourceIdCurrent.toString()) continue;

                    try {
                        const changesResult = await apiRequest('GET', `/api/resources/${resourceIdCurrent}/changes`);
                        const changes = changesResult.data || [];
                        changes.forEach(change => {
                            allChanges.push({
                                ...change,
                                resource_id: resourceIdCurrent,
                                resource_type: resource.ResourceType || resource.resource_type,
                                species_name: resource.SpeciesName || resource.species_name
                            });
                        });
                    } catch (error) {
                        console.warn(`è·å–èµ„æº ${resourceIdCurrent} çš„å˜åŠ¨è®°å½•å¤±è´¥:`, error);
                    }
                }

                // æŒ‰å˜åŠ¨ç±»å‹ç­›é€‰
                if (changeType) {
                    allChanges = allChanges.filter(change => {
                        const type = change.ChangeType || change.change_type;
                        return type === changeType;
                    });
                }

                // æŒ‰æ—¥æœŸç­›é€‰
                if (date) {
                    allChanges = allChanges.filter(change => {
                        const changeDate = new Date(change.changed_at || change.ChangedAt).toISOString().split('T')[0];
                        return changeDate === date;
                    });
                }

                // æŒ‰æ—¶é—´å€’åºæ’åº
                allChanges.sort((a, b) => new Date(b.change_time || b.ChangeTime) - new Date(a.change_time || a.ChangeTime));

                if (allChanges.length > 0) {
                    let html = '';
                    allChanges.forEach(change => {
                        const changeType = change.ChangeType || change.change_type;
                        const changeTime = new Date(change.changed_at || change.ChangedAt).toLocaleString();
                        const typeClass = getChangeTypeClass(changeType);

                        html += `
                            <div class="change-record">
                                <div class="change-type ${typeClass}">${getChangeTypeText(changeType)}</div>
                                <div class="change-info">
                                    <strong>èµ„æº${change.resource_id} (${change.resource_type} - ${change.species_name})</strong>
                                </div>
                                <div class="change-reason">${change.change_reason || change.ChangeReason || 'æ— åŸå› è¯´æ˜'}</div>
                                <div class="change-time">å˜åŠ¨æ—¶é—´: ${changeTime}</div>
                                <div class="change-details">
                                    ${change.change_amount ? `å˜åŠ¨æ•°é‡: ${change.change_amount}` : ''}
                                    ${change.change_area ? `å˜åŠ¨é¢ç§¯: ${change.change_area}ã¡` : ''}
                                </div>
                                <div class="change-operator">æ“ä½œäºº: ${change.operator_name || change.OperatorName || 'ç³»ç»Ÿ'}</div>
                            </div>
                        `;
                    });
                    content.innerHTML = html;
                } else {
                    content.innerHTML = '<div class="empty-state"><p>æš‚æ— å˜åŠ¨è®°å½•</p></div>';
                }

            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">åŠ è½½å˜åŠ¨è®°å½•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // è·å–å˜åŠ¨ç±»å‹å¯¹åº”çš„CSSç±»
        function getChangeTypeClass(changeType) {
            switch (changeType) {
                case 'NEW': return 'new';
                case 'REDUCE': return 'remove';
                case 'UPDATE': return 'update';
                default: return 'update';
            }
        }

        // è·å–å˜åŠ¨ç±»å‹çš„æ–‡æœ¬
        function getChangeTypeText(changeType) {
            switch (changeType) {
                case 'ADD': return 'æ–°å¢';
                case 'REDUCE': return 'å‡å°‘';
                case 'UPDATE': return 'çŠ¶æ€æ›´æ–°';
                default: return 'æœªçŸ¥';
            }
        }

        // é‡ç½®å˜åŠ¨è®°å½•æœç´¢
        function resetChangesSearch() {
            document.getElementById('changes-search-resource-id').value = '';
            document.getElementById('changes-search-type').value = '';
            document.getElementById('changes-search-date').value = '';
            loadResourceChanges();
        }

        // åŠ è½½è®¾å¤‡çŠ¶æ€è®°å½•
        async function loadDeviceStatus() {
            const content = document.getElementById('status-content');
            const deviceId = document.getElementById('status-search-device-id').value;
            const status = document.getElementById('status-search-status').value;
            const date = document.getElementById('status-search-date').value;

            content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                // è·å–æ‰€æœ‰è®¾å¤‡ï¼Œç„¶åè·å–æ¯ä¸ªè®¾å¤‡çš„çŠ¶æ€è®°å½•
                const devicesResult = await apiRequest('GET', '/api/devices');
                const devices = devicesResult.data || [];

                let allStatusRecords = [];

                // è·å–æ¯ä¸ªè®¾å¤‡çš„çŠ¶æ€è®°å½•
                for (const device of devices) {
                    const deviceIdCurrent = device.ID || device.id;
                    // å¦‚æœæŒ‡å®šäº†è®¾å¤‡IDï¼Œåªè·å–è¯¥è®¾å¤‡çš„çŠ¶æ€è®°å½•
                    if (deviceId && deviceId !== deviceIdCurrent.toString()) continue;

                    try {
                        const statusResult = await apiRequest('GET', `/api/devices/${deviceIdCurrent}/status/logs`);
                        const statusRecords = statusResult.data || [];
                        statusRecords.forEach(statusRecord => {
                            allStatusRecords.push({
                                ...statusRecord,
                                device_id: deviceIdCurrent,
                                device_name: device.Name || device.name,
                                device_type: device.Type || device.type
                            });
                        });
                    } catch (error) {
                        console.warn(`è·å–è®¾å¤‡ ${deviceIdCurrent} çš„çŠ¶æ€è®°å½•å¤±è´¥:`, error);
                    }
                }

                // æŒ‰çŠ¶æ€ç­›é€‰
                if (status) {
                    allStatusRecords = allStatusRecords.filter(record => {
                        const recordStatus = record.status || record.Status;
                        return recordStatus === status;
                    });
                }

                // æŒ‰æ—¥æœŸç­›é€‰
                if (date) {
                    allStatusRecords = allStatusRecords.filter(record => {
                        const recordDate = new Date(record.collected_at || record.CollectedAt).toISOString().split('T')[0];
                        return recordDate === date;
                    });
                }

                // æŒ‰æ—¶é—´å€’åºæ’åº
                allStatusRecords.sort((a, b) => new Date(b.record_time || b.RecordTime) - new Date(a.record_time || a.RecordTime));

                if (allStatusRecords.length > 0) {
                    let html = '';
                    allStatusRecords.forEach(record => {
                        const recordStatus = record.run_status || record.RunStatus || record.status || record.Status;
                        const recordTime = new Date(record.collected_at || record.CollectedAt).toLocaleString();
                        const statusClass = getDeviceStatusClass(recordStatus);

                        html += `
                            <div class="status-card">
                                <div class="status-indicator ${statusClass}"></div>
                                <div class="status-info">
                                    <strong>è®¾å¤‡${record.device_id} (${record.device_name} - ${record.device_type})</strong>
                                    <div class="status-text">${getDeviceStatusText(recordStatus)}</div>
                                    <div class="status-time">è®°å½•æ—¶é—´: ${recordTime}</div>
                                    ${record.notes ? `<div class="status-notes">å¤‡æ³¨: ${record.notes}</div>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    content.innerHTML = html;
                } else {
                    content.innerHTML = '<div class="empty-state"><p>æš‚æ— è®¾å¤‡çŠ¶æ€è®°å½•</p></div>';
                }

            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">åŠ è½½è®¾å¤‡çŠ¶æ€è®°å½•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½è®¾å¤‡ç»´æŠ¤è®°å½•
        async function loadDeviceMaintenance() {
            const content = document.getElementById('maintenance-content');
            const deviceId = document.getElementById('maintenance-search-device-id').value;
            const maintenanceType = document.getElementById('maintenance-search-type').value;
            const date = document.getElementById('maintenance-search-date').value;

            content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                // è·å–æ‰€æœ‰è®¾å¤‡ï¼Œç„¶åè·å–æ¯ä¸ªè®¾å¤‡çš„ç»´æŠ¤è®°å½•
                const devicesResult = await apiRequest('GET', '/api/devices');
                const devices = devicesResult.data || [];

                let allMaintenanceRecords = [];

                // è·å–æ¯ä¸ªè®¾å¤‡çš„ç»´æŠ¤è®°å½•
                for (const device of devices) {
                    const deviceIdCurrent = device.ID || device.id;
                    // å¦‚æœæŒ‡å®šäº†è®¾å¤‡IDï¼Œåªè·å–è¯¥è®¾å¤‡çš„ç»´æŠ¤è®°å½•
                    if (deviceId && deviceId !== deviceIdCurrent.toString()) continue;

                    try {
                        const maintenanceResult = await apiRequest('GET', `/api/devices/${deviceIdCurrent}/maintenance`);
                        const maintenanceRecords = maintenanceResult.data || [];
                        maintenanceRecords.forEach(record => {
                            allMaintenanceRecords.push({
                                ...record,
                                device_id: deviceIdCurrent,
                                device_name: device.Name || device.name,
                                device_type: device.Type || device.type
                            });
                        });
                    } catch (error) {
                        console.warn(`è·å–è®¾å¤‡ ${deviceIdCurrent} çš„ç»´æŠ¤è®°å½•å¤±è´¥:`, error);
                    }
                }

                // æŒ‰ç»´æŠ¤ç±»å‹ç­›é€‰
                if (maintenanceType) {
                    allMaintenanceRecords = allMaintenanceRecords.filter(record => {
                        const type = record.maintenance_type || record.MaintenanceType;
                        return type === maintenanceType;
                    });
                }

                // æŒ‰æ—¥æœŸç­›é€‰
                if (date) {
                    allMaintenanceRecords = allMaintenanceRecords.filter(record => {
                        const recordDate = new Date(record.maintenance_time || record.MaintenanceTime).toISOString().split('T')[0];
                        return recordDate === date;
                    });
                }

                // æŒ‰æ—¶é—´å€’åºæ’åº
                allMaintenanceRecords.sort((a, b) => new Date(b.maintenance_date || b.MaintenanceDate) - new Date(a.maintenance_date || a.MaintenanceDate));

                if (allMaintenanceRecords.length > 0) {
                    let html = '';
                    allMaintenanceRecords.forEach(record => {
                        const maintenanceType = record.maintenance_type || record.MaintenanceType;
                        const maintenanceDate = new Date(record.maintenance_time || record.MaintenanceTime).toLocaleString();

                        html += `
                            <div class="maintenance-record">
                                <div class="maintenance-info">
                                    <strong>è®¾å¤‡${record.device_id} (${record.device_name} - ${record.device_type})</strong>
                                    <div class="maintenance-type">ç»´æŠ¤ç±»å‹: ${getMaintenanceTypeText(maintenanceType)}</div>
                                    <div class="maintenance-date">ç»´æŠ¤æ—¶é—´: ${maintenanceDate}</div>
                                    <div class="maintenance-personnel">ç»´æŠ¤äººå‘˜: ${record.operator_name || record.OperatorName || 'æœªè®°å½•'}</div>
                                    ${record.description ? `<div class="maintenance-description">æè¿°: ${record.description}</div>` : ''}
                                    ${record.cost ? `<div class="maintenance-cost">è´¹ç”¨: Â¥${record.cost}</div>` : ''}
                                </div>
                                <div class="maintenance-actions">
                                    <button class="btn btn-sm btn-warning" onclick="openModal('maintenance-record', {device_id: ${record.device_id}, device_name: '${record.device_name}'})">è®°å½•ç»´æŠ¤</button>
                                </div>
                            </div>
                        `;
                    });
                    content.innerHTML = html;
                } else {
                    content.innerHTML = '<div class="empty-state"><p>æš‚æ— ç»´æŠ¤è®°å½•</p></div>';
                }

            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">åŠ è½½ç»´æŠ¤è®°å½•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // è·å–è®¾å¤‡çŠ¶æ€å¯¹åº”çš„CSSç±»
        function getDeviceStatusClass(status) {
            switch (status) {
                case 'NORMAL': return 'online';
                case 'FAULT': return 'error';
                case 'OFFLINE': return 'offline';
                case 'ONLINE': return 'online';
                case 'WARNING': return 'warning';
                case 'ERROR': return 'error';
                default: return 'offline';
            }
        }

        // è·å–è®¾å¤‡çŠ¶æ€çš„æ–‡æœ¬
        function getDeviceStatusText(status) {
            switch (status) {
                case 'NORMAL': return 'æ­£å¸¸';
                case 'FAULT': return 'æ•…éšœ';
                case 'OFFLINE': return 'ç¦»çº¿';
                case 'ONLINE': return 'åœ¨çº¿';
                case 'WARNING': return 'è­¦å‘Š';
                case 'ERROR': return 'æ•…éšœ';
                default: return 'æœªçŸ¥';
            }
        }

        // è·å–ç»´æŠ¤ç±»å‹çš„æ–‡æœ¬
        function getMaintenanceTypeText(type) {
            switch (type) {
                case 'REPAIR': return 'ç»´ä¿®';
                case 'REPLACE': return 'æ›´æ¢';
                case 'INSPECTION': return 'æ£€æŸ¥';
                case 'UPGRADE': return 'å‡çº§';
                case 'OTHER': return 'å…¶ä»–';
                default: return 'æœªçŸ¥';
            }
        }

        // é‡ç½®è®¾å¤‡çŠ¶æ€æœç´¢
        function resetStatusSearch() {
            document.getElementById('status-search-device-id').value = '';
            document.getElementById('status-search-status').value = '';
            document.getElementById('status-search-date').value = '';
            loadDeviceStatus();
        }

        // é‡ç½®ç»´æŠ¤è®°å½•æœç´¢
        function resetMaintenanceSearch() {
            document.getElementById('maintenance-search-device-id').value = '';
            document.getElementById('maintenance-search-type').value = '';
            document.getElementById('maintenance-search-date').value = '';
            loadDeviceMaintenance();
        }

        // ä¼ æ„Ÿå™¨æœç´¢åŠŸèƒ½
        function searchSensors() {
            const id = document.getElementById('sensors-search-id').value;
            const type = document.getElementById('sensors-search-type').value;
            const status = document.getElementById('sensors-search-status').value;
            loadSensors({ id, type, status });
        }

        // é‡ç½®ä¼ æ„Ÿå™¨æœç´¢
        function resetSensorsSearch() {
            document.getElementById('sensors-search-id').value = '';
            document.getElementById('sensors-search-type').value = '';
            document.getElementById('sensors-search-status').value = '';
            loadSensors();
        }

        // é¢„è­¦æœç´¢åŠŸèƒ½
        function searchAlerts() {
            const type = document.getElementById('alerts-search-type').value;
            const severity = document.getElementById('alerts-search-severity').value;
            const status = document.getElementById('alerts-search-status').value;
            loadAlerts({ type, severity, status });
        }

        // é‡ç½®é¢„è­¦æœç´¢
        function resetAlertsSearch() {
            document.getElementById('alerts-search-type').value = '';
            document.getElementById('alerts-search-severity').value = '';
            document.getElementById('alerts-search-status').value = '';
            loadAlerts();
        }

        // èµ„æºæœç´¢åŠŸèƒ½
        function searchResources() {
            const type = document.getElementById('resources-search-type').value;
            const stage = document.getElementById('resources-search-stage').value;
            const regionId = document.getElementById('resources-search-region-id').value;
            loadResources({ type, stage, region_id: regionId });
        }

        // é‡ç½®èµ„æºæœç´¢
        function resetResourcesSearch() {
            document.getElementById('resources-search-type').value = '';
            document.getElementById('resources-search-stage').value = '';
            document.getElementById('resources-search-region-id').value = '';
            loadResources();
        }

        // è®¾å¤‡æœç´¢åŠŸèƒ½
        function searchDevices() {
            const type = document.getElementById('devices-search-type').value;
            const regionId = document.getElementById('devices-search-region-id').value;
            const name = document.getElementById('devices-search-name').value;
            loadDevices({ type, region_id: regionId, name });
        }

        // é‡ç½®è®¾å¤‡æœç´¢
        function resetDevicesSearch() {
            document.getElementById('devices-search-type').value = '';
            document.getElementById('devices-search-region-id').value = '';
            document.getElementById('devices-search-name').value = '';
            loadDevices();
        }

        // æŠ¥è¡¨æœç´¢åŠŸèƒ½
        function searchReports() {
            const type = document.getElementById('reports-search-type').value;
            const templateId = document.getElementById('reports-search-template-id').value;
            const status = document.getElementById('reports-search-status').value;
            loadReports({ type, template_id: templateId, status });
        }

        // é‡ç½®æŠ¥è¡¨æœç´¢
        function resetReportsSearch() {
            document.getElementById('reports-search-type').value = '';
            document.getElementById('reports-search-template-id').value = '';
            document.getElementById('reports-search-status').value = '';
            loadReports();
        }

        function openModal(type, data = null) {
            currentEditId = null;
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            
            switch(type) {
                case 'region':
                    title.textContent = 'æ–°å¢åŒºåŸŸ';
                    body.innerHTML = getRegionForm();
                    break;
                case 'sensor':
                    title.textContent = 'æ–°å¢ä¼ æ„Ÿå™¨';
                    body.innerHTML = getSensorForm();
                    break;
                case 'alert-rule':
                    title.textContent = 'æ–°å¢é¢„è­¦è§„åˆ™';
                    body.innerHTML = getAlertRuleForm();
                    break;
                case 'alert':
                    title.textContent = 'æ–°å¢é¢„è­¦';
                    body.innerHTML = getAlertForm();
                    break;
                case 'resource':
                    title.textContent = 'æ–°å¢èµ„æº';
                    body.innerHTML = getResourceForm();
                    break;
                case 'device':
                    title.textContent = 'æ–°å¢è®¾å¤‡';
                    body.innerHTML = getDeviceForm();
                    break;
                case 'device-status':
                    title.textContent = 'è®°å½•è®¾å¤‡çŠ¶æ€';
                    body.innerHTML = getDeviceStatusForm();
                    break;
                case 'maintenance-record':
                    if (!data || !data.device_id) {
                        body.innerHTML = '<div class="alert alert-error">è¯·å…ˆé€‰æ‹©è¦ç»´æŠ¤çš„è®¾å¤‡</div>';
                        break;
                    }
                    title.textContent = 'è®°å½•ç»´æŠ¤ä¿¡æ¯';
                    body.innerHTML = getMaintenanceRecordForm(data);
                    break;
                case 'report-template':
                    title.textContent = 'æ–°å¢æŠ¥è¡¨æ¨¡æ¿';
                    body.innerHTML = getReportTemplateForm();
                    break;
                case 'report':
                    title.textContent = 'æ–°å¢æŠ¥è¡¨';
                    body.innerHTML = getReportForm();
                    break;
                case 'generate-report':
                    title.textContent = 'ç”ŸæˆæŠ¥è¡¨';
                    body.innerHTML = getGenerateReportForm();
                    break;
            }
            modal.style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            currentEditId = null;
        }


        // è¡¨å•ç”Ÿæˆå‡½æ•°
        function getRegionForm(data = null) {
            const name = data ? (data.Name || data.name || '') : '';
            const type = data ? (data.Type || data.type || 'FOREST') : 'FOREST';
            const latitude = data ? (data.Latitude !== undefined ? data.Latitude : (data.latitude !== undefined ? data.latitude : '')) : '';
            const longitude = data ? (data.Longitude !== undefined ? data.Longitude : (data.longitude !== undefined ? data.longitude : '')) : '';
            const managerId = data ? (data.ManagerID !== undefined ? data.ManagerID : (data.manager_id !== undefined ? data.manager_id : '')) : '';
            
            return `
                <form onsubmit="saveRegion(event)">
                    <div class="form-group">
                        <label>åŒºåŸŸåç§° *</label>
                        <input type="text" name="name" value="${name}" required>
                    </div>
                    <div class="form-group">
                        <label>åŒºåŸŸç±»å‹ *</label>
                        <select name="type" required>
                            <option value="FOREST" ${type === 'FOREST' ? 'selected' : ''}>æ£®æ—</option>
                            <option value="GRASSLAND" ${type === 'GRASSLAND' ? 'selected' : ''}>è‰åœ°</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>çº¬åº¦</label>
                        <input type="number" step="0.000001" name="latitude" value="${latitude}">
                    </div>
                    <div class="form-group">
                        <label>ç»åº¦</label>
                        <input type="number" step="0.000001" name="longitude" value="${longitude}">
                    </div>
                    <div class="form-group">
                        <label>è´Ÿè´£äººID</label>
                        <input type="number" name="manager_id" value="${managerId}">
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    </div>
                </form>
            `;
        }

        function getSensorForm(data = null) {
            const id = data ? (data.ID || data.id || '') : '';
            const regionId = data ? (data.RegionID || data.region_id || '') : '';
            const model = data ? (data.Model || data.model || '') : '';
            const monitorType = data ? (data.MonitorType || data.monitor_type || 'TEMPERATURE') : 'TEMPERATURE';
            const installTime = data && (data.InstallTime || data.install_time) ? 
                new Date(data.InstallTime || data.install_time).toISOString().slice(0, 16) : '';
            const protocol = data ? (data.Protocol || data.protocol || '') : '';
            const status = data ? (data.Status || data.status || 'ACTIVE') : 'ACTIVE';
            
            return `
                <form onsubmit="saveSensor(event)">
                    ${currentEditId ? `
                    <div class="form-group">
                        <label>ä¼ æ„Ÿå™¨ID *</label>
                        <input type="number" name="id" value="${id}" required readonly>
                    </div>` : ''}
                    <div class="form-group">
                        <label>åŒºåŸŸID *</label>
                        <input type="number" name="region_id" value="${regionId}" required>
                    </div>
                    <div class="form-group">
                        <label>å‹å·</label>
                        <input type="text" name="model" value="${model}">
                    </div>
                    <div class="form-group">
                        <label>ç›‘æµ‹ç±»å‹ *</label>
                        <select name="monitor_type" required>
                            <option value="TEMPERATURE" ${monitorType === 'TEMPERATURE' ? 'selected' : ''}>æ¸©åº¦</option>
                            <option value="HUMIDITY" ${monitorType === 'HUMIDITY' ? 'selected' : ''}>æ¹¿åº¦</option>
                            <option value="IMAGE" ${monitorType === 'IMAGE' ? 'selected' : ''}>å›¾åƒ</option>
                            <option value="OTHER" ${monitorType === 'OTHER' ? 'selected' : ''}>å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å®‰è£…æ—¶é—´</label>
                        <input type="datetime-local" name="install_time" value="${installTime}">
                    </div>
                    <div class="form-group">
                        <label>åè®®</label>
                        <input type="text" name="protocol" value="${protocol}">
                    </div>
                    <div class="form-group">
                        <label>çŠ¶æ€ *</label>
                        <select name="status" required>
                            <option value="ACTIVE" ${status === 'ACTIVE' ? 'selected' : ''}>æ¿€æ´»</option>
                            <option value="INACTIVE" ${status === 'INACTIVE' ? 'selected' : ''}>æœªæ¿€æ´»</option>
                        </select>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    </div>
                </form>
            `;
        }

        function getAlertRuleForm() {
            return `
                <form onsubmit="saveAlertRule(event)">
                    <div class="form-group">
                        <label>é¢„è­¦ç±»å‹ *</label>
                        <select name="alert_type" required>
                            <option value="FIRE">ç«ç¾</option>
                            <option value="DROUGHT">å¹²æ—±</option>
                            <option value="PEST">è™«å®³</option>
                            <option value="OTHER">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ¡ä»¶è¡¨è¾¾å¼ *</label>
                        <input type="text" name="condition_expr" placeholder="å¦‚: temp>=38 AND humidity<=20" required>
                    </div>
                    <div class="form-group">
                        <label>ä¸¥é‡ç¨‹åº¦ *</label>
                        <select name="severity_level" required>
                            <option value="GENERAL">ä¸€èˆ¬</option>
                            <option value="MODERATE">ä¸­ç­‰</option>
                            <option value="SEVERE">ä¸¥é‡</option>
                            <option value="CRITICAL">ç´§æ€¥</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ˜¯å¦æ¿€æ´»</label>
                        <select name="is_active">
                            <option value="true">æ˜¯</option>
                            <option value="false">å¦</option>
                        </select>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    </div>
                </form>
            `;
        }

        function getAlertForm() {
            return `
                <form onsubmit="saveAlert(event)">
                    <div class="form-group">
                        <label>è§„åˆ™ID *</label>
                        <input type="number" name="rule_id" required>
                    </div>
                    <div class="form-group">
                        <label>åŒºåŸŸID *</label>
                        <input type="number" name="region_id" required>
                    </div>
                    <div class="form-group">
                        <label>å†…å®¹</label>
                        <textarea name="content" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>çŠ¶æ€ *</label>
                        <select name="status" required>
                            <option value="PENDING">å¾…å¤„ç†</option>
                            <option value="PROCESSING">å¤„ç†ä¸­</option>
                            <option value="CLOSED">å·²å…³é—­</option>
                        </select>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    </div>
                </form>
            `;
        }

        function getResourceForm(data = null) {
            const resourceType = data ? (data.ResourceType || data.resource_type || 'TREE') : 'TREE';
            const regionId = data ? (data.RegionID || data.region_id || '') : '';
            const speciesName = data ? (data.SpeciesName || data.species_name || '') : '';
            const quantity = data ? (data.Quantity !== undefined ? data.Quantity : (data.quantity !== undefined ? data.quantity : '')) : '';
            const area = data ? (data.Area !== undefined ? data.Area : (data.area !== undefined ? data.area : '')) : '';
            const growthStage = data ? (data.GrowthStage || data.growth_stage || 'SEEDLING') : 'SEEDLING';
            const plantedAt = data && (data.PlantedAt || data.planted_at) ? 
                new Date(data.PlantedAt || data.planted_at).toISOString().split('T')[0] : '';
            
            return `
                <form onsubmit="saveResource(event)">
                    <div class="form-group">
                        <label>èµ„æºç±»å‹ *</label>
                        <select name="resource_type" required>
                            <option value="TREE" ${resourceType === 'TREE' ? 'selected' : ''}>æ ‘æœ¨</option>
                            <option value="GRASS" ${resourceType === 'GRASS' ? 'selected' : ''}>è‰åœ°</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>åŒºåŸŸID *</label>
                        <input type="number" name="region_id" value="${regionId}" required>
                    </div>
                    <div class="form-group">
                        <label>å“ç§åç§° *</label>
                        <input type="text" name="species_name" value="${speciesName}" required>
                    </div>
                    <div class="form-group">
                        <label>æ•°é‡ï¼ˆæ ‘æœ¨ï¼‰</label>
                        <input type="number" name="quantity" value="${quantity}">
                    </div>
                    <div class="form-group">
                        <label>é¢ç§¯ï¼ˆè‰åœ°ï¼Œã¡ï¼‰</label>
                        <input type="number" step="0.01" name="area" value="${area}">
                    </div>
                    <div class="form-group">
                        <label>ç”Ÿé•¿é˜¶æ®µ *</label>
                        <select name="growth_stage" required>
                            <option value="SEEDLING" ${growthStage === 'SEEDLING' ? 'selected' : ''}>å¹¼è‹—</option>
                            <option value="GROWING" ${growthStage === 'GROWING' ? 'selected' : ''}>æˆé•¿æœŸ</option>
                            <option value="MATURE" ${growthStage === 'MATURE' ? 'selected' : ''}>æˆç†ŸæœŸ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç§æ¤æ—¶é—´</label>
                        <input type="date" name="planted_at" value="${plantedAt}">
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    </div>
                </form>
            `;
        }

        function getDeviceForm(data = null) {
            const id = data ? (data.ID || data.id || '') : '';
            const name = data ? (data.Name || data.name || '') : '';
            const type = data ? (data.Type || data.type || 'SENSOR') : 'SENSOR';
            const modelSpec = data ? (data.ModelSpec || data.model_spec || '') : '';
            const purchasedAt = data && (data.PurchasedAt || data.purchased_at) ? 
                new Date(data.PurchasedAt || data.purchased_at).toISOString().split('T')[0] : '';
            const installRegionId = data ? (data.InstallRegionID !== undefined ? data.InstallRegionID : (data.install_region_id !== undefined ? data.install_region_id : '')) : '';
            const installerId = data ? (data.InstallerID !== undefined ? data.InstallerID : (data.installer_id !== undefined ? data.installer_id : '')) : '';
            const warrantyUntil = data && (data.WarrantyUntil || data.warranty_until) ? 
                new Date(data.WarrantyUntil || data.warranty_until).toISOString().split('T')[0] : '';
            
            return `
                <form onsubmit="saveDevice(event)">
                    ${currentEditId ? `
                    <div class="form-group">
                        <label>è®¾å¤‡ID *</label>
                        <input type="number" name="id" value="${id}" required readonly>
                    </div>` : ''}
                    <div class="form-group">
                        <label>è®¾å¤‡åç§° *</label>
                        <input type="text" name="name" value="${name}" required>
                    </div>
                    <div class="form-group">
                        <label>è®¾å¤‡ç±»å‹ *</label>
                        <select name="type" required>
                            <option value="SENSOR" ${type === 'SENSOR' ? 'selected' : ''}>ä¼ æ„Ÿå™¨</option>
                            <option value="CAMERA" ${type === 'CAMERA' ? 'selected' : ''}>æ‘„åƒå¤´</option>
                            <option value="ALERTER" ${type === 'ALERTER' ? 'selected' : ''}>æŠ¥è­¦å™¨</option>
                            <option value="OTHER" ${type === 'OTHER' ? 'selected' : ''}>å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å‹å·è§„æ ¼</label>
                        <input type="text" name="model_spec" value="${modelSpec}">
                    </div>
                    <div class="form-group">
                        <label>è´­ä¹°æ—¥æœŸ</label>
                        <input type="date" name="purchased_at" value="${purchasedAt}">
                    </div>
                    <div class="form-group">
                        <label>å®‰è£…åŒºåŸŸID</label>
                        <input type="number" name="install_region_id" value="${installRegionId}">
                    </div>
                    <div class="form-group">
                        <label>å®‰è£…äººå‘˜ID</label>
                        <input type="number" name="installer_id" value="${installerId}">
                    </div>
                    <div class="form-group">
                        <label>ä¿ä¿®åˆ°æœŸæ—¥</label>
                        <input type="date" name="warranty_until" value="${warrantyUntil}">
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    </div>
                </form>
            `;
        }

        function getDeviceStatusForm(data = null) {
            const deviceId = data ? (data.device_id || '') : '';
            const runStatus = data ? (data.run_status || 'NORMAL') : 'NORMAL';
            const batteryPercent = data ? (data.battery_percent || '') : '';
            const signalStrength = data ? (data.signal_strength || '') : '';

            return `
                <form onsubmit="saveDeviceStatus(event)">
                    <div class="form-group">
                        <label>è®¾å¤‡ID *</label>
                        <input type="number" name="device_id" value="${deviceId}" required>
                    </div>
                    <div class="form-group">
                        <label>è¿è¡ŒçŠ¶æ€ *</label>
                        <select name="run_status" required>
                            <option value="NORMAL" ${runStatus === 'NORMAL' ? 'selected' : ''}>æ­£å¸¸</option>
                            <option value="FAULT" ${runStatus === 'FAULT' ? 'selected' : ''}>æ•…éšœ</option>
                            <option value="OFFLINE" ${runStatus === 'OFFLINE' ? 'selected' : ''}>ç¦»çº¿</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç”µæ± ç”µé‡ (%)</label>
                        <input type="number" name="battery_percent" value="${batteryPercent}" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label>ä¿¡å·å¼ºåº¦</label>
                        <input type="number" name="signal_strength" value="${signalStrength}" min="0" max="100">
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    </div>
                </form>
            `;
        }

        function getMaintenanceRecordForm(data = null) {
            const deviceId = data ? data.device_id : '';
            const deviceName = data ? data.device_name : '';
            const maintenanceType = data ? (data.maintenance_type || 'INSPECTION') : 'INSPECTION';
            const content = data ? (data.content || '') : '';
            const result = data ? (data.result || '') : '';

            return `
                <form onsubmit="saveMaintenanceRecord(event)">
                    <div class="form-group">
                        <label>è®¾å¤‡ä¿¡æ¯</label>
                        <input type="text" value="è®¾å¤‡${deviceId} (${deviceName})" readonly style="background-color: #f8f9fa;">
                        <input type="hidden" name="device_id" value="${deviceId}">
                    </div>
                    <div class="form-group">
                        <label>ç»´æŠ¤ç±»å‹ *</label>
                        <select name="maintenance_type" required>
                            <option value="INSPECTION" ${maintenanceType === 'INSPECTION' ? 'selected' : ''}>æ£€æŸ¥</option>
                            <option value="REPAIR" ${maintenanceType === 'REPAIR' ? 'selected' : ''}>ç»´ä¿®</option>
                            <option value="REPLACE" ${maintenanceType === 'REPLACE' ? 'selected' : ''}>æ›´æ¢</option>
                            <option value="UPGRADE" ${maintenanceType === 'UPGRADE' ? 'selected' : ''}>å‡çº§</option>
                            <option value="OTHER" ${maintenanceType === 'OTHER' ? 'selected' : ''}>å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç»´æŠ¤å†…å®¹</label>
                        <textarea name="content" rows="3" placeholder="è¯·æè¿°ç»´æŠ¤çš„å…·ä½“å†…å®¹">${content}</textarea>
                    </div>
                    <div class="form-group">
                        <label>ç»´æŠ¤ç»“æœ</label>
                        <textarea name="result" rows="3" placeholder="è¯·æè¿°ç»´æŠ¤åçš„ç»“æœ">${result}</textarea>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    </div>
                </form>
            `;
        }

        function getReportTemplateForm() {
            return `
                <form onsubmit="saveReportTemplate(event)">
                    <div class="form-group">
                        <label>æ¨¡æ¿åç§° *</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>ç»´åº¦ *</label>
                        <select name="dimension" required>
                            <option value="REGION">åŒºåŸŸ</option>
                            <option value="TIME">æ—¶é—´</option>
                            <option value="TYPE">ç±»å‹</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æŒ‡æ ‡ *</label>
                        <input type="text" name="metrics" placeholder="å¦‚: avg_temp,avg_humidity" required>
                    </div>
                    <div class="form-group">
                        <label>å‘¨æœŸ *</label>
                        <select name="cycle" required>
                            <option value="DAY">æ—¥</option>
                            <option value="WEEK">å‘¨</option>
                            <option value="MONTH">æœˆ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ˜¯å¦æ¿€æ´»</label>
                        <select name="is_active">
                            <option value="true">æ˜¯</option>
                            <option value="false">å¦</option>
                        </select>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    </div>
                </form>
            `;
        }

        function getReportForm() {
            return `
                <form onsubmit="saveReport(event)">
                    <div class="form-group">
                        <label>æ¨¡æ¿ID *</label>
                        <input type="number" name="template_id" required>
                    </div>
                    <div class="form-group">
                        <label>å‘¨æœŸ *</label>
                        <input type="text" name="period" placeholder="å¦‚: 2025-12" required>
                    </div>
                    <div class="form-group">
                        <label>æ–‡ä»¶è·¯å¾„ *</label>
                        <input type="text" name="file_path" required>
                    </div>
                    <div class="form-group">
                        <label>æ•°æ®æº</label>
                        <input type="text" name="data_source">
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    </div>
                </form>
            `;
        }

        function getGenerateReportForm() {
            return `
                <form onsubmit="generateReport(event)">
                    <div class="form-group">
                        <label>æ¨¡æ¿ID *</label>
                        <input type="number" name="template_id" required>
                    </div>
                    <div class="form-group">
                        <label>å‘¨æœŸ *</label>
                        <input type="text" name="period" placeholder="å¦‚: 2025-12" required>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-warning">ç”ŸæˆæŠ¥è¡¨</button>
                    </div>
                </form>
            `;
        }

        // ä¿å­˜å‡½æ•°
        async function saveRegion(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                type: formData.get('type'),
                latitude: formData.get('latitude') ? parseFloat(formData.get('latitude')) : null,
                longitude: formData.get('longitude') ? parseFloat(formData.get('longitude')) : null,
                managerID: formData.get('manager_id') ? parseInt(formData.get('manager_id')) : null,
            };
            try {
                if (currentEditId) {
                    await apiRequest('PUT', `/api/regions/${currentEditId}`, data);
                    showAlert('åŒºåŸŸæ›´æ–°æˆåŠŸï¼', 'success');
                } else {
                    await apiRequest('POST', '/api/regions', data);
                    showAlert('åŒºåŸŸåˆ›å»ºæˆåŠŸï¼', 'success');
                }
                closeModal();
                currentEditId = null;
                loadRegions();
            } catch (error) {
                showAlert((currentEditId ? 'æ›´æ–°' : 'åˆ›å»º') + 'å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function saveSensor(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const installTime = formData.get('install_time');

            if (currentEditId) {
                // ç¼–è¾‘æ¨¡å¼
                const data = {
                    id: currentEditId,
                    region_id: parseInt(formData.get('region_id')),
                    model: formData.get('model') || '',
                    monitor_type: formData.get('monitor_type'),
                    install_time: installTime ? new Date(installTime) : new Date(),
                    protocol: formData.get('protocol') || '',
                    status: formData.get('status'),
                };
                try {
                    await apiRequest('PUT', `/api/sensors/${currentEditId}`, data);
                    showAlert('ä¼ æ„Ÿå™¨æ›´æ–°æˆåŠŸï¼', 'success');
                } catch (error) {
                    showAlert('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
                    return;
                }
            } else {
                // æ–°å¢æ¨¡å¼ - ä¸ä¼ é€’IDï¼Œè®©æ•°æ®åº“å¤„ç†
                const data = {
                    region_id: parseInt(formData.get('region_id')),
                    model: formData.get('model') || '',
                    monitor_type: formData.get('monitor_type'),
                    install_time: installTime ? new Date(installTime) : new Date(),
                    protocol: formData.get('protocol') || '',
                    status: formData.get('status'),
                };
                try {
                    await apiRequest('POST', '/api/sensors', data);
                    showAlert('ä¼ æ„Ÿå™¨åˆ›å»ºæˆåŠŸï¼', 'success');
                } catch (error) {
                    showAlert('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
                    return;
                }
            }

            closeModal();
            currentEditId = null;
            loadSensors();
        }

        async function saveAlertRule(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                alert_type: formData.get('alert_type'),
                condition_expr: formData.get('condition_expr'),
                severity_level: formData.get('severity_level'),
                is_active: formData.get('is_active') !== 'false', // é»˜è®¤ä¸ºtrue
            };
            try {
                await apiRequest('POST', '/api/alert-rules', data);
                showAlert('alerts', 'é¢„è­¦è§„åˆ™åˆ›å»ºæˆåŠŸï¼', 'success');
                closeModal();
                loadAlerts();
            } catch (error) {
                showAlert('alerts', 'åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function saveAlert(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                rule_id: parseInt(formData.get('rule_id')),
                region_id: parseInt(formData.get('region_id')),
                triggered_at: new Date(),
                content: formData.get('content') || '',
                status: formData.get('status'),
            };
            try {
                await apiRequest('POST', '/api/alerts', data);
                showAlert('alerts', 'é¢„è­¦åˆ›å»ºæˆåŠŸï¼', 'success');
                closeModal();
                loadAlerts();
            } catch (error) {
                showAlert('alerts', 'åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function saveResource(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const plantedAt = formData.get('planted_at');
            const data = {
                resource_type: formData.get('resource_type'),
                region_id: parseInt(formData.get('region_id')),
                species_name: formData.get('species_name'),
                quantity: formData.get('quantity') ? parseInt(formData.get('quantity')) : null,
                area: formData.get('area') ? parseFloat(formData.get('area')) : null,
                growth_stage: formData.get('growth_stage'),
                planted_at: plantedAt ? new Date(plantedAt) : null,
            };
            try {
                if (currentEditId) {
                    await apiRequest('PUT', `/api/resources/${currentEditId}`, data);
                    showAlert('resources', 'èµ„æºæ›´æ–°æˆåŠŸï¼', 'success');
                } else {
                    await apiRequest('POST', '/api/resources', data);
                    showAlert('resources', 'èµ„æºåˆ›å»ºæˆåŠŸï¼', 'success');
                }
                closeModal();
                currentEditId = null;
                loadResources();
            } catch (error) {
                showAlert('resources', (currentEditId ? 'æ›´æ–°' : 'åˆ›å»º') + 'å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function saveDevice(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const purchasedAt = formData.get('purchased_at');
            const warrantyUntil = formData.get('warranty_until');

            if (currentEditId) {
                // ç¼–è¾‘æ¨¡å¼
                const data = {
                    id: currentEditId,
                    name: formData.get('name'),
                    type: formData.get('type'),
                    model_spec: formData.get('model_spec') || null,
                    purchased_at: purchasedAt ? new Date(purchasedAt) : null,
                    install_region_id: formData.get('install_region_id') ? parseInt(formData.get('install_region_id')) : null,
                    installer_id: formData.get('installer_id') ? parseInt(formData.get('installer_id')) : null,
                    warranty_until: warrantyUntil ? new Date(warrantyUntil) : null,
                };
                try {
                    await apiRequest('PUT', `/api/devices/${currentEditId}`, data);
                    showAlert('devices', 'è®¾å¤‡æ›´æ–°æˆåŠŸï¼', 'success');
                } catch (error) {
                    showAlert('devices', 'æ›´æ–°å¤±è´¥: ' + error.message, 'error');
                    return;
                }
            } else {
                // æ–°å¢æ¨¡å¼ - ä¸ä¼ é€’ID
                const data = {
                    name: formData.get('name'),
                    type: formData.get('type'),
                    model_spec: formData.get('model_spec') || null,
                    purchased_at: purchasedAt ? new Date(purchasedAt) : null,
                    install_region_id: formData.get('install_region_id') ? parseInt(formData.get('install_region_id')) : null,
                    installer_id: formData.get('installer_id') ? parseInt(formData.get('installer_id')) : null,
                    warranty_until: warrantyUntil ? new Date(warrantyUntil) : null,
                };
                try {
                    await apiRequest('POST', '/api/devices', data);
                    showAlert('devices', 'è®¾å¤‡åˆ›å»ºæˆåŠŸï¼', 'success');
                } catch (error) {
                    showAlert('devices', 'åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
                    return;
                }
            }

            closeModal();
            currentEditId = null;
            loadDevices();
        }

        async function saveDeviceStatus(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            const data = {
                device_id: parseInt(formData.get('device_id')),
                run_status: formData.get('run_status'),
                battery_percent: formData.get('battery_percent') ? parseInt(formData.get('battery_percent')) : null,
                signal_strength: formData.get('signal_strength') ? parseInt(formData.get('signal_strength')) : null,
            };

            try {
                await apiRequest('POST', `/api/devices/${data.device_id}/status`, data);
                showAlert('status', 'è®¾å¤‡çŠ¶æ€è®°å½•æˆåŠŸï¼', 'success');
                closeModal();
                loadDeviceStatus();
            } catch (error) {
                showAlert('status', 'è®°å½•å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function saveMaintenanceRecord(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            const data = {
                device_id: parseInt(formData.get('device_id')),
                maintenance_type: formData.get('maintenance_type'),
                content: formData.get('content') || null,
                result: formData.get('result') || null,
            };

            try {
                await apiRequest('POST', `/api/devices/${data.device_id}/maintenance`, data);
                showAlert('maintenance', 'ç»´æŠ¤è®°å½•åˆ›å»ºæˆåŠŸï¼', 'success');
                closeModal();
                loadDeviceMaintenance();
            } catch (error) {
                showAlert('maintenance', 'åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function saveReportTemplate(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                dimension: formData.get('dimension'),
                metrics: formData.get('metrics'),
                cycle: formData.get('cycle'),
                is_active: formData.get('is_active') === 'true',
            };
            try {
                await apiRequest('POST', '/api/report-templates', data);
                showAlert('reports', 'æŠ¥è¡¨æ¨¡æ¿åˆ›å»ºæˆåŠŸï¼', 'success');
                closeModal();
                loadReports();
            } catch (error) {
                showAlert('reports', 'åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function saveReport(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                template_id: parseInt(formData.get('template_id')),
                period: formData.get('period'),
                file_path: formData.get('file_path'),
                data_source: formData.get('data_source') || null,
            };
            try {
                await apiRequest('POST', '/api/reports', data);
                showAlert('reports', 'æŠ¥è¡¨åˆ›å»ºæˆåŠŸï¼', 'success');
                closeModal();
                loadReports();
            } catch (error) {
                showAlert('reports', 'åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function generateReport(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                template_id: parseInt(formData.get('template_id')),
                period: formData.get('period'),
            };
            try {
                const result = await apiRequest('POST', '/api/reports/generate', data);
                showAlert('æŠ¥è¡¨ç”ŸæˆæˆåŠŸï¼', 'success');
                closeModal();
                loadReports();
            } catch (error) {
                showAlert('ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½æ•°æ®å‡½æ•°
        async function loadSensors(searchParams = {}) {
            const content = document.getElementById('sensors-content');
            content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            try {
                // æ„å»ºæŸ¥è¯¢å‚æ•°
                let queryString = '';
                const params = [];
                if (searchParams.id && searchParams.id.trim() !== '') params.push(`sensor_id=${encodeURIComponent(searchParams.id)}`);
                if (searchParams.type && searchParams.type !== 'æ‰€æœ‰ç±»å‹') params.push(`monitor_type=${encodeURIComponent(searchParams.type)}`);
                if (searchParams.status && searchParams.status !== 'æ‰€æœ‰çŠ¶æ€') params.push(`status=${encodeURIComponent(searchParams.status)}`);
                if (params.length > 0) queryString = '?' + params.join('&');
                
                const result = await apiRequest('GET', `/api/sensors${queryString}`);
                const sensors = result.data || result;
                if (Array.isArray(sensors) && sensors.length > 0) {
                    let html = '<table><thead><tr><th>ID</th><th>åŒºåŸŸID</th><th>å‹å·</th><th>ç›‘æµ‹ç±»å‹</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead><tbody>';
                    sensors.forEach(sensor => {
                        const sensorId = sensor.ID || sensor.id;
                        const monitorType = sensor.MonitorType || sensor.monitor_type;
                        const status = sensor.Status || sensor.status;
                        
                        html += `<tr>
                            <td>${sensorId}</td>
                            <td>${sensor.RegionID || sensor.region_id}</td>
                            <td>${sensor.Model || sensor.model || '-'}</td>
                            <td>${monitorType}</td>
                            <td><span style="color: ${status === 'ACTIVE' ? 'green' : 'red'}">${status}</span></td>
                            <td>
                                <button class="btn btn-secondary" onclick="editSensor(${sensorId})">ç¼–è¾‘</button>
                                <button class="btn btn-danger" onclick="deleteSensor(${sensorId})">åˆ é™¤</button>
                            </td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = '<div class="empty-state"><p>æš‚æ— æ•°æ®</p></div>';
                }
            } catch (error) {
                content.innerHTML = '<div class="empty-state"><p>åŠ è½½å¤±è´¥</p></div>';
                showAlert(`åŠ è½½ä¼ æ„Ÿå™¨æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è·å–ä¸¥é‡ç¨‹åº¦å¯¹åº”çš„é¢œè‰²
        function getSeverityColor(severity) {
            switch (severity) {
                case 'CRITICAL': return 'red';
                case 'SEVERE': return 'orange';
                case 'MODERATE': return 'yellow';
                case 'GENERAL': return 'blue';
                default: return 'gray';
            }
        }

        // è·å–çŠ¶æ€å¯¹åº”çš„é¢œè‰²
        function getStatusColor(status) {
            switch (status) {
                case 'CLOSED': return 'green';
                case 'PROCESSING': return 'orange';
                case 'PENDING': return 'red';
                default: return 'gray';
            }
        }

        // åŠ è½½é¢„è­¦æ•°æ®
        async function loadAlerts(searchParams = {}) {
            const content = document.getElementById('alerts-content');
            content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            try {
                // æ„å»ºæŸ¥è¯¢å‚æ•°
                let rulesQueryString = '';
                let alertsQueryString = '';
                const rulesParams = [];
                const alertsParams = [];
                
                // æ„å»ºé¢„è­¦è§„åˆ™æŸ¥è¯¢å‚æ•°
                if (searchParams.type && searchParams.type !== 'æ‰€æœ‰ç±»å‹') rulesParams.push(`alert_type=${encodeURIComponent(searchParams.type)}`);
                if (searchParams.severity && searchParams.severity !== 'æ‰€æœ‰ä¸¥é‡ç¨‹åº¦') rulesParams.push(`severity_level=${encodeURIComponent(searchParams.severity)}`);
                if (rulesParams.length > 0) rulesQueryString = '?' + rulesParams.join('&');
                
                // æ„å»ºé¢„è­¦è®°å½•æŸ¥è¯¢å‚æ•°
                if (searchParams.status && searchParams.status !== 'æ‰€æœ‰çŠ¶æ€') alertsParams.push(`status=${encodeURIComponent(searchParams.status)}`);
                if (searchParams.type && searchParams.type !== 'æ‰€æœ‰ç±»å‹') alertsParams.push(`alert_type=${encodeURIComponent(searchParams.type)}`);
                if (alertsParams.length > 0) alertsQueryString = '?' + alertsParams.join('&');
                
                const [rulesResult, alertsResult] = await Promise.all([
                    apiRequest('GET', `/api/alert-rules${rulesQueryString}`),
                    apiRequest('GET', `/api/alerts${alertsQueryString}`)
                ]);
                let html = '<h3>é¢„è­¦è§„åˆ™</h3>';
                
                const rules = rulesResult.data || rulesResult;
                if (Array.isArray(rules) && rules.length > 0) {
                    html += '<table><thead><tr><th>ID</th><th>ç±»å‹</th><th>æ¡ä»¶</th><th>ä¸¥é‡ç¨‹åº¦</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead><tbody>';
                    rules.forEach(rule => {
                        const ruleId = rule.ID || rule.id;
                        const isActive = rule.IsActive !== undefined ? rule.IsActive : rule.is_active;
                        html += `<tr>
                            <td>${ruleId}</td>
                            <td>${rule.AlertType || rule.alert_type}</td>
                            <td>${rule.ConditionExpr || rule.condition_expr}</td>
                            <td>${rule.SeverityLevel || rule.severity_level}</td>
                            <td><span style="color: ${isActive ? 'green' : 'red'}">${isActive ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'}</span></td>
                            <td>
                                <button class="btn btn-danger" onclick="deleteAlertRule(${ruleId})">åˆ é™¤</button>
                            </td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                } else {
                    html += '<div class="empty-state"><p>æš‚æ— é¢„è­¦è§„åˆ™</p></div>';
                }
                
                html += '<h3 style="margin-top: 30px;">é¢„è­¦è®°å½•</h3>';
                const alerts = alertsResult.data || alertsResult;
                if (Array.isArray(alerts) && alerts.length > 0) {
                    html += '<table><thead><tr><th>ID</th><th>è§„åˆ™ID</th><th>åŒºåŸŸID</th><th>å†…å®¹</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead><tbody>';
                    alerts.forEach(alert => {
                        const alertId = alert.ID || alert.id;
                        const status = alert.Status || alert.status;
                        html += `<tr>
                            <td>${alertId}</td>
                            <td>${alert.RuleID || alert.rule_id}</td>
                            <td>${alert.RegionID || alert.region_id}</td>
                            <td>${alert.Content || alert.content || '-'}</td>
                            <td><span style="color: ${getStatusColor(status)}">${status}</span></td>
                            <td>
                                <button class="btn btn-danger" onclick="deleteAlert(${alertId})">åˆ é™¤</button>
                            </td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                } else {
                    html += '<div class="empty-state"><p>æš‚æ— é¢„è­¦è®°å½•</p></div>';
                }
                content.innerHTML = html;
            } catch (error) {
                content.innerHTML = '<div class="empty-state"><p>åŠ è½½å¤±è´¥</p></div>';
                showAlert(`åŠ è½½é¢„è­¦æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function loadResources(searchParams = {}) {
            const content = document.getElementById('resources-content');
            content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            try {
                // æ„å»ºæŸ¥è¯¢å‚æ•°
                let queryString = '';
                const params = [];
                if (searchParams.type && searchParams.type !== 'æ‰€æœ‰ç±»å‹') params.push(`resource_type=${encodeURIComponent(searchParams.type)}`);
                if (searchParams.stage && searchParams.stage !== 'æ‰€æœ‰é˜¶æ®µ') params.push(`growth_stage=${encodeURIComponent(searchParams.stage)}`);
                if (searchParams.region_id && searchParams.region_id.trim() !== '') params.push(`region_id=${encodeURIComponent(searchParams.region_id)}`);
                if (params.length > 0) queryString = '?' + params.join('&');
                
                const result = await apiRequest('GET', `/api/resources${queryString}`);
                if (result.data && result.data.length > 0) {
                    let html = '<table><thead><tr><th>ID</th><th>ç±»å‹</th><th>åŒºåŸŸID</th><th>å“ç§</th><th>æ•°é‡/é¢ç§¯</th><th>ç”Ÿé•¿é˜¶æ®µ</th><th>æ“ä½œ</th></tr></thead><tbody>';
                    result.data.forEach(resource => {
                        const resourceId = resource.ID || resource.id;
                        const qty = resource.quantity || resource.area || '-';
                        html += `<tr>
                            <td>${resourceId}</td>
                            <td>${resource.ResourceType || resource.resource_type}</td>
                            <td>${resource.RegionID || resource.region_id}</td>
                            <td>${resource.SpeciesName || resource.species_name}</td>
                            <td>${qty}</td>
                            <td>${resource.GrowthStage || resource.growth_stage}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="editResource(${resourceId})">ç¼–è¾‘</button>
                                <button class="btn btn-danger" onclick="deleteResource(${resourceId})">åˆ é™¤</button>
                            </td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = '<div class="empty-state"><p>æš‚æ— æ•°æ®</p></div>';
                }
            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function loadDevices(searchParams = {}) {
            const content = document.getElementById('devices-content');
            content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            try {
                // æ„å»ºæŸ¥è¯¢å‚æ•°
                let queryString = '';
                const params = [];
                if (searchParams.type && searchParams.type !== 'æ‰€æœ‰ç±»å‹') params.push(`type=${encodeURIComponent(searchParams.type)}`);
                if (searchParams.region_id && searchParams.region_id.trim() !== '') params.push(`install_region_id=${encodeURIComponent(searchParams.region_id)}`);
                if (searchParams.name && searchParams.name.trim() !== '') params.push(`name=${encodeURIComponent(searchParams.name)}`);
                if (params.length > 0) queryString = '?' + params.join('&');
                
                const result = await apiRequest('GET', `/api/devices${queryString}`);
                if (result.data && result.data.length > 0) {
                    let html = '<table><thead><tr><th>ID</th><th>åç§°</th><th>ç±»å‹</th><th>å‹å·</th><th>å®‰è£…åŒºåŸŸ</th><th>æ“ä½œ</th></tr></thead><tbody>';
                    result.data.forEach(device => {
                        const deviceId = device.ID || device.id;
                        html += `<tr>
                            <td>${deviceId}</td>
                            <td>${device.Name || device.name}</td>
                            <td>${device.Type || device.type}</td>
                            <td>${device.ModelSpec || device.model_spec || '-'}</td>
                            <td>${device.InstallRegionID || device.install_region_id || '-'}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="editDevice(${deviceId})">ç¼–è¾‘</button>
                                <button class="btn btn-danger" onclick="deleteDevice(${deviceId})">åˆ é™¤</button>
                            </td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = '<div class="empty-state"><p>æš‚æ— æ•°æ®</p></div>';
                }
            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function loadReports(searchParams = {}) {
            const content = document.getElementById('reports-content');
            content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            try {
                // æ„å»ºæŸ¥è¯¢å‚æ•°
                let templatesQueryString = '';
                let reportsQueryString = '';
                const templatesParams = [];
                const reportsParams = [];
                
                // æ„å»ºæŠ¥è¡¨æ¨¡æ¿æŸ¥è¯¢å‚æ•°
                if (searchParams.type) templatesParams.push(`cycle=${encodeURIComponent(searchParams.type)}`);
                if (templatesParams.length > 0) templatesQueryString = '?' + templatesParams.join('&');
                
                // æ„å»ºç”Ÿæˆçš„æŠ¥è¡¨æŸ¥è¯¢å‚æ•°
                if (searchParams.template_id) reportsParams.push(`template_id=${encodeURIComponent(searchParams.template_id)}`);
                if (searchParams.type) reportsParams.push(`type=${encodeURIComponent(searchParams.type)}`);
                if (searchParams.status) reportsParams.push(`status=${encodeURIComponent(searchParams.status)}`);
                if (reportsParams.length > 0) reportsQueryString = '?' + reportsParams.join('&');
                
                const [templatesResult, reportsResult] = await Promise.all([
                    apiRequest('GET', `/api/report-templates${templatesQueryString}`),
                    apiRequest('GET', `/api/reports${reportsQueryString}`)
                ]);
                let html = '<h3>æŠ¥è¡¨æ¨¡æ¿</h3>';
                if (templatesResult.data && templatesResult.data.length > 0) {
                    html += '<table><thead><tr><th>ID</th><th>åç§°</th><th>ç»´åº¦</th><th>å‘¨æœŸ</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead><tbody>';
                    templatesResult.data.forEach(template => {
                        const templateId = template.id;
                        html += `<tr>
                            <td>${templateId}</td>
                            <td>${template.name}</td>
                            <td>${template.dimension}</td>
                            <td>${template.cycle}</td>
                            <td>${template.is_active ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="viewReportTemplate(${templateId})">æŸ¥çœ‹</button>
                                <button class="btn btn-danger" onclick="deleteReportTemplate(${templateId})">åˆ é™¤</button>
                            </td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                }
                html += '<h3 style="margin-top: 30px;">æŠ¥è¡¨åˆ—è¡¨</h3>';
                if (reportsResult.data && reportsResult.data.length > 0) {
                    html += '<table><thead><tr><th>ID</th><th>æ¨¡æ¿ID</th><th>å‘¨æœŸ</th><th>ç”Ÿæˆæ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>';
                    reportsResult.data.forEach(report => {
                        const reportId = report.ID || report.id || 'æœªçŸ¥';
                        const templateId = report.template_id || report.TemplateID || 'æœªçŸ¥';
                        const period = report.period || report.Period || 'æœªçŸ¥';
                        const generatedAt = report.generated_at || report.GeneratedAt || 'æœªçŸ¥';
                        html += `<tr>
                            <td>${reportId}</td>
                            <td>${templateId}</td>
                            <td>${period}</td>
                            <td>${generatedAt}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="viewReport(${reportId})">æŸ¥çœ‹</button>
                                <button class="btn btn-success" onclick="exportReport(${reportId}, 'excel')">å¯¼å‡ºExcel</button>
                                <button class="btn btn-danger" onclick="deleteReport(${reportId})">åˆ é™¤</button>
                            </td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                }
                content.innerHTML = html;
            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æŠ¥è¡¨æŸ¥è¯¢å‡½æ•°
        function searchReports() {
            // è·å–æŸ¥è¯¢è¡¨å•ä¸­çš„å€¼
            const type = document.getElementById('reports-search-type').value;
            const templateId = document.getElementById('reports-search-template-id').value;
            const status = document.getElementById('reports-search-status').value;
            
            // æ„å»ºæŸ¥è¯¢å‚æ•°
            const searchParams = {};
            
            // è½¬æ¢å‰ç«¯å‘¨æœŸå€¼ä¸ºåç«¯æ•°æ®åº“å­˜å‚¨çš„å€¼
            const typeMap = {
                'daily': 'DAY',
                'weekly': 'WEEK',
                'monthly': 'MONTH',
                'quarterly': 'QUARTER',
                'yearly': 'YEAR'
            };
            
            if (type) {
                // è½¬æ¢ä¸ºåç«¯å¯¹åº”çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…çš„åˆ™ä½¿ç”¨åŸå§‹å€¼
                searchParams.type = typeMap[type] || type;
            }
            
            if (templateId) searchParams.template_id = templateId;
            if (status) searchParams.status = status;
            
            // è°ƒç”¨loadReportså‡½æ•°åŠ è½½è¿‡æ»¤åçš„æŠ¥è¡¨æ•°æ®
            loadReports(searchParams);
        }

        // é‡ç½®æŠ¥è¡¨æŸ¥è¯¢å‡½æ•°
        function resetReportsSearch() {
            // é‡ç½®æŸ¥è¯¢è¡¨å•ä¸­çš„æ‰€æœ‰å­—æ®µ
            document.getElementById('reports-search-type').value = '';
            document.getElementById('reports-search-template-id').value = '';
            document.getElementById('reports-search-status').value = '';
            
            // è°ƒç”¨loadReportså‡½æ•°åŠ è½½æ‰€æœ‰æŠ¥è¡¨æ•°æ®
            loadReports();
        }

        async function loadStatistics() {
            const content = document.getElementById('statistics-content');
            content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            try {
                const [faultsResult, alertsResult] = await Promise.all([
                    apiRequest('GET', '/api/statistics/device-faults'),
                    apiRequest('GET', '/api/statistics/region-alerts')
                ]);
                
                // ç»Ÿè®¡å¡ç‰‡
                let html = '<div class="stats-grid">';
                html += `<div class="stat-card"><h3>è®¾å¤‡æ•…éšœç»Ÿè®¡</h3><div class="value">${faultsResult.data ? faultsResult.data.length : 0}</div></div>`;
                html += `<div class="stat-card"><h3>åŒºåŸŸé¢„è­¦ç»Ÿè®¡</h3><div class="value">${alertsResult.data ? alertsResult.data.length : 0}</div></div>`;
                html += '</div>';
                
                // å›¾è¡¨å®¹å™¨
                html += '<div style="margin-top: 30px;">';

                html += '</div>';
                
                // è®¾å¤‡æ•…éšœè¯¦æƒ…
                if (faultsResult.data && faultsResult.data.length > 0) {
                    html += '<h3>è®¾å¤‡æ•…éšœè¯¦æƒ…</h3><table><thead><tr><th>åŒºåŸŸ</th><th>è®¾å¤‡ID</th><th>è®¾å¤‡åç§°</th><th>æ•…éšœæ¬¡æ•°</th><th>ç»´æŠ¤æ¬¡æ•°</th></tr></thead><tbody>';
                    faultsResult.data.forEach(fault => {
                        html += `<tr>
                            <td>${fault.region_name || '-'}</td>
                            <td>${fault.device_id || '-'}</td>
                            <td>${fault.device_name || '-'}</td>
                            <td>${fault.fault_times || 0}</td>
                            <td>${fault.maintenance_count || 0}</td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                }
                
                // åŒºåŸŸé¢„è­¦è¯¦æƒ…
                if (alertsResult.data && alertsResult.data.length > 0) {
                    html += '<h3 style="margin-top: 30px;">åŒºåŸŸé¢„è­¦è¯¦æƒ…</h3><table><thead><tr><th>åŒºåŸŸ</th><th>ä¼ æ„Ÿå™¨æ•°é‡</th><th>é¢„è­¦æ¬¡æ•°</th><th>é€šçŸ¥å‘é€æ•°é‡</th></tr></thead><tbody>';
                    alertsResult.data.forEach(alert => {
                        html += `<tr>
                            <td>${alert.region_name || '-'}</td>
                            <td>${alert.sensors || 0}</td>
                            <td>${alert.alerts || 0}</td>
                            <td>${alert.notifications_sent || 0}</td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                }
                
                content.innerHTML = html;
            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½å®æ—¶ç›‘æµ‹æ•°æ®
        async function loadMonitoringData() {
            const content = document.getElementById('monitoring-content');
            const regionId = document.getElementById('monitoring-region').value;
            const metric = document.getElementById('monitoring-metric').value;

            console.log('å¼€å§‹åŠ è½½å®æ—¶ç›‘æµ‹æ•°æ®...');
            console.log('Token:', token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
            console.log('Tokenå€¼:', token);
            console.log('RegionId:', regionId);
            console.log('Metric:', metric);

            if (!token) {
                content.innerHTML = '<div class="alert alert-warning">è¯·å…ˆç™»å½•åå†æŸ¥çœ‹å®æ—¶ç›‘æµ‹æ•°æ®</div>';
                console.log('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•åŠ è½½æ•°æ®');
                return;
            }

            try {
                // è·å–ä¼ æ„Ÿå™¨åˆ—è¡¨
                let sensorsQuery = '';
                if (regionId) sensorsQuery = `?region_id=${regionId}`;

                console.log('è¯·æ±‚ä¼ æ„Ÿå™¨åˆ—è¡¨:', `/api/sensors${sensorsQuery}`);
                const sensorsResult = await apiRequest('GET', `/api/sensors${sensorsQuery}`);
                console.log('ä¼ æ„Ÿå™¨APIå“åº”:', sensorsResult);

                const sensors = sensorsResult.data || [];

                if (sensors.length === 0) {
                    content.innerHTML = '<div class="alert alert-info">æš‚æ— ä¼ æ„Ÿå™¨æ•°æ®</div>';
                    console.log('æ²¡æœ‰æ‰¾åˆ°ä¼ æ„Ÿå™¨æ•°æ®');
                    return;
                }

                console.log(`æ‰¾åˆ° ${sensors.length} ä¸ªä¼ æ„Ÿå™¨ï¼Œå¼€å§‹è·å–è¯»æ•°...`);

                // è·å–æœ€æ–°ç›‘æµ‹æ•°æ®
                const monitoringData = {};
                const promises = sensors.map(async (sensor) => {
                    try {
                        const sensorId = sensor.ID || sensor.id;
                        console.log(`è·å–ä¼ æ„Ÿå™¨ ${sensorId} çš„è¯»æ•°...`);

                        // è·å–è¯¥ä¼ æ„Ÿå™¨çš„æœ€æ–°å‡ æ¡è¯»æ•°ï¼ˆä¸åŒç±»å‹çš„æ•°æ®ï¼‰
                        const readingsResult = await apiRequest('GET', `/api/sensors/${sensorId}/readings?limit=10`);
                        console.log(`ä¼ æ„Ÿå™¨ ${sensorId} è¯»æ•°å“åº”:`, readingsResult);

                        const readings = readingsResult.data || [];

                        if (readings.length > 0) {
                            const sensorData = {};
                            let latestTime = null;

                            console.log(`ä¼ æ„Ÿå™¨ ${sensorId} æœ‰ ${readings.length} æ¡è¯»æ•°`);

                            // å¤„ç†æ‰€æœ‰è¯»æ•°ï¼ŒæŒ‰ç±»å‹åˆ†ç»„å–æœ€æ–°å€¼
                            readings.forEach(reading => {
                                const readingTime = new Date(reading.collected_at || reading.created_at);
                                if (!latestTime || readingTime > latestTime) {
                                    latestTime = readingTime;
                                }

                                // æ ¹æ®è¯»æ•°ç±»å‹å­˜å‚¨æ•°æ®
                                const readingType = reading.reading_type || reading.ReadingType;
                                const value = reading.numeric_value || reading.NumericValue || reading.Numeric;

                                console.log(`è¯»æ•°ç±»å‹: ${readingType}, å€¼: ${value}`);

                                if (value !== null && value !== undefined) {
                                    switch(readingType) {
                                        case 'TEMPERATURE':
                                            sensorData.temperature = value;
                                            break;
                                        case 'HUMIDITY':
                                            sensorData.humidity = value;
                                            break;
                                    }
                                }
                            });

                            monitoringData[sensorId] = {
                                sensor: sensor,
                                data: sensorData,
                                lastUpdate: latestTime
                            };

                            console.log(`ä¼ æ„Ÿå™¨ ${sensorId} å¤„ç†ç»“æœ:`, sensorData);
                        } else {
                            console.log(`ä¼ æ„Ÿå™¨ ${sensorId} æ²¡æœ‰è¯»æ•°æ•°æ®`);
                        }
                    } catch (error) {
                        console.warn(`è·å–ä¼ æ„Ÿå™¨ ${sensor.ID || sensor.id} æ•°æ®å¤±è´¥:`, error);
                    }
                });

                await Promise.all(promises);

                console.log('æ‰€æœ‰ä¼ æ„Ÿå™¨æ•°æ®è·å–å®Œæˆ:', monitoringData);

                // æ›´æ–°ç•Œé¢
                updateMonitoringDisplay(monitoringData, metric);

            } catch (error) {
                console.error('åŠ è½½å®æ—¶ç›‘æµ‹æ•°æ®å¤±è´¥:', error);
                showAlert('monitoring', 'åŠ è½½å®æ—¶ç›‘æµ‹æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°å®æ—¶ç›‘æµ‹æ˜¾ç¤º
        function updateMonitoringDisplay(monitoringData, filterMetric) {
            console.log('å¼€å§‹æ›´æ–°æ˜¾ç¤ºç•Œé¢ï¼Œç­›é€‰æŒ‡æ ‡:', filterMetric);
            console.log('ç›‘æ§æ•°æ®:', monitoringData);

            const cards = document.querySelectorAll('.monitoring-card');

            // è®¡ç®—å„æŒ‡æ ‡çš„æœ€æ–°å€¼
            const latestData = {
                temperature: { value: '--', time: '--', unit: 'Â°C' },
                humidity: { value: '--', time: '--', unit: '%' }
            };

            let latestTime = null;
            Object.values(monitoringData).forEach(item => {
                console.log('å¤„ç†ä¼ æ„Ÿå™¨æ•°æ®:', item);
                if (item.data && item.lastUpdate) {
                    if (!latestTime || item.lastUpdate > latestTime) {
                        latestTime = item.lastUpdate;
                    }

                    // æ›´æ–°å„æŒ‡æ ‡æ•°æ®ï¼Œåªåœ¨æœ‰æ•°æ®æ—¶æ‰æ›´æ–°
                    if (item.data.temperature !== undefined && item.data.temperature !== null) {
                        console.log('æ›´æ–°æ¸©åº¦æ•°æ®:', item.data.temperature);
                        if (latestData.temperature.value === '--' ||
                            item.lastUpdate > new Date(latestData.temperature.time !== '--' ? latestData.temperature.time : '2000-01-01')) {
                            latestData.temperature = {
                                value: item.data.temperature,
                                time: item.lastUpdate.toLocaleString(),
                                unit: 'Â°C'
                            };
                        }
                    }
                    if (item.data.humidity !== undefined && item.data.humidity !== null) {
                        console.log('æ›´æ–°æ¹¿åº¦æ•°æ®:', item.data.humidity);
                        if (latestData.humidity.value === '--' ||
                            item.lastUpdate > new Date(latestData.humidity.time !== '--' ? latestData.humidity.time : '2000-01-01')) {
                            latestData.humidity = {
                                value: item.data.humidity,
                                time: item.lastUpdate.toLocaleString(),
                                unit: '%'
                            };
                        }
                    }
                }
            });

            console.log('æœ€ç»ˆæ•°æ®:', latestData);

            // æ›´æ–°å¡ç‰‡æ˜¾ç¤º
            const metrics = ['temperature', 'humidity'];
            metrics.forEach((metric, index) => {
                if (!filterMetric || filterMetric === '' || filterMetric === metric) {
                    const card = cards[index];
                    if (card) { // æ£€æŸ¥cardæ˜¯å¦å­˜åœ¨
                        const valueElement = card.querySelector('.metric-value');
                        const timeElement = card.querySelector('.metric-time');

                        const data = latestData[metric];
                        console.log(`æ›´æ–°å¡ç‰‡ ${index} (${metric}):`, data);
                        valueElement.textContent = data.value + data.unit;
                        timeElement.textContent = 'æœ€åæ›´æ–°: ' + data.time;
                    }
                }
            });

            // ç¡®ä¿åªæœ‰å‰ä¸¤ä¸ªå¡ç‰‡å¯è§
            cards.forEach((card, index) => {
                if (index < 2) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });

            console.log('ç•Œé¢æ›´æ–°å®Œæˆ');
        }


        // åˆ é™¤å‡½æ•°
        async function deleteRegion(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåŒºåŸŸå—ï¼Ÿ')) return;
            try {
                await apiRequest('DELETE', `/api/regions/${id}`);
                showAlert('åˆ é™¤æˆåŠŸï¼', 'success');
                loadRegions();
            } catch (error) {
                showAlert(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function deleteSensor(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼ æ„Ÿå™¨å—ï¼Ÿ')) return;
            try {
                await apiRequest('DELETE', `/api/sensors/${id}`);
                showAlert('åˆ é™¤æˆåŠŸï¼', 'success');
                loadSensors();
            } catch (error) {
                showAlert(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function deleteAlertRule(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢„è­¦è§„åˆ™å—ï¼Ÿ')) return;
            try {
                await apiRequest('DELETE', `/api/alert-rules/${id}`);
                showAlert('åˆ é™¤æˆåŠŸï¼', 'success');
                loadAlerts();
            } catch (error) {
                showAlert(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function deleteAlert(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢„è­¦å—ï¼Ÿ')) return;
            try {
                await apiRequest('DELETE', `/api/alerts/${id}`);
                showAlert('åˆ é™¤æˆåŠŸï¼', 'success');
                loadAlerts();
            } catch (error) {
                showAlert(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function deleteResource(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèµ„æºå—ï¼Ÿ')) return;
            try {
                await apiRequest('DELETE', `/api/resources/${id}`);
                showAlert('åˆ é™¤æˆåŠŸï¼', 'success');
                loadResources();
            } catch (error) {
                showAlert(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function deleteDevice(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¾å¤‡å—ï¼Ÿ')) return;
            try {
                await apiRequest('DELETE', `/api/devices/${id}`);
                showAlert('åˆ é™¤æˆåŠŸï¼', 'success');
                loadDevices();
            } catch (error) {
                showAlert(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function deleteReportTemplate(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŠ¥è¡¨æ¨¡æ¿å—ï¼Ÿ')) return;
            try {
                await apiRequest('DELETE', `/api/report-templates/${id}`);
                showAlert('åˆ é™¤æˆåŠŸï¼', 'success');
                loadReports();
            } catch (error) {
                showAlert(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function deleteReport(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŠ¥è¡¨å—ï¼Ÿ')) return;
            try {
                await apiRequest('DELETE', `/api/reports/${id}`);
                showAlert('åˆ é™¤æˆåŠŸï¼', 'success');
                loadReports();
            } catch (error) {
                showAlert(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æŸ¥çœ‹æŠ¥è¡¨æ¨¡æ¿è¯¦æƒ…
        async function viewReportTemplate(id) {
            try {
                const result = await apiRequest('GET', `/api/report-templates/${id}`);
                const template = result.data || result;
                const modal = document.getElementById('modal');
                const title = document.getElementById('modal-title');
                const body = document.getElementById('modal-body');
                
                title.textContent = 'æŸ¥çœ‹æŠ¥è¡¨æ¨¡æ¿';
                body.innerHTML = `
                    <div class="form-group">
                        <label>æ¨¡æ¿ID</label>
                        <input type="text" value="${template.ID || template.id}" readonly style="background: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label>åç§°</label>
                        <input type="text" value="${template.Name || template.name || '-'}" readonly style="background: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label>ç»´åº¦</label>
                        <input type="text" value="${template.Dimension || template.dimension || '-'}" readonly style="background: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label>æŒ‡æ ‡</label>
                        <textarea readonly style="background: #f5f5f5;">${template.Metrics || template.metrics || '-'}</textarea>
                    </div>
                    <div class="form-group">
                        <label>å‘¨æœŸ</label>
                        <input type="text" value="${template.Cycle || template.cycle || '-'}" readonly style="background: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label>çŠ¶æ€</label>
                        <input type="text" value="${template.IsActive || template.is_active ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'}" readonly style="background: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label>åˆ›å»ºæ—¶é—´</label>
                        <input type="text" value="${template.CreatedAt || template.created_at || '-'}" readonly style="background: #f5f5f5;">
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="closeModal()">å…³é—­</button>
                    </div>
                `;
                modal.style.display = 'block';
            } catch (error) {
                showAlert(`è·å–æ¨¡æ¿è¯¦æƒ…å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æŸ¥çœ‹æŠ¥è¡¨è¯¦æƒ…
        async function viewReport(id) {
            try {
                const result = await apiRequest('GET', `/api/reports/${id}`);
                const report = result.data || result;
                const modal = document.getElementById('modal');
                const title = document.getElementById('modal-title');
                const body = document.getElementById('modal-body');
                
                title.textContent = 'æŸ¥çœ‹æŠ¥è¡¨';
                body.innerHTML = `
                    <div class="form-group">
                        <label>æŠ¥è¡¨ID</label>
                        <input type="text" value="${report.ID || report.id || '-'}" readonly style="background: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label>æ¨¡æ¿ID</label>
                        <input type="text" value="${report.TemplateID || report.template_id || '-'}" readonly style="background: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label>å‘¨æœŸ</label>
                        <input type="text" value="${report.Period || report.period || '-'}" readonly style="background: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label>ç”Ÿæˆæ—¶é—´</label>
                        <input type="text" value="${report.GeneratedAt || report.generated_at || '-'}" readonly style="background: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label>æ–‡ä»¶è·¯å¾„</label>
                        <input type="text" value="${report.FilePath || report.file_path || '-'}" readonly style="background: #f5f5f5;">
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="closeModal()">å…³é—­</button>
                    </div>
                `;
                modal.style.display = 'block';
            } catch (error) {
                showAlert(`è·å–æŠ¥è¡¨è¯¦æƒ…å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function exportReport(id, format) {
            try {
                // ä½¿ç”¨apiRequestè·å–æ–‡ä»¶URLæˆ–æ•°æ®ï¼Œç¡®ä¿æºå¸¦ä»¤ç‰Œ
                const response = await fetch(`${API_BASE}/api/reports/${id}/export?format=${format}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : '',
                    }
                });

                if (!response.ok) {
                    throw new Error('å¯¼å‡ºå¤±è´¥: ' + response.statusText);
                }

                // åˆ›å»ºä¸´æ—¶ä¸‹è½½é“¾æ¥
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report_${id}_${format}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                showAlert('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç¼–è¾‘å‡½æ•°ï¼šå…ˆè·å–æ•°æ®ï¼Œç„¶åæ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        async function editRegion(id) {
            try {
                const result = await apiRequest('GET', `/api/regions/${id}`);
                const region = result.data || result;
                currentEditId = id;
                openEditModal('region', region);
            } catch (error) {
                showAlert(`è·å–æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function editSensor(id) {
            try {
                const result = await apiRequest('GET', `/api/sensors/${id}`);
                if (result.data) {
                    const sensor = result.data;
                    currentEditId = id;
                    openEditModal('sensor', sensor);
                }
            } catch (error) {
                showAlert('è·å–æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function editResource(id) {
            try {
                const result = await apiRequest('GET', `/api/resources/${id}`);
                if (result.data) {
                    const resource = result.data;
                    currentEditId = id;
                    openEditModal('resource', resource);
                }
            } catch (error) {
                showAlert('è·å–æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function editDevice(id) {
            try {
                const result = await apiRequest('GET', `/api/devices/${id}`);
                if (result.data) {
                    const device = result.data;
                    currentEditId = id;
                    openEditModal('device', device);
                }
            } catch (error) {
                showAlert('è·å–æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†å¹¶å¡«å……æ•°æ®
        function openEditModal(type, data) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            
            switch(type) {
                case 'region':
                    title.textContent = 'ç¼–è¾‘åŒºåŸŸ';
                    body.innerHTML = getRegionForm(data);
                    break;
                case 'sensor':
                    title.textContent = 'ç¼–è¾‘ä¼ æ„Ÿå™¨';
                    body.innerHTML = getSensorForm(data);
                    break;
                case 'resource':
                    title.textContent = 'ç¼–è¾‘èµ„æº';
                    body.innerHTML = getResourceForm(data);
                    break;
                case 'device':
                    title.textContent = 'ç¼–è¾‘è®¾å¤‡';
                    body.innerHTML = getDeviceForm(data);
                    break;
            }
            modal.style.display = 'block';
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            loadRegions();
        };

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target == modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>
